{
  "openapi": "3.1.0",
  "info": {
    "title": "Arke v1 API",
    "version": "1.0.0",
    "description": "Entity management API with content-addressed versioning and permissions."
  },
  "servers": [
    {
      "url": "https://api.arke.institute",
      "description": "Production"
    }
  ],
  "tags": [
    {
      "name": "Auth",
      "description": "Authentication and registration"
    },
    {
      "name": "Users",
      "description": "User profile management"
    },
    {
      "name": "Entities",
      "description": "Entity CRUD operations for all types (files, folders, etc.)"
    },
    {
      "name": "Collections",
      "description": "Collection and permission management"
    },
    {
      "name": "Permissions",
      "description": "Permission system metadata and introspection"
    },
    {
      "name": "Search",
      "description": "Cross-collection semantic search"
    },
    {
      "name": "Query",
      "description": "Argo DSL query engine combining semantic search and graph traversal"
    },
    {
      "name": "Graph",
      "description": "Graph traversal and path-finding"
    },
    {
      "name": "Kladoi",
      "description": "Workflow action units - atomic operations with defined inputs/outputs"
    },
    {
      "name": "Rhizai",
      "description": "Workflow orchestration - DAGs of kladoi for multi-step pipelines"
    },
    {
      "name": "Events",
      "description": "Entity change event stream"
    },
    {
      "name": "API Keys",
      "description": "User and agent API key management"
    },
    {
      "name": "Documentation",
      "description": "API documentation and introspection"
    },
    {
      "name": "Alpha",
      "description": "Alpha invite management (admin only)"
    }
  ],
  "x-tagGroups": [
    {
      "name": "Core",
      "tags": [
        "Auth",
        "Users",
        "Entities",
        "Collections",
        "Permissions"
      ]
    },
    {
      "name": "Discovery",
      "tags": [
        "Search",
        "Query",
        "Graph"
      ]
    },
    {
      "name": "Automation",
      "tags": [
        "Kladoi",
        "Rhizai"
      ]
    },
    {
      "name": "System",
      "tags": [
        "Events",
        "API Keys",
        "Documentation"
      ]
    },
    {
      "name": "Admin",
      "tags": [
        "Alpha"
      ]
    }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Supabase JWT token. Use `Authorization: Bearer <jwt>`. Only for JWT tokens from Supabase auth - do NOT use Bearer with API keys."
      },
      "apiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "Authorization",
        "description": "API Key authentication. **Important:** Use `Authorization: ApiKey <key>` (NOT Bearer). Format: `ApiKey uk_xxx` (user keys) or `ApiKey ak_xxx` (agent keys). Using Bearer with API keys will fail."
      }
    },
    "parameters": {
      "X-Arke-Network": {
        "name": "X-Arke-Network",
        "in": "header",
        "required": false,
        "schema": {
          "type": "string",
          "enum": [
            "main",
            "test"
          ],
          "default": "main"
        },
        "description": "Target network. Use `test` for isolated test data with II-prefixed IDs."
      },
      "X-On-Behalf-Of": {
        "name": "X-On-Behalf-Of",
        "in": "header",
        "required": false,
        "schema": {
          "type": "string"
        },
        "description": "User entity ID for service accounts acting on behalf of a user. Only valid with `role: service` authentication."
      }
    },
    "schemas": {
      "RegisterUser": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "example": "01J1SHMAE10000000000000000"
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "example": {
              "label": "Ishmael",
              "name": "Ishmael"
            }
          },
          "ver": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Entity version number",
            "example": 1
          }
        },
        "required": [
          "id",
          "cid",
          "properties",
          "ver"
        ]
      },
      "RegisterResponse": {
        "type": "object",
        "properties": {
          "created": {
            "type": "boolean",
            "description": "True if user was created, false if already registered",
            "example": true
          },
          "user": {
            "$ref": "#/components/schemas/RegisterUser"
          }
        },
        "required": [
          "created",
          "user"
        ]
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "description": "Error message",
            "example": "Not found"
          },
          "details": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Additional error details"
          }
        },
        "required": [
          "error"
        ]
      },
      "WhoamiUserResponse": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "enum": [
              "user"
            ],
            "description": "Identity type"
          },
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "User entity ID",
            "example": "01J1SHMAE10000000000000000"
          },
          "auth_method": {
            "type": "string",
            "enum": [
              "jwt",
              "api_key"
            ],
            "description": "How this identity was authenticated",
            "example": "jwt"
          },
          "email": {
            "type": "string",
            "format": "email",
            "description": "User email (JWT auth only)",
            "example": "ishmael@pequod.ship"
          },
          "name": {
            "type": "string",
            "description": "Display name (JWT auth only)",
            "example": "Ishmael"
          },
          "supabase_user_id": {
            "type": "string",
            "format": "uuid",
            "description": "Supabase Auth user ID (JWT auth only)"
          },
          "key_prefix": {
            "type": "string",
            "description": "API key prefix (API key auth only)",
            "example": "uk_abc1"
          },
          "key_expires_at": {
            "type": "string",
            "format": "date-time",
            "description": "API key expiration (API key auth only)"
          }
        },
        "required": [
          "type",
          "id",
          "auth_method"
        ]
      },
      "WhoamiAgentResponse": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "enum": [
              "agent"
            ],
            "description": "Identity type"
          },
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Agent entity ID",
            "example": "01J1AGENTID000000000000000"
          },
          "auth_method": {
            "type": "string",
            "enum": [
              "api_key"
            ],
            "description": "How this identity was authenticated",
            "example": "api_key"
          },
          "owner_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID of the agent owner",
            "example": "01J1OWNERID0000000000000000"
          },
          "key_prefix": {
            "type": "string",
            "description": "API key prefix",
            "example": "ak_xyz9"
          },
          "key_expires_at": {
            "type": "string",
            "format": "date-time",
            "description": "API key expiration"
          }
        },
        "required": [
          "type",
          "id",
          "auth_method",
          "owner_id",
          "key_prefix",
          "key_expires_at"
        ]
      },
      "WhoamiResponse": {
        "anyOf": [
          {
            "$ref": "#/components/schemas/WhoamiUserResponse"
          },
          {
            "$ref": "#/components/schemas/WhoamiAgentResponse"
          }
        ]
      },
      "AlphaInvite": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "example": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
          },
          "email": {
            "type": "string",
            "format": "email",
            "example": "ishmael@pequod.ship"
          },
          "invited_by": {
            "type": "string",
            "example": "admin"
          },
          "status": {
            "type": "string",
            "enum": [
              "pending",
              "accepted",
              "revoked",
              "waitlisted"
            ],
            "example": "pending"
          },
          "created_at": {
            "type": "string",
            "example": "2026-01-28T12:00:00.000Z"
          },
          "accepted_at": {
            "type": "string",
            "nullable": true,
            "example": null
          }
        },
        "required": [
          "id",
          "email",
          "invited_by",
          "status",
          "created_at",
          "accepted_at"
        ]
      },
      "CreateAlphaInviteResponse": {
        "type": "object",
        "properties": {
          "invite": {
            "$ref": "#/components/schemas/AlphaInvite"
          }
        },
        "required": [
          "invite"
        ]
      },
      "CreateAlphaInviteRequest": {
        "type": "object",
        "properties": {
          "email": {
            "type": "string",
            "format": "email",
            "description": "Email address to invite",
            "example": "ishmael@pequod.ship"
          },
          "invited_by": {
            "type": "string",
            "description": "Who is sending the invite (defaults to \"admin\")",
            "example": "admin"
          }
        },
        "required": [
          "email"
        ]
      },
      "ListAlphaInvitesResponse": {
        "type": "object",
        "properties": {
          "invites": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/AlphaInvite"
            }
          },
          "count": {
            "type": "integer",
            "example": 5
          }
        },
        "required": [
          "invites",
          "count"
        ]
      },
      "EntityResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "type": {
            "type": "string",
            "example": "collection"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "example": {
              "label": "The Pequod's Archive",
              "description": "A collection of whaling documents"
            }
          },
          "relationships": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1
                },
                "peer": {
                  "type": "string",
                  "minLength": 1
                },
                "peer_type": {
                  "type": "string"
                },
                "peer_label": {
                  "type": "string"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  }
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Entity relationship",
              "example": {
                "predicate": "crew",
                "peer": "01KDETYWYWM0MJVKM8DK3AEXPY",
                "peer_type": "collection"
              }
            }
          },
          "ver": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Entity version number",
            "example": 1
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 datetime",
            "example": "2025-12-26T12:00:00.000Z"
          },
          "ts": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Unix timestamp in milliseconds",
            "example": 1735214400000
          },
          "edited_by": {
            "type": "object",
            "properties": {
              "user_id": {
                "type": "string",
                "minLength": 1
              },
              "user_label": {
                "type": "string",
                "description": "Display name of the user/agent (populated during expansion)",
                "example": "Captain Ahab"
              },
              "method": {
                "type": "string",
                "enum": [
                  "manual",
                  "ai_generated",
                  "system",
                  "import"
                ]
              },
              "on_behalf_of": {
                "type": "string"
              },
              "on_behalf_of_label": {
                "type": "string",
                "description": "Display name of the on_behalf_of user/agent (populated during expansion)",
                "example": "Research Assistant"
              }
            },
            "required": [
              "user_id",
              "method"
            ],
            "description": "Audit trail for edits. Label fields are populated when ?expand=relationships is used.",
            "example": {
              "user_id": "01JCAPTAINAHAB000000000000",
              "user_label": "Captain Ahab",
              "method": "manual"
            }
          },
          "prev_cid": {
            "type": "string",
            "minLength": 1,
            "description": "Previous version CID (present on updates)",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          }
        },
        "required": [
          "id",
          "cid",
          "type",
          "properties",
          "relationships",
          "ver",
          "created_at",
          "ts",
          "edited_by"
        ]
      },
      "UserResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/EntityResponse"
          },
          {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": [
                  "user"
                ]
              }
            }
          }
        ]
      },
      "CreateApiKeyResponse": {
        "type": "object",
        "properties": {
          "key": {
            "type": "string",
            "description": "Full API key - store this securely, it will not be shown again",
            "example": "uk_xKj92mNpQrStUvWxYz1234567890abcdef1234567890abcdef12345678"
          },
          "key_prefix": {
            "type": "string",
            "description": "Key prefix for identification",
            "example": "uk_xKj9"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the key expires",
            "example": "2026-03-28T00:00:00.000Z"
          }
        },
        "required": [
          "key",
          "key_prefix",
          "expires_at"
        ]
      },
      "CreateApiKeyRequest": {
        "type": "object",
        "properties": {
          "label": {
            "type": "string",
            "maxLength": 100,
            "description": "Human-readable label for the key",
            "example": "Production"
          },
          "expires_in": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "maximum": 31536000,
            "description": "Time until expiration in seconds (default: 90 days, max: 365 days)",
            "example": 7776000
          }
        }
      },
      "ApiKeyInfo": {
        "type": "object",
        "properties": {
          "key_prefix": {
            "type": "string",
            "description": "Key prefix for identification",
            "example": "uk_xKj9"
          },
          "label": {
            "type": "string",
            "nullable": true,
            "description": "Human-readable label",
            "example": "Production"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the key was created",
            "example": "2025-12-28T00:00:00.000Z"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the key expires",
            "example": "2026-03-28T00:00:00.000Z"
          },
          "last_used_at": {
            "type": "string",
            "nullable": true,
            "format": "date-time",
            "description": "When the key was last used (null if never used)",
            "example": "2025-12-28T10:30:00.000Z"
          }
        },
        "required": [
          "key_prefix",
          "label",
          "created_at",
          "expires_at",
          "last_used_at"
        ]
      },
      "ListApiKeysResponse": {
        "type": "object",
        "properties": {
          "keys": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ApiKeyInfo"
            },
            "description": "List of API keys"
          }
        },
        "required": [
          "keys"
        ]
      },
      "UserCollectionItem": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Collection ID",
            "example": "01JCOLLECTION123456789AB"
          },
          "label": {
            "type": "string",
            "description": "Collection label/name",
            "example": "My Research Collection"
          },
          "predicate": {
            "type": "string",
            "description": "Role predicate indicating user's relationship to collection",
            "example": "owner"
          },
          "created_at": {
            "type": "string",
            "description": "When the collection was created",
            "example": "2026-01-12T00:00:00.000Z"
          }
        },
        "required": [
          "id",
          "label",
          "predicate",
          "created_at"
        ]
      },
      "UserCollectionsResponse": {
        "type": "object",
        "properties": {
          "user_id": {
            "type": "string",
            "description": "User persistent identifier",
            "example": "01JUSER123456789ABCDEFGH"
          },
          "collections": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/UserCollectionItem"
            },
            "description": "Collections the user has access to"
          },
          "pagination": {
            "type": "object",
            "properties": {
              "offset": {
                "type": "number",
                "description": "Current offset"
              },
              "limit": {
                "type": "number",
                "description": "Results per page"
              },
              "count": {
                "type": "number",
                "description": "Number of results returned"
              },
              "has_more": {
                "type": "boolean",
                "description": "Whether more results exist"
              }
            },
            "required": [
              "offset",
              "limit",
              "count",
              "has_more"
            ],
            "description": "Pagination metadata"
          }
        },
        "required": [
          "user_id",
          "collections",
          "pagination"
        ]
      },
      "EntityPreview": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Entity ID (persistent identifier)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "type": {
            "type": "string",
            "description": "Entity type",
            "example": "document"
          },
          "label": {
            "type": "string",
            "description": "Entity label (from properties.label, filename, or name)",
            "example": "Research Paper.pdf"
          },
          "collection_id": {
            "type": "string",
            "description": "Collection ID this entity belongs to",
            "example": "01JCOLLECTION123456789ABCD"
          },
          "description_preview": {
            "type": "string",
            "description": "Truncated description (max 200 chars + \"...\")",
            "example": "This document contains research findings from the 2025 study on entity management systems. It covers key architectural decisions and performance benchmarks..."
          },
          "text_preview": {
            "type": "string",
            "description": "Truncated text content (max 200 chars + \"...\")",
            "example": "Introduction: The rise of decentralized entity management systems has created new challenges for data integrity and consistency. This paper explores..."
          },
          "created_at": {
            "type": "string",
            "description": "Entity creation timestamp (ISO 8601)",
            "example": "2025-01-15T10:00:00.000Z"
          },
          "updated_at": {
            "type": "string",
            "description": "Last update timestamp (ISO 8601)",
            "example": "2025-01-20T14:30:00.000Z"
          }
        },
        "required": [
          "id",
          "type",
          "label",
          "created_at",
          "updated_at"
        ],
        "description": "Lightweight entity preview with fresh data. Included by default (expand: \"preview\").",
        "example": {
          "id": "01KDETYWYWM0MJVKM8DK3AEXPY",
          "type": "file",
          "label": "Research Paper.pdf",
          "collection_id": "01JCOLLECTION123456789AB",
          "description_preview": "A comprehensive study on distributed systems architecture...",
          "created_at": "2026-01-12T00:00:00.000Z",
          "updated_at": "2026-01-12T10:30:00.000Z"
        }
      },
      "SearchResultItem": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "type": {
            "type": "string",
            "description": "Entity type",
            "example": "file"
          },
          "label": {
            "type": "string",
            "description": "Entity label/name",
            "example": "Research Paper.pdf"
          },
          "collection_id": {
            "type": "string",
            "nullable": true,
            "description": "Collection this entity belongs to (null for public-domain)",
            "example": "01JCOLLECTION123456789AB"
          },
          "score": {
            "type": "number",
            "description": "Relevance score (0-1, higher is better)",
            "example": 0.87
          },
          "created_at": {
            "type": "string",
            "description": "When the entity was created",
            "example": "2026-01-12T00:00:00.000Z"
          },
          "updated_at": {
            "type": "string",
            "description": "When the entity was last updated",
            "example": "2026-01-12T10:30:00.000Z"
          },
          "entity_preview": {
            "$ref": "#/components/schemas/EntityPreview"
          },
          "entity": {
            "allOf": [
              {
                "$ref": "#/components/schemas/EntityResponse"
              },
              {
                "description": "Complete entity manifest with all properties and relationships. Only included when expand: \"full\"."
              }
            ]
          }
        },
        "required": [
          "id",
          "type",
          "label",
          "collection_id",
          "score"
        ]
      },
      "SearchMetadata": {
        "type": "object",
        "properties": {
          "query": {
            "type": "string",
            "description": "Original search query"
          },
          "collections_queried": {
            "type": "integer",
            "description": "Number of collections searched"
          },
          "collections_total": {
            "type": "integer",
            "description": "Total collections user has access to"
          },
          "include_public": {
            "type": "boolean",
            "description": "Whether public-domain was included"
          },
          "execution_time_ms": {
            "type": "number",
            "description": "Total execution time in milliseconds"
          },
          "result_count": {
            "type": "integer",
            "description": "Number of results returned"
          }
        },
        "required": [
          "query",
          "collections_queried",
          "collections_total",
          "include_public",
          "execution_time_ms",
          "result_count"
        ],
        "description": "Search metadata and statistics"
      },
      "CrossCollectionSearchResponse": {
        "type": "object",
        "properties": {
          "results": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/SearchResultItem"
            },
            "description": "Search results ranked by relevance"
          },
          "metadata": {
            "$ref": "#/components/schemas/SearchMetadata"
          }
        },
        "required": [
          "results",
          "metadata"
        ]
      },
      "ValidationErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "example": "Validation failed"
          },
          "details": {
            "type": "object",
            "properties": {
              "issues": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "path": {
                      "type": "array",
                      "items": {
                        "anyOf": [
                          {
                            "type": "string"
                          },
                          {
                            "type": "number"
                          }
                        ]
                      }
                    },
                    "message": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "path",
                    "message"
                  ]
                }
              }
            },
            "required": [
              "issues"
            ]
          }
        },
        "required": [
          "error"
        ]
      },
      "CrossCollectionSearchRequest": {
        "type": "object",
        "properties": {
          "query": {
            "type": "string",
            "minLength": 1,
            "maxLength": 10000,
            "description": "Search query text for semantic matching",
            "example": "medical research"
          },
          "type": {
            "type": "string",
            "description": "Filter results to specific entity type",
            "example": "file"
          },
          "role": {
            "type": "string",
            "enum": [
              "owner",
              "editor",
              "viewer"
            ],
            "description": "Filter collections by user role (only search collections where user has this role)",
            "example": "owner"
          },
          "include_public": {
            "type": "boolean",
            "default": false,
            "description": "Include results from public-domain namespace (default: false)",
            "example": false
          },
          "limit": {
            "type": "integer",
            "minimum": 1,
            "maximum": 100,
            "default": 20,
            "description": "Maximum number of results to return (default: 20, max: 100)",
            "example": 50
          },
          "expand": {
            "type": "string",
            "enum": [
              "preview",
              "full",
              "none"
            ],
            "description": "Entity expansion mode. Default: \"preview\" for lightweight previews, \"full\" for complete manifests, \"none\" for no expansion.",
            "example": "preview"
          }
        },
        "required": [
          "query"
        ]
      },
      "CollectionResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/EntityResponse"
          },
          {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": [
                  "collection"
                ]
              }
            }
          }
        ]
      },
      "CreateCollectionRequest": {
        "type": "object",
        "properties": {
          "note": {
            "type": "string",
            "description": "Optional note describing this change",
            "example": "Added Chapter 42: The Whiteness of the Whale"
          },
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Custom entity ID (generated if not provided)"
          },
          "label": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200,
            "description": "Collection display name",
            "example": "The Pequod's Archive"
          },
          "description": {
            "type": "string",
            "maxLength": 2000,
            "description": "Collection description",
            "example": "Documents and manuscripts related to the voyage of the Pequod"
          },
          "display_image_url": {
            "type": "string",
            "format": "uri",
            "description": "URL for collection display image"
          },
          "use_roles_default": {
            "type": "boolean",
            "nullable": true,
            "default": true,
            "description": "Whether to merge with default roles (true) or use only provided roles (false). Public role with *:view is always ensured."
          },
          "roles": {
            "type": "object",
            "additionalProperties": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "description": "Role definitions. When use_roles_default is true (default), these merge with defaults. When false, these replace defaults entirely.",
            "example": {
              "public": [
                "*:view",
                "*:invoke"
              ]
            }
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Additional properties to store"
          },
          "relationships": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1
                },
                "peer": {
                  "type": "string",
                  "minLength": 1
                },
                "peer_type": {
                  "type": "string"
                },
                "peer_label": {
                  "type": "string"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  }
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Entity relationship",
              "example": {
                "predicate": "crew",
                "peer": "01KDETYWYWM0MJVKM8DK3AEXPY",
                "peer_type": "collection"
              }
            },
            "description": "Initial relationships"
          }
        },
        "required": [
          "label"
        ]
      },
      "CollectionUpdateResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/CollectionResponse"
          },
          {
            "type": "object",
            "properties": {
              "prev_cid": {
                "type": "string",
                "minLength": 1,
                "description": "Previous version CID",
                "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
              }
            },
            "required": [
              "prev_cid"
            ]
          }
        ]
      },
      "CASErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "enum": [
              "Conflict: entity was modified"
            ]
          },
          "details": {
            "type": "object",
            "properties": {
              "expected": {
                "type": "string",
                "description": "Expected tip CID"
              },
              "actual": {
                "type": "string",
                "description": "Actual current tip CID"
              }
            },
            "required": [
              "expected",
              "actual"
            ]
          }
        },
        "required": [
          "error",
          "details"
        ]
      },
      "UpdateCollectionRequest": {
        "type": "object",
        "properties": {
          "expect_tip": {
            "type": "string",
            "minLength": 1,
            "description": "Current tip CID for CAS validation. Request fails with 409 if this does not match.",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "note": {
            "type": "string",
            "description": "Optional note describing this change",
            "example": "Added Chapter 42: The Whiteness of the Whale"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Properties to add or update (deep merged)"
          },
          "properties_remove": {
            "anyOf": [
              {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Top-level property keys to remove",
                "example": [
                  "deprecated_field",
                  "old_field"
                ]
              },
              {
                "type": "object",
                "additionalProperties": {
                  "nullable": true
                },
                "description": "Nested removal structure. Each key navigates into a nested object; leaf arrays specify keys to delete at that level.",
                "example": {
                  "settings": {
                    "notifications": [
                      "email",
                      "slack"
                    ]
                  }
                }
              }
            ],
            "description": "Properties to remove. Use string[] for top-level keys (e.g., [\"old_field\"]), or nested objects for deep removal (e.g., { config: { options: [\"debug\"] } }). Dot notation like \"config.options.debug\" is NOT supported."
          },
          "relationships_add": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Relationship predicate (e.g., \"admin\", \"contains\", \"collection\")",
                  "example": "admin"
                },
                "peer": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Target entity ID",
                  "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
                },
                "peer_type": {
                  "type": "string",
                  "description": "Target entity type hint",
                  "example": "user"
                },
                "peer_label": {
                  "type": "string",
                  "description": "Target entity label hint",
                  "example": "Captain Ahab"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  },
                  "description": "Properties to add/update on this relationship (deep merged if relationship exists)",
                  "example": {
                    "expires_at": "2025-12-31T00:00:00Z"
                  }
                },
                "properties_remove": {
                  "anyOf": [
                    {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    {
                      "type": "object",
                      "additionalProperties": {
                        "nullable": true
                      }
                    }
                  ],
                  "description": "Properties to remove from this relationship (string array or nested object)"
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Relationship to add or update (upsert semantics)"
            },
            "description": "Relationships to add or update (upsert semantics)"
          },
          "relationships_remove": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Relationship predicate",
                  "example": "viewer"
                },
                "peer": {
                  "type": "string",
                  "description": "Target entity ID. If omitted, removes ALL relationships with this predicate.",
                  "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
                }
              },
              "required": [
                "predicate"
              ],
              "description": "Relationship to remove"
            },
            "description": "Relationships to remove"
          },
          "label": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200,
            "description": "Updated collection display name"
          },
          "description": {
            "type": "string",
            "maxLength": 2000,
            "description": "Updated collection description"
          },
          "display_image_url": {
            "type": "string",
            "format": "uri",
            "description": "Updated display image URL"
          }
        },
        "required": [
          "expect_tip"
        ]
      },
      "RoleResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "prev_cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "ver": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Entity version number",
            "example": 1
          },
          "roles": {
            "type": "object",
            "additionalProperties": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "description": "Role definitions mapping role names to action arrays",
            "example": {
              "captain": [
                "*:view",
                "*:update",
                "*:create",
                "collection:manage"
              ],
              "harpooner": [
                "*:view",
                "*:update",
                "*:create"
              ],
              "crew": [
                "*:view",
                "entity:create"
              ],
              "public": [
                "entity:view",
                "collection:view"
              ]
            }
          }
        },
        "required": [
          "id",
          "cid",
          "prev_cid",
          "ver",
          "roles"
        ]
      },
      "AddRoleRequest": {
        "type": "object",
        "properties": {
          "role": {
            "type": "string",
            "minLength": 1,
            "maxLength": 50,
            "description": "Name of the new role",
            "example": "harpooner"
          },
          "actions": {
            "type": "array",
            "items": {
              "type": "string",
              "minLength": 1
            },
            "minItems": 1,
            "description": "Actions this role can perform",
            "example": [
              "entity:view",
              "entity:create",
              "entity:update"
            ]
          }
        },
        "required": [
          "role",
          "actions"
        ]
      },
      "UpdateRoleRequest": {
        "type": "object",
        "properties": {
          "actions": {
            "type": "array",
            "items": {
              "type": "string",
              "minLength": 1
            },
            "minItems": 1,
            "description": "Updated actions for this role",
            "example": [
              "entity:view",
              "entity:create",
              "entity:update",
              "entity:delete"
            ]
          }
        },
        "required": [
          "actions"
        ]
      },
      "CollectionMember": {
        "type": "object",
        "properties": {
          "userId": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
          },
          "role": {
            "type": "string"
          },
          "userLabel": {
            "type": "string"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp when this membership expires (omitted for permanent)"
          },
          "granted_at": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp when this membership was granted"
          },
          "granted_by": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "User who granted this membership"
          },
          "is_expired": {
            "type": "boolean",
            "description": "Whether this membership has expired"
          }
        },
        "required": [
          "userId",
          "role",
          "is_expired"
        ]
      },
      "CollectionGroup": {
        "type": "object",
        "properties": {
          "groupId": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
          },
          "role": {
            "type": "string"
          },
          "groupLabel": {
            "type": "string"
          }
        },
        "required": [
          "groupId",
          "role"
        ]
      },
      "CollectionWildcard": {
        "type": "object",
        "properties": {
          "role": {
            "type": "string"
          }
        },
        "required": [
          "role"
        ]
      },
      "MembersResponse": {
        "type": "object",
        "properties": {
          "collection_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
          },
          "members": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/CollectionMember"
            }
          },
          "groups": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/CollectionGroup"
            }
          },
          "wildcards": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/CollectionWildcard"
            }
          }
        },
        "required": [
          "collection_id",
          "members",
          "groups",
          "wildcards"
        ]
      },
      "MemberAssignResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "prev_cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "ver": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Entity version number",
            "example": 1
          },
          "member_added": {
            "type": "object",
            "properties": {
              "user_id": {
                "type": "string",
                "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
              },
              "role": {
                "type": "string"
              },
              "expires_at": {
                "type": "string",
                "format": "date-time",
                "description": "ISO 8601 timestamp when this role expires (omitted for permanent)",
                "example": "2025-01-15T00:00:00.000Z"
              },
              "granted_at": {
                "type": "string",
                "format": "date-time",
                "description": "ISO 8601 timestamp when this role was granted",
                "example": "2025-01-01T12:00:00.000Z"
              },
              "granted_by": {
                "type": "string",
                "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
                "description": "User who granted this role"
              }
            },
            "required": [
              "user_id",
              "role",
              "granted_at",
              "granted_by"
            ]
          }
        },
        "required": [
          "id",
          "cid",
          "prev_cid",
          "ver",
          "member_added"
        ]
      },
      "AssignRoleRequest": {
        "type": "object",
        "properties": {
          "user_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "User entity ID to assign the role to",
            "example": "01JQ3EQ3EG000000000000000"
          },
          "role": {
            "type": "string",
            "minLength": 1,
            "maxLength": 50,
            "description": "Role name to assign",
            "example": "harpooner"
          },
          "expires_in": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Seconds until this role assignment expires (omit for permanent access)",
            "example": 86400
          }
        },
        "required": [
          "user_id",
          "role"
        ]
      },
      "MemberRemoveResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "prev_cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "ver": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Entity version number",
            "example": 1
          },
          "member_removed": {
            "type": "object",
            "properties": {
              "user_id": {
                "type": "string",
                "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
              },
              "role": {
                "type": "string"
              }
            },
            "required": [
              "user_id",
              "role"
            ]
          }
        },
        "required": [
          "id",
          "cid",
          "prev_cid",
          "ver",
          "member_removed"
        ]
      },
      "SetRootEntityResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/CollectionUpdateResponse"
          },
          {
            "type": "object",
            "properties": {
              "root_entity_id": {
                "type": "string",
                "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
                "description": "ID of the entity that was set as root"
              }
            },
            "required": [
              "root_entity_id"
            ]
          }
        ]
      },
      "SetRootEntityRequest": {
        "type": "object",
        "properties": {
          "expect_tip": {
            "type": "string",
            "minLength": 1,
            "description": "Current tip CID for CAS validation. Request fails with 409 if this does not match.",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "entity_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID to set as the root of this collection. Entity must already have a collection relationship pointing to this collection.",
            "example": "01JQ3EQ3EG000000000000000"
          }
        },
        "required": [
          "expect_tip",
          "entity_id"
        ]
      },
      "CollectionEntitySummary": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID"
          },
          "type": {
            "type": "string",
            "description": "Entity type",
            "example": "document"
          },
          "label": {
            "type": "string",
            "description": "Entity display label (from GraphDB, may be stale)",
            "example": "My Document"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the entity was created"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the entity was last updated (from GraphDB)"
          },
          "preview": {
            "allOf": [
              {
                "$ref": "#/components/schemas/EntityPreview"
              },
              {
                "description": "Fresh entity preview (only present when ?expand=preview)"
              }
            ]
          },
          "entity": {
            "allOf": [
              {
                "$ref": "#/components/schemas/EntityResponse"
              },
              {
                "description": "Full entity manifest (only present when ?expand=full). WARNING: Large payloads with many entities."
              }
            ]
          }
        },
        "required": [
          "id",
          "type",
          "label",
          "created_at",
          "updated_at"
        ]
      },
      "CollectionEntitiesResponse": {
        "type": "object",
        "properties": {
          "collection_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Collection ID"
          },
          "entities": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/CollectionEntitySummary"
            },
            "description": "Entities in this collection"
          },
          "pagination": {
            "type": "object",
            "properties": {
              "offset": {
                "type": "integer",
                "description": "Current offset"
              },
              "limit": {
                "type": "integer",
                "description": "Requested limit"
              },
              "count": {
                "type": "integer",
                "description": "Number of entities returned"
              },
              "has_more": {
                "type": "boolean",
                "description": "Whether more entities exist beyond this page"
              }
            },
            "required": [
              "offset",
              "limit",
              "count",
              "has_more"
            ],
            "description": "Pagination info"
          }
        },
        "required": [
          "collection_id",
          "entities",
          "pagination"
        ]
      },
      "EntityIndexEntry": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity persistent identifier"
          },
          "type": {
            "type": "string",
            "description": "Entity type",
            "example": "person"
          },
          "label": {
            "type": "string",
            "nullable": true,
            "description": "Entity display label",
            "example": "Captain Ahab"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the entity was created"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the entity was last updated"
          }
        },
        "required": [
          "id",
          "type",
          "label",
          "created_at",
          "updated_at"
        ]
      },
      "CollectionEntityLookupResponse": {
        "type": "object",
        "properties": {
          "collection_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Collection ID"
          },
          "entities": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/EntityIndexEntry"
            },
            "description": "Matching entities"
          },
          "count": {
            "type": "integer",
            "description": "Number of entities returned"
          }
        },
        "required": [
          "collection_id",
          "entities",
          "count"
        ]
      },
      "CollectionEntitySearchResult": {
        "allOf": [
          {
            "$ref": "#/components/schemas/EntityIndexEntry"
          },
          {
            "type": "object",
            "properties": {
              "score": {
                "type": "number",
                "description": "Similarity score (only present for semantic search via similar_to)",
                "example": 0.87
              }
            }
          }
        ]
      },
      "CollectionEntitySearchResponse": {
        "type": "object",
        "properties": {
          "collection_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Collection ID"
          },
          "query": {
            "type": "string",
            "description": "Original search query (for keyword search)"
          },
          "similar_to": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Source entity ID (for similarity search)"
          },
          "entities": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/CollectionEntitySearchResult"
            },
            "description": "Matching entities"
          },
          "count": {
            "type": "integer",
            "description": "Number of entities returned"
          }
        },
        "required": [
          "collection_id",
          "entities",
          "count"
        ]
      },
      "EntityCreatedResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "type": {
            "type": "string",
            "example": "collection"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "example": {
              "label": "The Pequod's Archive",
              "description": "A collection of whaling documents"
            }
          },
          "relationships": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1
                },
                "peer": {
                  "type": "string",
                  "minLength": 1
                },
                "peer_type": {
                  "type": "string"
                },
                "peer_label": {
                  "type": "string"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  }
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Entity relationship",
              "example": {
                "predicate": "crew",
                "peer": "01KDETYWYWM0MJVKM8DK3AEXPY",
                "peer_type": "collection"
              }
            }
          },
          "ver": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Entity version number",
            "example": 1
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 datetime",
            "example": "2025-12-26T12:00:00.000Z"
          },
          "ts": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Unix timestamp in milliseconds",
            "example": 1735214400000
          },
          "edited_by": {
            "type": "object",
            "properties": {
              "user_id": {
                "type": "string",
                "minLength": 1
              },
              "user_label": {
                "type": "string",
                "description": "Display name of the user/agent (populated during expansion)",
                "example": "Captain Ahab"
              },
              "method": {
                "type": "string",
                "enum": [
                  "manual",
                  "ai_generated",
                  "system",
                  "import"
                ]
              },
              "on_behalf_of": {
                "type": "string"
              },
              "on_behalf_of_label": {
                "type": "string",
                "description": "Display name of the on_behalf_of user/agent (populated during expansion)",
                "example": "Research Assistant"
              }
            },
            "required": [
              "user_id",
              "method"
            ],
            "description": "Audit trail for edits. Label fields are populated when ?expand=relationships is used.",
            "example": {
              "user_id": "01JCAPTAINAHAB000000000000",
              "user_label": "Captain Ahab",
              "method": "manual"
            }
          },
          "prev_cid": {
            "type": "string",
            "minLength": 1,
            "description": "Previous version CID (present on updates)",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          }
        },
        "required": [
          "id",
          "cid",
          "type",
          "properties",
          "relationships",
          "ver",
          "created_at",
          "ts",
          "edited_by"
        ]
      },
      "CreateEntityRequest": {
        "type": "object",
        "properties": {
          "note": {
            "type": "string",
            "description": "Optional note describing this change",
            "example": "Added Chapter 42: The Whiteness of the Whale"
          },
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Custom entity ID (generated if not provided)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "type": {
            "type": "string",
            "minLength": 1,
            "maxLength": 100,
            "description": "Entity type identifier",
            "example": "document"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Entity properties (type-specific). Text properties may contain inline entity references using the arke: URI scheme (e.g., [Label](arke:01JENTITY123...)) for domain-agnostic linking.",
            "example": {
              "label": "Chapter 1: Loomings",
              "author": "Herman Melville"
            }
          },
          "relationships": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1
                },
                "peer": {
                  "type": "string",
                  "minLength": 1
                },
                "peer_type": {
                  "type": "string"
                },
                "peer_label": {
                  "type": "string"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  }
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Entity relationship",
              "example": {
                "predicate": "crew",
                "peer": "01KDETYWYWM0MJVKM8DK3AEXPY",
                "peer_type": "collection"
              }
            },
            "description": "Entity relationships"
          },
          "collection": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Parent collection ID (creates collection relationship)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "sync_index": {
            "type": "boolean",
            "nullable": true,
            "default": false,
            "description": "Wait for collection index update before returning. Use when checking for duplicates immediately after creation. Adds ~1-5ms latency per collection."
          }
        },
        "required": [
          "type"
        ]
      },
      "BatchCreateSuccess": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "enum": [
              true
            ]
          },
          "index": {
            "type": "integer"
          },
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "type": {
            "type": "string"
          },
          "ver": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Entity version number",
            "example": 1
          }
        },
        "required": [
          "success",
          "index",
          "id",
          "cid",
          "type",
          "ver"
        ]
      },
      "BatchCreateFailure": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "enum": [
              false
            ]
          },
          "index": {
            "type": "integer"
          },
          "error": {
            "type": "string"
          },
          "code": {
            "type": "string"
          }
        },
        "required": [
          "success",
          "index",
          "error",
          "code"
        ]
      },
      "BatchCreateEntityResponse": {
        "type": "object",
        "properties": {
          "results": {
            "type": "array",
            "items": {
              "anyOf": [
                {
                  "$ref": "#/components/schemas/BatchCreateSuccess"
                },
                {
                  "$ref": "#/components/schemas/BatchCreateFailure"
                }
              ]
            }
          },
          "summary": {
            "type": "object",
            "properties": {
              "total": {
                "type": "integer"
              },
              "succeeded": {
                "type": "integer"
              },
              "failed": {
                "type": "integer"
              }
            },
            "required": [
              "total",
              "succeeded",
              "failed"
            ]
          }
        },
        "required": [
          "results",
          "summary"
        ]
      },
      "BatchCreateEntityItem": {
        "type": "object",
        "properties": {
          "note": {
            "type": "string",
            "description": "Optional note describing this change",
            "example": "Added Chapter 42: The Whiteness of the Whale"
          },
          "type": {
            "type": "string",
            "minLength": 1,
            "maxLength": 100,
            "description": "Entity type identifier"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Entity properties"
          },
          "relationships": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1
                },
                "peer": {
                  "type": "string",
                  "minLength": 1
                },
                "peer_type": {
                  "type": "string"
                },
                "peer_label": {
                  "type": "string"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  }
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Entity relationship",
              "example": {
                "predicate": "crew",
                "peer": "01KDETYWYWM0MJVKM8DK3AEXPY",
                "peer_type": "collection"
              }
            },
            "description": "Entity relationships"
          },
          "collection": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Parent collection ID (creates collection relationship)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          }
        },
        "required": [
          "type"
        ]
      },
      "BatchCreateEntityRequest": {
        "type": "object",
        "properties": {
          "entities": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/BatchCreateEntityItem"
            },
            "minItems": 1,
            "maxItems": 100,
            "description": "Array of entities to create (1-100)"
          },
          "default_collection": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Default collection for entities that do not specify one",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          }
        },
        "required": [
          "entities"
        ]
      },
      "BatchGetResponse": {
        "type": "object",
        "properties": {
          "entities": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/EntityResponse"
            },
            "description": "Entities that were found and accessible"
          },
          "not_found": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "description": "IDs that were not found or not accessible"
          }
        },
        "required": [
          "entities",
          "not_found"
        ]
      },
      "BatchGetRequest": {
        "type": "object",
        "properties": {
          "ids": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "minItems": 1,
            "maxItems": 100,
            "description": "Entity IDs to fetch (max 100)",
            "example": [
              "01JENTITY123456789012345",
              "01JENTITY234567890123456"
            ]
          }
        },
        "required": [
          "ids"
        ]
      },
      "TipResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          }
        },
        "required": [
          "id",
          "cid"
        ]
      },
      "EntityUpdatedResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/EntityResponse"
          },
          {
            "type": "object",
            "properties": {
              "prev_cid": {
                "type": "string",
                "minLength": 1,
                "description": "Previous version CID",
                "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
              }
            },
            "required": [
              "prev_cid"
            ]
          }
        ]
      },
      "UpdateEntityRequest": {
        "type": "object",
        "properties": {
          "expect_tip": {
            "type": "string",
            "minLength": 1,
            "description": "Current tip CID for CAS validation. Request fails with 409 if this does not match.",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "note": {
            "type": "string",
            "description": "Optional note describing this change",
            "example": "Added Chapter 42: The Whiteness of the Whale"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Properties to add or update (deep merged)"
          },
          "properties_remove": {
            "anyOf": [
              {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Top-level property keys to remove",
                "example": [
                  "deprecated_field",
                  "old_field"
                ]
              },
              {
                "type": "object",
                "additionalProperties": {
                  "nullable": true
                },
                "description": "Nested removal structure. Each key navigates into a nested object; leaf arrays specify keys to delete at that level.",
                "example": {
                  "settings": {
                    "notifications": [
                      "email",
                      "slack"
                    ]
                  }
                }
              }
            ],
            "description": "Properties to remove. Use string[] for top-level keys (e.g., [\"old_field\"]), or nested objects for deep removal (e.g., { config: { options: [\"debug\"] } }). Dot notation like \"config.options.debug\" is NOT supported."
          },
          "relationships_add": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Relationship predicate (e.g., \"admin\", \"contains\", \"collection\")",
                  "example": "admin"
                },
                "peer": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Target entity ID",
                  "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
                },
                "peer_type": {
                  "type": "string",
                  "description": "Target entity type hint",
                  "example": "user"
                },
                "peer_label": {
                  "type": "string",
                  "description": "Target entity label hint",
                  "example": "Captain Ahab"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  },
                  "description": "Properties to add/update on this relationship (deep merged if relationship exists)",
                  "example": {
                    "expires_at": "2025-12-31T00:00:00Z"
                  }
                },
                "properties_remove": {
                  "anyOf": [
                    {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    {
                      "type": "object",
                      "additionalProperties": {
                        "nullable": true
                      }
                    }
                  ],
                  "description": "Properties to remove from this relationship (string array or nested object)"
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Relationship to add or update (upsert semantics)"
            },
            "description": "Relationships to add or update (upsert semantics)"
          },
          "relationships_remove": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Relationship predicate",
                  "example": "viewer"
                },
                "peer": {
                  "type": "string",
                  "description": "Target entity ID. If omitted, removes ALL relationships with this predicate.",
                  "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
                }
              },
              "required": [
                "predicate"
              ],
              "description": "Relationship to remove"
            },
            "description": "Relationships to remove"
          },
          "sync_index": {
            "type": "boolean",
            "nullable": true,
            "default": false,
            "description": "Wait for collection index update before returning. Use when checking index immediately after update."
          }
        },
        "required": [
          "expect_tip"
        ]
      },
      "EntityDeletedResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "deleted_at": {
            "type": "string",
            "format": "date-time",
            "description": "ISO timestamp when the entity was deleted"
          },
          "ver": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Entity version number",
            "example": 1
          },
          "prev_cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          }
        },
        "required": [
          "id",
          "cid",
          "deleted_at",
          "ver",
          "prev_cid"
        ]
      },
      "DeleteEntityRequest": {
        "type": "object",
        "properties": {
          "expect_tip": {
            "type": "string",
            "minLength": 1,
            "description": "Current tip CID for CAS validation. Request fails with 409 if this does not match.",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "note": {
            "type": "string",
            "description": "Optional note describing this change",
            "example": "Added Chapter 42: The Whiteness of the Whale"
          },
          "reason": {
            "type": "string",
            "maxLength": 500,
            "description": "Reason for deleting the entity",
            "example": "Duplicate entry"
          },
          "sync_index": {
            "type": "boolean",
            "nullable": true,
            "default": false,
            "description": "Wait for collection index removal before returning. Use when checking index immediately after deletion."
          }
        },
        "required": [
          "expect_tip"
        ]
      },
      "CascadeDeletedEntity": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "type": {
            "type": "string",
            "description": "Entity type",
            "example": "file"
          },
          "depth": {
            "type": "integer",
            "description": "Depth from root entity at which this entity was found",
            "example": 1
          }
        },
        "required": [
          "id",
          "cid",
          "type",
          "depth"
        ]
      },
      "CascadeSkippedEntity": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "type": {
            "type": "string",
            "description": "Entity type",
            "example": "file"
          },
          "reason": {
            "type": "string",
            "enum": [
              "not_in_collection",
              "already_deleted",
              "edited_by_mismatch",
              "cas_conflict"
            ],
            "description": "Reason an entity was skipped during cascade delete"
          }
        },
        "required": [
          "id",
          "type",
          "reason"
        ]
      },
      "CascadeDeleteResponse": {
        "type": "object",
        "properties": {
          "root": {
            "allOf": [
              {
                "$ref": "#/components/schemas/EntityDeletedResponse"
              },
              {
                "description": "Deletion result for the root entity"
              }
            ]
          },
          "deleted": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/CascadeDeletedEntity"
            },
            "description": "Entities successfully deleted (ordered by depth, deepest first)"
          },
          "skipped": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/CascadeSkippedEntity"
            },
            "description": "Entities skipped during traversal with reasons"
          },
          "summary": {
            "type": "object",
            "properties": {
              "total_traversed": {
                "type": "integer",
                "description": "Total entities visited during BFS traversal"
              },
              "total_deleted": {
                "type": "integer",
                "description": "Total entities successfully deleted (excluding root)"
              },
              "total_skipped": {
                "type": "integer",
                "description": "Total entities skipped during traversal"
              },
              "max_depth_reached": {
                "type": "integer",
                "description": "Maximum depth reached during traversal"
              }
            },
            "required": [
              "total_traversed",
              "total_deleted",
              "total_skipped",
              "max_depth_reached"
            ],
            "description": "Summary statistics for the cascade delete operation"
          }
        },
        "required": [
          "root",
          "deleted",
          "skipped",
          "summary"
        ]
      },
      "CascadeDeleteRequest": {
        "type": "object",
        "properties": {
          "expect_tip": {
            "type": "string",
            "minLength": 1,
            "description": "Current tip CID for CAS validation. Request fails with 409 if this does not match.",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "note": {
            "type": "string",
            "description": "Optional note describing this change",
            "example": "Added Chapter 42: The Whiteness of the Whale"
          },
          "collection_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Collection to scope the cascade delete. Only entities in this collection will be deleted. Permission check is performed on this collection.",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "cascade_predicates": {
            "type": "array",
            "items": {
              "type": "string",
              "minLength": 1
            },
            "minItems": 1,
            "description": "Predicate patterns to follow during cascade traversal. Supports wildcards:\n- `\"child\"` - exact match only\n- `\"has_*\"` - matches has_document, has_image, etc.\n- `\"*_copy\"` - matches file_copy, document_copy, etc.\n- `\"*\"` - matches ALL predicates\n\n**Important:** The `collection` predicate NEVER cascades, even if `\"*\"` is specified. This protects the collection structure from accidental deletion.",
            "example": [
              "child",
              "has_*"
            ]
          },
          "edited_by_filter": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Only delete entities where edited_by.user_id matches this PI. Useful for cleaning up entities created by a specific agent.",
            "example": "01KAGENTXXXXXXXXXXXXXXXX"
          },
          "max_depth": {
            "type": "integer",
            "minimum": 1,
            "maximum": 20,
            "default": 10,
            "description": "Maximum relationship depth to traverse (default: 10, max: 20)",
            "example": 10
          },
          "reason": {
            "type": "string",
            "maxLength": 500,
            "description": "Reason for deleting the entities (applied to all deleted entities)",
            "example": "Cleanup after agent task"
          }
        },
        "required": [
          "expect_tip",
          "collection_id",
          "cascade_predicates"
        ]
      },
      "EntityUpdateResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/EntityResponse"
          },
          {
            "type": "object",
            "properties": {
              "prev_cid": {
                "type": "string",
                "minLength": 1,
                "description": "Previous version CID",
                "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
              }
            },
            "required": [
              "prev_cid"
            ]
          }
        ]
      },
      "EntityRestoredResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/EntityUpdateResponse"
          },
          {
            "type": "object",
            "properties": {
              "restored_from_ver": {
                "type": "integer",
                "minimum": 0,
                "exclusiveMinimum": true,
                "description": "The version number that was restored from",
                "example": 1
              }
            },
            "required": [
              "restored_from_ver"
            ]
          }
        ]
      },
      "RestoreEntityRequest": {
        "type": "object",
        "properties": {
          "expect_tip": {
            "type": "string",
            "minLength": 1,
            "description": "Current tip CID for CAS validation. Request fails with 409 if this does not match.",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "note": {
            "type": "string",
            "description": "Optional note describing this change",
            "example": "Added Chapter 42: The Whiteness of the Whale"
          }
        },
        "required": [
          "expect_tip"
        ]
      },
      "EntityCollectionResponse": {
        "type": "object",
        "properties": {
          "collection_id": {
            "type": "string",
            "nullable": true,
            "description": "The collection ID this entity belongs to, or null if not in any collection",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          }
        },
        "required": [
          "collection_id"
        ]
      },
      "TreeNode": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "label": {
            "type": "string",
            "description": "Entity label"
          },
          "type": {
            "type": "string",
            "description": "Entity type"
          },
          "depth": {
            "type": "integer",
            "description": "Depth in tree (0 = root)"
          },
          "children": {
            "type": "array",
            "description": "Child nodes (recursive TreeNode array)",
            "items": {
              "$ref": "#/components/schemas/TreeNode"
            }
          }
        },
        "required": [
          "id",
          "label",
          "type",
          "depth",
          "children"
        ],
        "description": "Root node with nested children"
      },
      "TreeResponse": {
        "type": "object",
        "properties": {
          "root": {
            "$ref": "#/components/schemas/TreeNode"
          },
          "total_nodes": {
            "type": "integer",
            "description": "Total number of nodes in the tree"
          },
          "truncated": {
            "type": "boolean",
            "description": "Whether results were truncated due to limit"
          }
        },
        "required": [
          "root",
          "total_nodes",
          "truncated"
        ]
      },
      "VersionMeta": {
        "type": "object",
        "nullable": true,
        "properties": {
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "ver": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Entity version number",
            "example": 1
          },
          "ts": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 datetime",
            "example": "2025-12-26T12:00:00.000Z"
          }
        },
        "required": [
          "cid",
          "ver",
          "ts"
        ],
        "description": "Metadata about the \"from\" version (null for version 1)"
      },
      "PropertyChange": {
        "type": "object",
        "properties": {
          "from": {
            "nullable": true,
            "description": "Previous value"
          },
          "to": {
            "nullable": true,
            "description": "New value"
          }
        }
      },
      "PropertiesChanges": {
        "type": "object",
        "properties": {
          "added": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Properties that were added",
            "example": {
              "email": "new@example.com"
            }
          },
          "removed": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Properties that were removed (includes old values)",
            "example": {
              "deprecated_field": "old value"
            }
          },
          "changed": {
            "type": "object",
            "additionalProperties": {
              "$ref": "#/components/schemas/PropertyChange"
            },
            "description": "Properties that changed",
            "example": {
              "name": {
                "from": "Old Name",
                "to": "New Name"
              }
            }
          }
        },
        "required": [
          "added",
          "removed",
          "changed"
        ]
      },
      "RelationshipChange": {
        "type": "object",
        "properties": {
          "predicate": {
            "type": "string",
            "minLength": 1
          },
          "peer": {
            "type": "string",
            "minLength": 1
          },
          "peer_type": {
            "type": "string"
          },
          "peer_label": {
            "type": "string"
          },
          "properties": {
            "$ref": "#/components/schemas/PropertyChange"
          }
        },
        "required": [
          "predicate",
          "peer",
          "properties"
        ]
      },
      "RelationshipsChanges": {
        "type": "object",
        "properties": {
          "added": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1
                },
                "peer": {
                  "type": "string",
                  "minLength": 1
                },
                "peer_type": {
                  "type": "string"
                },
                "peer_label": {
                  "type": "string"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  }
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Entity relationship",
              "example": {
                "predicate": "crew",
                "peer": "01KDETYWYWM0MJVKM8DK3AEXPY",
                "peer_type": "collection"
              }
            },
            "description": "Relationships that were added"
          },
          "removed": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1
                },
                "peer": {
                  "type": "string",
                  "minLength": 1
                },
                "peer_type": {
                  "type": "string"
                },
                "peer_label": {
                  "type": "string"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  }
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Entity relationship",
              "example": {
                "predicate": "crew",
                "peer": "01KDETYWYWM0MJVKM8DK3AEXPY",
                "peer_type": "collection"
              }
            },
            "description": "Relationships that were removed"
          },
          "changed": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/RelationshipChange"
            },
            "description": "Relationships with changed properties"
          }
        },
        "required": [
          "added",
          "removed",
          "changed"
        ]
      },
      "SemanticChanges": {
        "type": "object",
        "properties": {
          "properties": {
            "$ref": "#/components/schemas/PropertiesChanges"
          },
          "relationships": {
            "$ref": "#/components/schemas/RelationshipsChanges"
          }
        },
        "required": [
          "properties",
          "relationships"
        ]
      },
      "SemanticDiffResponse": {
        "type": "object",
        "properties": {
          "entity_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "from": {
            "$ref": "#/components/schemas/VersionMeta"
          },
          "to": {
            "$ref": "#/components/schemas/VersionMeta"
          },
          "format": {
            "type": "string",
            "enum": [
              "semantic"
            ]
          },
          "changes": {
            "$ref": "#/components/schemas/SemanticChanges"
          }
        },
        "required": [
          "entity_id",
          "from",
          "to",
          "format",
          "changes"
        ]
      },
      "PatchOperation": {
        "anyOf": [
          {
            "type": "object",
            "properties": {
              "op": {
                "type": "string",
                "enum": [
                  "add"
                ]
              },
              "path": {
                "type": "string"
              },
              "value": {
                "nullable": true
              }
            },
            "required": [
              "op",
              "path"
            ]
          },
          {
            "type": "object",
            "properties": {
              "op": {
                "type": "string",
                "enum": [
                  "remove"
                ]
              },
              "path": {
                "type": "string"
              }
            },
            "required": [
              "op",
              "path"
            ]
          },
          {
            "type": "object",
            "properties": {
              "op": {
                "type": "string",
                "enum": [
                  "replace"
                ]
              },
              "path": {
                "type": "string"
              },
              "value": {
                "nullable": true
              }
            },
            "required": [
              "op",
              "path"
            ]
          }
        ]
      },
      "PatchDiffResponse": {
        "type": "object",
        "properties": {
          "entity_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "from": {
            "$ref": "#/components/schemas/VersionMeta"
          },
          "to": {
            "$ref": "#/components/schemas/VersionMeta"
          },
          "format": {
            "type": "string",
            "enum": [
              "patch"
            ]
          },
          "patch": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/PatchOperation"
            },
            "description": "RFC 6902 JSON Patch operations"
          }
        },
        "required": [
          "entity_id",
          "from",
          "to",
          "format",
          "patch"
        ]
      },
      "DiffResponse": {
        "anyOf": [
          {
            "$ref": "#/components/schemas/SemanticDiffResponse"
          },
          {
            "$ref": "#/components/schemas/PatchDiffResponse"
          }
        ]
      },
      "PermissionResolution": {
        "type": "object",
        "properties": {
          "method": {
            "type": "string",
            "enum": [
              "collection",
              "self",
              "open_season"
            ],
            "description": "How permissions were resolved",
            "example": "collection"
          },
          "collection_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Collection ID if permissions come from a collection role",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "role": {
            "type": "string",
            "description": "Role name in the collection",
            "example": "editor"
          }
        },
        "required": [
          "method"
        ],
        "description": "How permissions were resolved"
      },
      "EntityPermissionsResponse": {
        "type": "object",
        "properties": {
          "entity_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "The entity ID",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "entity_type": {
            "type": "string",
            "description": "The entity type",
            "example": "file"
          },
          "allowed_actions": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Actions the user can perform on this entity",
            "example": [
              "entity:view",
              "entity:update"
            ]
          },
          "resolution": {
            "$ref": "#/components/schemas/PermissionResolution"
          }
        },
        "required": [
          "entity_id",
          "entity_type",
          "allowed_actions",
          "resolution"
        ]
      },
      "ContentMetadata": {
        "type": "object",
        "properties": {
          "key": {
            "type": "string",
            "description": "Version key for this content",
            "example": "v1"
          },
          "cid": {
            "type": "string",
            "description": "Content-addressed identifier (CID) of the content",
            "example": "bafyreih5iy6dqwbcslkqpx6bxwj7qy3z5x..."
          },
          "size": {
            "type": "number",
            "description": "Content size in bytes",
            "example": 12345
          },
          "content_type": {
            "type": "string",
            "description": "MIME type of the content",
            "example": "application/pdf"
          },
          "filename": {
            "type": "string",
            "description": "Original filename",
            "example": "document.pdf"
          },
          "uploaded_at": {
            "type": "string",
            "description": "ISO 8601 timestamp when content was uploaded",
            "example": "2025-01-15T10:00:00Z"
          }
        },
        "required": [
          "key",
          "cid",
          "size",
          "content_type",
          "uploaded_at"
        ],
        "description": "Content metadata"
      },
      "UploadContentResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Entity ID",
            "example": "01KABC123..."
          },
          "cid": {
            "type": "string",
            "description": "New entity manifest CID after update",
            "example": "bafyrei..."
          },
          "content": {
            "$ref": "#/components/schemas/ContentMetadata"
          },
          "prev_cid": {
            "type": "string",
            "description": "Previous entity manifest CID",
            "example": "bafyrei..."
          }
        },
        "required": [
          "id",
          "cid",
          "content",
          "prev_cid"
        ]
      },
      "GetUploadUrlResponse": {
        "type": "object",
        "properties": {
          "upload_url": {
            "type": "string",
            "format": "uri",
            "description": "Presigned URL for direct PUT upload to R2",
            "example": "https://xxx.r2.cloudflarestorage.com/..."
          },
          "r2_key": {
            "type": "string",
            "description": "R2 storage key (for reference)",
            "example": "01KABC123.../v1"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp when the URL expires",
            "example": "2025-01-15T10:15:00Z"
          }
        },
        "required": [
          "upload_url",
          "r2_key",
          "expires_at"
        ]
      },
      "GetUploadUrlRequest": {
        "type": "object",
        "properties": {
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content-addressed identifier (computed by client before upload)",
            "example": "bafyreih5iy6dqwbcslkqpx6bxwj7qy3z5x..."
          },
          "content_type": {
            "type": "string",
            "minLength": 1,
            "description": "MIME type of the content to upload",
            "example": "application/pdf"
          },
          "size": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "maximum": 524288000,
            "description": "Expected file size in bytes (max 500 MB)",
            "example": 10485760
          }
        },
        "required": [
          "cid",
          "content_type",
          "size"
        ]
      },
      "CompleteUploadResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Entity ID",
            "example": "01KABC123..."
          },
          "cid": {
            "type": "string",
            "description": "New entity manifest CID after update",
            "example": "bafyrei..."
          },
          "content": {
            "allOf": [
              {
                "$ref": "#/components/schemas/ContentMetadata"
              },
              {
                "description": "Content metadata stored on entity"
              }
            ]
          },
          "prev_cid": {
            "type": "string",
            "description": "Previous entity manifest CID",
            "example": "bafyrei..."
          }
        },
        "required": [
          "id",
          "cid",
          "content",
          "prev_cid"
        ]
      },
      "CompleteUploadRequest": {
        "type": "object",
        "properties": {
          "key": {
            "type": "string",
            "minLength": 1,
            "maxLength": 255,
            "description": "Version key used in upload-url request",
            "example": "v1"
          },
          "cid": {
            "type": "string",
            "description": "Content-addressed identifier computed by client",
            "example": "bafyreih5iy6dqwbcslkqpx6bxwj7qy3z5x..."
          },
          "size": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Actual file size in bytes",
            "example": 10485760
          },
          "content_type": {
            "type": "string",
            "description": "MIME type of the uploaded content",
            "example": "application/pdf"
          },
          "filename": {
            "type": "string",
            "maxLength": 255,
            "description": "Original filename for Content-Disposition",
            "example": "document.pdf"
          },
          "expect_tip": {
            "type": "string",
            "description": "Expected current tip CID for CAS protection",
            "example": "bafyrei..."
          }
        },
        "required": [
          "key",
          "cid",
          "size",
          "content_type",
          "expect_tip"
        ]
      },
      "DeleteContentResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Entity ID",
            "example": "01KABC123..."
          },
          "cid": {
            "type": "string",
            "description": "New entity manifest CID after update",
            "example": "bafyrei..."
          },
          "removed_key": {
            "type": "string",
            "description": "Content key that was removed",
            "example": "thumbnail"
          },
          "prev_cid": {
            "type": "string",
            "description": "Previous entity manifest CID",
            "example": "bafyrei..."
          }
        },
        "required": [
          "id",
          "cid",
          "removed_key",
          "prev_cid"
        ]
      },
      "RenameContentKeyResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Entity ID",
            "example": "01KABC123..."
          },
          "cid": {
            "type": "string",
            "description": "New entity manifest CID after update",
            "example": "bafyrei..."
          },
          "old_key": {
            "type": "string",
            "description": "Previous key name",
            "example": "thumbnail"
          },
          "new_key": {
            "type": "string",
            "description": "New key name",
            "example": "thumbnail_v1"
          },
          "content_cid": {
            "type": "string",
            "description": "CID of the content (unchanged)",
            "example": "bafyreih5iy6dqwbcslkqpx6bxwj7qy3z5x..."
          },
          "prev_cid": {
            "type": "string",
            "description": "Previous entity manifest CID",
            "example": "bafyrei..."
          }
        },
        "required": [
          "id",
          "cid",
          "old_key",
          "new_key",
          "content_cid",
          "prev_cid"
        ]
      },
      "RenameContentKeyRequest": {
        "type": "object",
        "properties": {
          "old_key": {
            "type": "string",
            "minLength": 1,
            "maxLength": 255,
            "description": "Current content key to rename",
            "example": "thumbnail"
          },
          "new_key": {
            "type": "string",
            "minLength": 1,
            "maxLength": 255,
            "description": "New key name",
            "example": "thumbnail_v1"
          },
          "expect_tip": {
            "type": "string",
            "description": "Expected current tip CID for CAS protection",
            "example": "bafyrei..."
          }
        },
        "required": [
          "old_key",
          "new_key",
          "expect_tip"
        ]
      },
      "QueueItem": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "description": "Queue item ID",
            "example": 1
          },
          "actor_id": {
            "type": "string",
            "description": "Actor who queued the update",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "status": {
            "type": "string",
            "enum": [
              "pending",
              "processing",
              "failed",
              "completed"
            ],
            "description": "Current status of the queue item",
            "example": "pending"
          },
          "relationships_count": {
            "type": "integer",
            "description": "Number of relationships in this update",
            "example": 5
          },
          "relationships_summary": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string"
                },
                "peer": {
                  "type": "string"
                }
              },
              "required": [
                "predicate",
                "peer"
              ]
            },
            "description": "Summary of relationships (predicate + peer)",
            "example": [
              {
                "predicate": "sent_to",
                "peer": "01KDETYWYWM0MJVKM8DK3AEXPY"
              }
            ]
          },
          "properties_keys": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Top-level property keys being updated",
            "example": [
              "extracted",
              "metadata"
            ]
          },
          "note": {
            "type": "string",
            "nullable": true,
            "description": "Optional note for the update",
            "example": "Extracted by kg-dedupe-resolver"
          },
          "error": {
            "type": "string",
            "nullable": true,
            "description": "Error message if failed",
            "example": "CAS conflict after 20 attempts"
          },
          "attempts": {
            "type": "integer",
            "description": "Number of processing attempts",
            "example": 3
          },
          "queued_at": {
            "type": "string",
            "description": "ISO timestamp when queued",
            "example": "2024-01-15T10:30:00.000Z"
          }
        },
        "required": [
          "id",
          "actor_id",
          "status",
          "relationships_count",
          "relationships_summary",
          "properties_keys",
          "note",
          "error",
          "attempts",
          "queued_at"
        ]
      },
      "QueueStatusResponse": {
        "type": "object",
        "properties": {
          "entity_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "counts": {
            "type": "object",
            "properties": {
              "pending": {
                "type": "integer"
              },
              "processing": {
                "type": "integer"
              },
              "failed": {
                "type": "integer"
              }
            },
            "required": [
              "pending",
              "processing",
              "failed"
            ],
            "description": "Count of items by status"
          },
          "items": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/QueueItem"
            },
            "description": "Detailed queue items (most recent first, max 100)"
          }
        },
        "required": [
          "entity_id",
          "counts",
          "items"
        ]
      },
      "QueuedUpdateInfo": {
        "type": "object",
        "properties": {
          "entity_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "queue_id": {
            "type": "integer",
            "description": "Queue ID for tracking (unique within entity)",
            "example": 1
          }
        },
        "required": [
          "entity_id",
          "queue_id"
        ]
      },
      "FailedUpdateInfo": {
        "type": "object",
        "properties": {
          "entity_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "error": {
            "type": "string",
            "description": "Error message explaining why queueing failed",
            "example": "Entity not found"
          }
        },
        "required": [
          "entity_id",
          "error"
        ]
      },
      "BatchSummary": {
        "type": "object",
        "properties": {
          "total": {
            "type": "integer",
            "description": "Total updates submitted",
            "example": 10
          },
          "queued": {
            "type": "integer",
            "description": "Updates successfully queued",
            "example": 9
          },
          "failed": {
            "type": "integer",
            "description": "Updates that failed to queue",
            "example": 1
          }
        },
        "required": [
          "total",
          "queued",
          "failed"
        ]
      },
      "AdditiveUpdatesResponse": {
        "type": "object",
        "properties": {
          "queued": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/QueuedUpdateInfo"
            },
            "description": "Successfully queued updates"
          },
          "failed": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/FailedUpdateInfo"
            },
            "description": "Updates that failed to queue (e.g., infrastructure errors)"
          },
          "summary": {
            "$ref": "#/components/schemas/BatchSummary"
          }
        },
        "required": [
          "queued",
          "failed",
          "summary"
        ]
      },
      "AdditiveUpdateItem": {
        "type": "object",
        "properties": {
          "entity_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID to update",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Properties to merge (deep merge semantics). Later values overwrite earlier for same keys.",
            "example": {
              "extracted": {
                "keywords": [
                  "whaling",
                  "voyage"
                ]
              }
            }
          },
          "relationships_add": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Relationship predicate (e.g., \"admin\", \"contains\", \"collection\")",
                  "example": "admin"
                },
                "peer": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Target entity ID",
                  "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
                },
                "peer_type": {
                  "type": "string",
                  "description": "Target entity type hint",
                  "example": "user"
                },
                "peer_label": {
                  "type": "string",
                  "description": "Target entity label hint",
                  "example": "Captain Ahab"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  },
                  "description": "Properties to add/update on this relationship (deep merged if relationship exists)",
                  "example": {
                    "expires_at": "2025-12-31T00:00:00Z"
                  }
                },
                "properties_remove": {
                  "anyOf": [
                    {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    {
                      "type": "object",
                      "additionalProperties": {
                        "nullable": true
                      }
                    }
                  ],
                  "description": "Properties to remove from this relationship (string array or nested object)"
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Relationship to add or update (upsert semantics)"
            },
            "description": "Relationships to add (upsert by predicate+peer). Properties are merged if relationship exists.",
            "example": [
              {
                "predicate": "mentions",
                "peer": "01KDETYWYWM0MJVKM8DK3AEXPY",
                "peer_type": "person"
              }
            ]
          },
          "note": {
            "type": "string",
            "maxLength": 500,
            "description": "Optional note for this update (preserved in version history)",
            "example": "Extracted by document indexer"
          }
        },
        "required": [
          "entity_id"
        ]
      },
      "AdditiveUpdatesRequest": {
        "type": "object",
        "properties": {
          "updates": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/AdditiveUpdateItem"
            },
            "minItems": 1,
            "maxItems": 1000,
            "description": "Updates to queue (1-1000 items). Updates to the same entity from the same actor are merged."
          }
        },
        "required": [
          "updates"
        ]
      },
      "VersionInfo": {
        "type": "object",
        "properties": {
          "ver": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Entity version number",
            "example": 1
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "ts": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 datetime",
            "example": "2025-12-26T12:00:00.000Z"
          },
          "edited_by": {
            "type": "object",
            "properties": {
              "user_id": {
                "type": "string",
                "minLength": 1
              },
              "user_label": {
                "type": "string",
                "description": "Display name of the user/agent (populated during expansion)",
                "example": "Captain Ahab"
              },
              "method": {
                "type": "string",
                "enum": [
                  "manual",
                  "ai_generated",
                  "system",
                  "import"
                ]
              },
              "on_behalf_of": {
                "type": "string"
              },
              "on_behalf_of_label": {
                "type": "string",
                "description": "Display name of the on_behalf_of user/agent (populated during expansion)",
                "example": "Research Assistant"
              }
            },
            "required": [
              "user_id",
              "method"
            ],
            "description": "Audit trail for edits. Label fields are populated when ?expand=relationships is used.",
            "example": {
              "user_id": "01JCAPTAINAHAB000000000000",
              "user_label": "Captain Ahab",
              "method": "manual"
            }
          },
          "note": {
            "type": "string",
            "description": "Optional note describing this version"
          },
          "arweave_tx": {
            "type": "string",
            "description": "Arweave transaction ID if this version has been attested",
            "example": "abc123xyz..."
          },
          "arweave_url": {
            "type": "string",
            "format": "uri",
            "description": "Arweave gateway URL for the attestation",
            "example": "https://arweave.net/abc123xyz..."
          }
        },
        "required": [
          "ver",
          "cid",
          "ts",
          "edited_by"
        ]
      },
      "VersionListResponse": {
        "type": "object",
        "properties": {
          "entity_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "versions": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/VersionInfo"
            },
            "description": "Version metadata array (newest first)"
          },
          "has_more": {
            "type": "boolean",
            "description": "Whether more versions exist beyond this page"
          },
          "next_cursor": {
            "type": "string",
            "nullable": true,
            "minLength": 1,
            "description": "CID to use as \"from\" parameter for next page",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          }
        },
        "required": [
          "entity_id",
          "versions",
          "has_more",
          "next_cursor"
        ]
      },
      "ManifestResponse": {
        "type": "object",
        "properties": {
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "manifest": {
            "type": "object",
            "properties": {
              "schema": {
                "type": "string",
                "example": "arke/eidos@v1"
              },
              "id": {
                "type": "string",
                "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
                "description": "Entity ID (ULID format)",
                "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
              },
              "type": {
                "type": "string",
                "example": "document"
              },
              "created_at": {
                "type": "string",
                "format": "date-time",
                "description": "ISO 8601 datetime",
                "example": "2025-12-26T12:00:00.000Z"
              },
              "ver": {
                "type": "integer",
                "minimum": 0,
                "exclusiveMinimum": true,
                "description": "Entity version number",
                "example": 1
              },
              "ts": {
                "type": "string",
                "format": "date-time",
                "description": "ISO 8601 datetime",
                "example": "2025-12-26T12:00:00.000Z"
              },
              "prev": {
                "type": "object",
                "nullable": true,
                "properties": {
                  "/": {
                    "type": "string",
                    "minLength": 1
                  }
                },
                "required": [
                  "/"
                ],
                "description": "IPLD link to previous version (null for v1)",
                "example": {
                  "/": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
                }
              },
              "properties": {
                "type": "object",
                "additionalProperties": {
                  "nullable": true
                },
                "description": "Entity properties"
              },
              "relationships": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "predicate": {
                      "type": "string",
                      "minLength": 1
                    },
                    "peer": {
                      "type": "string",
                      "minLength": 1
                    },
                    "peer_type": {
                      "type": "string"
                    },
                    "peer_label": {
                      "type": "string"
                    },
                    "properties": {
                      "type": "object",
                      "additionalProperties": {
                        "nullable": true
                      }
                    }
                  },
                  "required": [
                    "predicate",
                    "peer"
                  ],
                  "description": "Entity relationship",
                  "example": {
                    "predicate": "crew",
                    "peer": "01KDETYWYWM0MJVKM8DK3AEXPY",
                    "peer_type": "collection"
                  }
                }
              },
              "edited_by": {
                "type": "object",
                "properties": {
                  "user_id": {
                    "type": "string",
                    "minLength": 1
                  },
                  "user_label": {
                    "type": "string",
                    "description": "Display name of the user/agent (populated during expansion)",
                    "example": "Captain Ahab"
                  },
                  "method": {
                    "type": "string",
                    "enum": [
                      "manual",
                      "ai_generated",
                      "system",
                      "import"
                    ]
                  },
                  "on_behalf_of": {
                    "type": "string"
                  },
                  "on_behalf_of_label": {
                    "type": "string",
                    "description": "Display name of the on_behalf_of user/agent (populated during expansion)",
                    "example": "Research Assistant"
                  }
                },
                "required": [
                  "user_id",
                  "method"
                ],
                "description": "Audit trail for edits. Label fields are populated when ?expand=relationships is used.",
                "example": {
                  "user_id": "01JCAPTAINAHAB000000000000",
                  "user_label": "Captain Ahab",
                  "method": "manual"
                }
              },
              "note": {
                "type": "string"
              }
            },
            "required": [
              "schema",
              "id",
              "type",
              "created_at",
              "ver",
              "ts",
              "prev",
              "properties",
              "relationships",
              "edited_by"
            ],
            "description": "The full manifest at this version"
          }
        },
        "required": [
          "cid",
          "manifest"
        ]
      },
      "TypeRestriction": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "description": "The type with restricted implications",
            "example": "collection"
          },
          "allowed_verbs": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Verbs for which the base type DOES imply this type",
            "example": [
              "view"
            ]
          },
          "description": {
            "type": "string",
            "description": "Explanation of the restriction"
          }
        },
        "required": [
          "type",
          "allowed_verbs",
          "description"
        ]
      },
      "TypeHierarchy": {
        "type": "object",
        "properties": {
          "base_type": {
            "type": "string",
            "description": "The base type that implies all other types",
            "example": "entity"
          },
          "description": {
            "type": "string",
            "description": "Explanation of type hierarchy behavior"
          },
          "restrictions": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TypeRestriction"
            },
            "description": "Types with restricted implication rules"
          }
        },
        "required": [
          "base_type",
          "description",
          "restrictions"
        ],
        "description": "Type hierarchy. The base type implies all other types, with restrictions for certain types."
      },
      "WildcardInfo": {
        "type": "object",
        "properties": {
          "pattern": {
            "type": "string",
            "description": "The wildcard pattern format",
            "example": "*:{verb}"
          },
          "example": {
            "type": "string",
            "description": "An example of the pattern in use",
            "example": "*:view"
          },
          "description": {
            "type": "string",
            "description": "Explanation of what this pattern matches"
          }
        },
        "required": [
          "pattern",
          "example",
          "description"
        ],
        "description": "Verb wildcard pattern (*:verb)"
      },
      "PermissionsResponse": {
        "type": "object",
        "properties": {
          "actions": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "All registered action strings in the system",
            "example": [
              "entity:view",
              "entity:create",
              "entity:update"
            ]
          },
          "verbs": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "All unique verbs (the part after the colon)",
            "example": [
              "view",
              "create",
              "update",
              "delete"
            ]
          },
          "types": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "All unique types (the part before the colon)",
            "example": [
              "entity",
              "user",
              "collection"
            ]
          },
          "implications": {
            "type": "object",
            "additionalProperties": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "description": "Verb implications. If you have a verb, you also have its implied verbs. Example: update implies delete.",
            "example": {
              "update": [
                "delete"
              ],
              "manage": [
                "view",
                "create",
                "update",
                "delete"
              ]
            }
          },
          "type_hierarchy": {
            "$ref": "#/components/schemas/TypeHierarchy"
          },
          "wildcards": {
            "type": "object",
            "properties": {
              "verb": {
                "$ref": "#/components/schemas/WildcardInfo"
              },
              "type": {
                "allOf": [
                  {
                    "$ref": "#/components/schemas/WildcardInfo"
                  },
                  {
                    "description": "Type wildcard pattern (type:*)"
                  }
                ]
              }
            },
            "required": [
              "verb",
              "type"
            ],
            "description": "Wildcard pattern documentation"
          },
          "restrictions": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Security restrictions and special rules",
            "example": [
              "collection:* is not allowed - use explicit collection actions"
            ]
          },
          "default_roles": {
            "type": "object",
            "additionalProperties": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "description": "Default role definitions used when creating new collections",
            "example": {
              "owner": [
                "*:view",
                "*:update",
                "*:create",
                "collection:manage"
              ],
              "viewer": [
                "*:view"
              ]
            }
          }
        },
        "required": [
          "actions",
          "verbs",
          "types",
          "implications",
          "type_hierarchy",
          "wildcards",
          "restrictions",
          "default_roles"
        ]
      },
      "KladosResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/EntityResponse"
          },
          {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": [
                  "klados"
                ]
              }
            }
          }
        ]
      },
      "CreateKladosRequest": {
        "type": "object",
        "properties": {
          "note": {
            "type": "string",
            "description": "Optional note describing this change",
            "example": "Added Chapter 42: The Whiteness of the Whale"
          },
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Custom entity ID (generated if not provided)"
          },
          "label": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200,
            "description": "Klados display name",
            "example": "PDF Text Extractor"
          },
          "endpoint": {
            "type": "string",
            "format": "uri",
            "description": "Klados service base URL",
            "example": "https://pdf-extractor.example.com/v1"
          },
          "actions_required": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^[a-z_*]+:[a-z_*]+$"
            },
            "minItems": 1,
            "description": "Actions this klados requires on target collections",
            "example": [
              "entity:view",
              "entity:update",
              "entity:create"
            ]
          },
          "accepts": {
            "type": "object",
            "properties": {
              "types": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "minItems": 1,
                "description": "Content types (use [\"*\"] for any)",
                "example": [
                  "file/pdf",
                  "file/png"
                ]
              },
              "cardinality": {
                "type": "string",
                "enum": [
                  "one",
                  "many"
                ],
                "description": "Cardinality: one for single entity, many for multiple",
                "example": "one"
              }
            },
            "required": [
              "types",
              "cardinality"
            ],
            "description": "What this klados accepts as input",
            "title": "ContractSpec"
          },
          "produces": {
            "type": "object",
            "properties": {
              "types": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "minItems": 1,
                "description": "Content types (use [\"*\"] for any)",
                "example": [
                  "file/pdf",
                  "file/png"
                ]
              },
              "cardinality": {
                "type": "string",
                "enum": [
                  "one",
                  "many"
                ],
                "description": "Cardinality: one for single entity, many for multiple",
                "example": "one"
              }
            },
            "required": [
              "types",
              "cardinality"
            ],
            "description": "What this klados produces as output",
            "title": "ContractSpec"
          },
          "collection": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Collection to place klados in"
          },
          "description": {
            "type": "string",
            "maxLength": 2000,
            "description": "Klados description",
            "example": "Extracts text content from PDF files"
          },
          "input_schema": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "JSON Schema for input validation"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Additional properties to store"
          },
          "relationships": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1
                },
                "peer": {
                  "type": "string",
                  "minLength": 1
                },
                "peer_type": {
                  "type": "string"
                },
                "peer_label": {
                  "type": "string"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  }
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Entity relationship",
              "example": {
                "predicate": "crew",
                "peer": "01KDETYWYWM0MJVKM8DK3AEXPY",
                "peer_type": "collection"
              }
            },
            "description": "Relationships to create"
          }
        },
        "required": [
          "label",
          "endpoint",
          "actions_required",
          "accepts",
          "produces",
          "collection"
        ]
      },
      "KladosUpdateResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/KladosResponse"
          },
          {
            "type": "object",
            "properties": {
              "prev_cid": {
                "type": "string",
                "minLength": 1,
                "description": "Previous version CID",
                "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
              }
            },
            "required": [
              "prev_cid"
            ]
          }
        ]
      },
      "UpdateKladosRequest": {
        "type": "object",
        "properties": {
          "expect_tip": {
            "type": "string",
            "minLength": 1,
            "description": "Current tip CID for CAS validation. Request fails with 409 if this does not match.",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "note": {
            "type": "string",
            "description": "Optional note describing this change",
            "example": "Added Chapter 42: The Whiteness of the Whale"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Properties to add or update (deep merged)"
          },
          "properties_remove": {
            "anyOf": [
              {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Top-level property keys to remove",
                "example": [
                  "deprecated_field",
                  "old_field"
                ]
              },
              {
                "type": "object",
                "additionalProperties": {
                  "nullable": true
                },
                "description": "Nested removal structure. Each key navigates into a nested object; leaf arrays specify keys to delete at that level.",
                "example": {
                  "settings": {
                    "notifications": [
                      "email",
                      "slack"
                    ]
                  }
                }
              }
            ],
            "description": "Properties to remove. Use string[] for top-level keys (e.g., [\"old_field\"]), or nested objects for deep removal (e.g., { config: { options: [\"debug\"] } }). Dot notation like \"config.options.debug\" is NOT supported."
          },
          "relationships_add": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Relationship predicate (e.g., \"admin\", \"contains\", \"collection\")",
                  "example": "admin"
                },
                "peer": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Target entity ID",
                  "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
                },
                "peer_type": {
                  "type": "string",
                  "description": "Target entity type hint",
                  "example": "user"
                },
                "peer_label": {
                  "type": "string",
                  "description": "Target entity label hint",
                  "example": "Captain Ahab"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  },
                  "description": "Properties to add/update on this relationship (deep merged if relationship exists)",
                  "example": {
                    "expires_at": "2025-12-31T00:00:00Z"
                  }
                },
                "properties_remove": {
                  "anyOf": [
                    {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    {
                      "type": "object",
                      "additionalProperties": {
                        "nullable": true
                      }
                    }
                  ],
                  "description": "Properties to remove from this relationship (string array or nested object)"
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Relationship to add or update (upsert semantics)"
            },
            "description": "Relationships to add or update (upsert semantics)"
          },
          "relationships_remove": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Relationship predicate",
                  "example": "viewer"
                },
                "peer": {
                  "type": "string",
                  "description": "Target entity ID. If omitted, removes ALL relationships with this predicate.",
                  "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
                }
              },
              "required": [
                "predicate"
              ],
              "description": "Relationship to remove"
            },
            "description": "Relationships to remove"
          },
          "label": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200,
            "description": "Updated klados display name"
          },
          "description": {
            "type": "string",
            "maxLength": 2000,
            "description": "Updated klados description"
          },
          "endpoint": {
            "type": "string",
            "format": "uri",
            "description": "Updated klados service URL. Changing this clears endpoint_verified_at."
          },
          "actions_required": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^[a-z_*]+:[a-z_*]+$"
            },
            "minItems": 1,
            "description": "Actions this klados requires on target collections",
            "example": [
              "entity:view",
              "entity:update",
              "entity:create"
            ]
          },
          "status": {
            "type": "string",
            "enum": [
              "development",
              "active",
              "disabled"
            ],
            "description": "Klados status",
            "example": "development"
          },
          "accepts": {
            "type": "object",
            "properties": {
              "types": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "minItems": 1,
                "description": "Content types (use [\"*\"] for any)",
                "example": [
                  "file/pdf",
                  "file/png"
                ]
              },
              "cardinality": {
                "type": "string",
                "enum": [
                  "one",
                  "many"
                ],
                "description": "Cardinality: one for single entity, many for multiple",
                "example": "one"
              }
            },
            "required": [
              "types",
              "cardinality"
            ],
            "description": "Input/output contract specification for klados",
            "title": "ContractSpec"
          },
          "produces": {
            "type": "object",
            "properties": {
              "types": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "minItems": 1,
                "description": "Content types (use [\"*\"] for any)",
                "example": [
                  "file/pdf",
                  "file/png"
                ]
              },
              "cardinality": {
                "type": "string",
                "enum": [
                  "one",
                  "many"
                ],
                "description": "Cardinality: one for single entity, many for multiple",
                "example": "one"
              }
            },
            "required": [
              "types",
              "cardinality"
            ],
            "description": "Input/output contract specification for klados",
            "title": "ContractSpec"
          },
          "input_schema": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Updated input schema"
          }
        },
        "required": [
          "expect_tip"
        ]
      },
      "InvokeKladosGrant": {
        "type": "object",
        "properties": {
          "klados": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
              },
              "label": {
                "type": "string"
              }
            },
            "required": [
              "id",
              "label"
            ]
          },
          "actions": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "role": {
            "type": "string"
          },
          "already_granted": {
            "type": "boolean"
          },
          "expired": {
            "type": "boolean"
          },
          "current_expires_at": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": [
          "klados",
          "actions",
          "role",
          "already_granted"
        ]
      },
      "InvokeKladosPreviewResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "pending_confirmation"
            ]
          },
          "message": {
            "type": "string"
          },
          "grants": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/InvokeKladosGrant"
            }
          },
          "target": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
              },
              "label": {
                "type": "string"
              }
            },
            "required": [
              "id",
              "label"
            ]
          },
          "expires_at": {
            "type": "string",
            "format": "date-time"
          },
          "can_proceed": {
            "type": "boolean",
            "description": "True if all grants exist or user can create them"
          },
          "grants_needed": {
            "type": "boolean",
            "description": "True if klados needs permission grants"
          }
        },
        "required": [
          "status",
          "message",
          "grants",
          "target",
          "expires_at",
          "can_proceed",
          "grants_needed"
        ]
      },
      "InvokeKladosGrantResult": {
        "type": "object",
        "properties": {
          "klados_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
          },
          "role": {
            "type": "string"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time"
          },
          "was_update": {
            "type": "boolean"
          }
        },
        "required": [
          "klados_id",
          "role",
          "expires_at",
          "was_update"
        ]
      },
      "InvokeKladosStartedResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "started"
            ]
          },
          "job_id": {
            "type": "string",
            "description": "Unique job identifier",
            "example": "job_01JEXAMPLEID12345678901"
          },
          "job_collection": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "The job collection where klados writes logs"
          },
          "klados_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Klados that was invoked"
          },
          "grants": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/InvokeKladosGrantResult"
            }
          },
          "target_cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": [
          "status",
          "job_id",
          "job_collection",
          "klados_id",
          "grants",
          "target_cid",
          "expires_at"
        ]
      },
      "InvokeKladosRejectedResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "rejected"
            ]
          },
          "error": {
            "type": "string",
            "description": "Error message explaining why the klados rejected the job"
          },
          "retry_after": {
            "type": "integer",
            "description": "Suggested seconds to wait before retrying"
          },
          "grants": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/InvokeKladosGrantResult"
            }
          },
          "target_cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": [
          "status",
          "error",
          "grants",
          "target_cid",
          "expires_at"
        ]
      },
      "InvokeKladosConfirmedResponse": {
        "anyOf": [
          {
            "$ref": "#/components/schemas/InvokeKladosStartedResponse"
          },
          {
            "$ref": "#/components/schemas/InvokeKladosRejectedResponse"
          }
        ]
      },
      "InvokeKladosRequest": {
        "type": "object",
        "properties": {
          "target_entity": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Single entity to process (required when klados.accepts.cardinality = \"one\")"
          },
          "target_entities": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
            },
            "minItems": 1,
            "description": "Multiple entities to process (required when klados.accepts.cardinality = \"many\")"
          },
          "target_collection": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Collection for permission grant. Klados receives temporal permissions on this collection."
          },
          "job_collection": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Job collection where klados should write logs. If not provided, creates new collection."
          },
          "input": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Input data for the klados (validated against input_schema)"
          },
          "expires_in": {
            "type": "integer",
            "minimum": 60,
            "maximum": 86400,
            "default": 3600,
            "description": "Permission duration in seconds (60-86400, default: 3600)",
            "example": 3600
          },
          "confirm": {
            "type": "boolean",
            "default": false,
            "description": "false = preview grants, true = execute klados",
            "example": false
          },
          "rhiza": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
                "description": "Rhiza workflow ID"
              },
              "path": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Path of step names from entry to current"
              },
              "parent_logs": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Parent log IDs for chain traversal (e.g., \"log_abc123\")"
              },
              "batch": {
                "type": "object",
                "properties": {
                  "id": {
                    "type": "string",
                    "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
                    "description": "Batch entity ID"
                  },
                  "index": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Slot index (0-based)"
                  },
                  "total": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Total slots in batch"
                  }
                },
                "required": [
                  "id",
                  "index",
                  "total"
                ],
                "description": "Batch context if part of scatter operation"
              }
            },
            "required": [
              "id",
              "path",
              "parent_logs"
            ],
            "description": "Rhiza context for workflow invocations",
            "title": "RhizaContext"
          }
        },
        "required": [
          "target_collection"
        ]
      },
      "VerifyKladosTokenResponse": {
        "type": "object",
        "properties": {
          "verification_token": {
            "type": "string",
            "description": "Token to deploy at your endpoint",
            "example": "vt_abc123def456..."
          },
          "klados_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Klados ID to include in verification response"
          },
          "endpoint": {
            "type": "string",
            "format": "uri",
            "description": "Your klados endpoint URL"
          },
          "instructions": {
            "type": "string",
            "description": "How to complete verification"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time",
            "description": "Token expiration time"
          }
        },
        "required": [
          "verification_token",
          "klados_id",
          "endpoint",
          "instructions",
          "expires_at"
        ]
      },
      "VerifyKladosSuccessResponse": {
        "type": "object",
        "properties": {
          "verified": {
            "type": "boolean",
            "enum": [
              true
            ]
          },
          "verified_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the endpoint was verified"
          }
        },
        "required": [
          "verified",
          "verified_at"
        ]
      },
      "VerifyKladosFailureResponse": {
        "type": "object",
        "properties": {
          "verified": {
            "type": "boolean",
            "enum": [
              false
            ]
          },
          "error": {
            "type": "string",
            "enum": [
              "no_token",
              "token_expired",
              "fetch_failed",
              "invalid_response",
              "token_mismatch",
              "klados_id_mismatch"
            ],
            "description": "Verification error code"
          },
          "message": {
            "type": "string",
            "description": "Human-readable error description"
          }
        },
        "required": [
          "verified",
          "error",
          "message"
        ]
      },
      "VerifyKladosRequest": {
        "type": "object",
        "properties": {
          "confirm": {
            "type": "boolean",
            "description": "Set to true to perform verification. Omit or false to generate verification token.",
            "example": true
          }
        }
      },
      "ReinvokeKladosResponse": {
        "type": "object",
        "properties": {
          "accepted": {
            "type": "boolean",
            "description": "Whether the klados accepted the retry"
          },
          "job_id": {
            "type": "string",
            "description": "New job ID for the retry (only if accepted)",
            "example": "job_01JEXAMPLEID12345678901"
          },
          "original_log_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "The log ID that was retried"
          },
          "error": {
            "type": "string",
            "description": "Error message if rejected or invocation failed"
          },
          "retry_after": {
            "type": "integer",
            "description": "Suggested seconds to wait before retrying again"
          }
        },
        "required": [
          "accepted"
        ]
      },
      "ReinvokeKladosRequest": {
        "type": "object",
        "properties": {
          "log_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Log file entity ID containing the failed invocation to retry",
            "example": "01JLOGFILE1234567890123456"
          },
          "expires_in": {
            "type": "integer",
            "minimum": 60,
            "maximum": 86400,
            "default": 3600,
            "description": "Permission duration in seconds (60-86400, default: 3600)",
            "example": 3600
          }
        },
        "required": [
          "log_id"
        ]
      },
      "CreateKladosApiKeyResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "key": {
            "type": "string",
            "description": "Full API key - store securely, shown only once",
            "example": "ak_abc123..."
          },
          "prefix": {
            "type": "string",
            "description": "Key prefix for identification",
            "example": "ak_abc1"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time"
          },
          "label": {
            "type": "string",
            "nullable": true
          }
        },
        "required": [
          "id",
          "key",
          "prefix",
          "created_at",
          "expires_at",
          "label"
        ]
      },
      "CreateKladosApiKeyRequest": {
        "type": "object",
        "properties": {
          "label": {
            "type": "string",
            "maxLength": 100,
            "description": "Human-readable label for the key",
            "example": "Production key"
          },
          "expires_in_days": {
            "type": "integer",
            "minimum": 1,
            "maximum": 365,
            "default": 365,
            "description": "Key expiration in days (1-365, default: 365)",
            "example": 90
          }
        }
      },
      "KladosApiKeyInfo": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "prefix": {
            "type": "string"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time"
          },
          "last_used_at": {
            "type": "string",
            "nullable": true,
            "format": "date-time"
          },
          "label": {
            "type": "string",
            "nullable": true
          }
        },
        "required": [
          "id",
          "prefix",
          "created_at",
          "expires_at",
          "last_used_at",
          "label"
        ]
      },
      "ListKladosApiKeysResponse": {
        "type": "object",
        "properties": {
          "keys": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/KladosApiKeyInfo"
            }
          }
        },
        "required": [
          "keys"
        ]
      },
      "RhizaResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/EntityResponse"
          },
          {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": [
                  "rhiza"
                ]
              }
            }
          }
        ]
      },
      "WhereCondition": {
        "type": "object",
        "additionalProperties": {
          "nullable": true
        },
        "description": "Condition for routing decisions. Supports three forms:\n- Simple match: `{ property: \"status\", equals: \"approved\" }`\n- AND: `{ and: [condition1, condition2, ...] }`\n- OR: `{ or: [condition1, condition2, ...] }`\n\nConditions can be nested arbitrarily deep.",
        "example": {
          "property": "status",
          "equals": "approved"
        },
        "oneOf": [
          {
            "type": "object",
            "title": "WhereEquals",
            "description": "Simple property equality check",
            "properties": {
              "property": {
                "type": "string",
                "description": "Property path to check (e.g., \"status\", \"metadata.category\")"
              },
              "equals": {
                "oneOf": [
                  {
                    "type": "string"
                  },
                  {
                    "type": "number"
                  },
                  {
                    "type": "boolean"
                  },
                  {
                    "type": "null"
                  }
                ],
                "description": "Value to compare against"
              }
            },
            "required": [
              "property",
              "equals"
            ],
            "additionalProperties": false
          },
          {
            "type": "object",
            "title": "WhereAnd",
            "description": "Logical AND of multiple conditions",
            "properties": {
              "and": {
                "type": "array",
                "items": {
                  "$ref": "#/components/schemas/WhereCondition"
                },
                "minItems": 1,
                "description": "All conditions must match"
              }
            },
            "required": [
              "and"
            ],
            "additionalProperties": false
          },
          {
            "type": "object",
            "title": "WhereOr",
            "description": "Logical OR of multiple conditions",
            "properties": {
              "or": {
                "type": "array",
                "items": {
                  "$ref": "#/components/schemas/WhereCondition"
                },
                "minItems": 1,
                "description": "At least one condition must match"
              }
            },
            "required": [
              "or"
            ],
            "additionalProperties": false
          }
        ]
      },
      "CreateRhizaRequest": {
        "type": "object",
        "properties": {
          "note": {
            "type": "string",
            "description": "Optional note describing this change",
            "example": "Added Chapter 42: The Whiteness of the Whale"
          },
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Custom entity ID (generated if not provided)"
          },
          "label": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200,
            "description": "Rhiza display name",
            "example": "Document Processing Pipeline"
          },
          "version": {
            "type": "string",
            "minLength": 1,
            "maxLength": 50,
            "description": "Semantic version",
            "example": "1.0.0"
          },
          "entry": {
            "type": "string",
            "minLength": 1,
            "maxLength": 100,
            "description": "Entry point step name (must exist as a key in flow)",
            "example": "extract"
          },
          "flow": {
            "type": "object",
            "additionalProperties": {
              "type": "object",
              "properties": {
                "klados": {
                  "anyOf": [
                    {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string",
                          "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
                        },
                        "type": {
                          "type": "string"
                        },
                        "label": {
                          "type": "string"
                        },
                        "description": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "id"
                      ]
                    },
                    {
                      "type": "object",
                      "properties": {
                        "pi": {
                          "type": "string",
                          "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
                        },
                        "type": {
                          "type": "string"
                        },
                        "label": {
                          "type": "string"
                        },
                        "description": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "pi"
                      ]
                    }
                  ],
                  "description": "Reference to the klados entity to invoke for this step",
                  "title": "KladosRef",
                  "example": {
                    "id": "01KEXAMPLE123456789012345",
                    "type": "klados",
                    "label": "OCR Processor"
                  }
                },
                "then": {
                  "anyOf": [
                    {
                      "type": "object",
                      "properties": {
                        "done": {
                          "type": "boolean",
                          "enum": [
                            true
                          ]
                        }
                      },
                      "required": [
                        "done"
                      ],
                      "description": "Terminal - workflow ends"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "pass": {
                          "type": "string",
                          "minLength": 1,
                          "description": "Target step name for 1:1 handoff"
                        },
                        "route": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "where": {
                                "$ref": "#/components/schemas/WhereCondition"
                              },
                              "target": {
                                "type": "string",
                                "minLength": 1,
                                "description": "Target step name if condition matches"
                              }
                            },
                            "required": [
                              "where",
                              "target"
                            ],
                            "description": "Conditional routing rule. First matching rule wins.",
                            "title": "RouteRule"
                          },
                          "description": "Conditional routing rules"
                        }
                      },
                      "required": [
                        "pass"
                      ]
                    },
                    {
                      "type": "object",
                      "properties": {
                        "scatter": {
                          "type": "string",
                          "minLength": 1,
                          "description": "Target step name for 1:N fan-out"
                        },
                        "route": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "where": {
                                "$ref": "#/components/schemas/WhereCondition"
                              },
                              "target": {
                                "type": "string",
                                "minLength": 1,
                                "description": "Target step name if condition matches"
                              }
                            },
                            "required": [
                              "where",
                              "target"
                            ],
                            "description": "Conditional routing rule. First matching rule wins.",
                            "title": "RouteRule"
                          },
                          "description": "Conditional routing rules"
                        }
                      },
                      "required": [
                        "scatter"
                      ]
                    },
                    {
                      "type": "object",
                      "properties": {
                        "gather": {
                          "type": "string",
                          "minLength": 1,
                          "description": "Target step name for N:1 fan-in"
                        },
                        "route": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "where": {
                                "$ref": "#/components/schemas/WhereCondition"
                              },
                              "target": {
                                "type": "string",
                                "minLength": 1,
                                "description": "Target step name if condition matches"
                              }
                            },
                            "required": [
                              "where",
                              "target"
                            ],
                            "description": "Conditional routing rule. First matching rule wins.",
                            "title": "RouteRule"
                          },
                          "description": "Conditional routing rules"
                        }
                      },
                      "required": [
                        "gather"
                      ]
                    },
                    {
                      "type": "object",
                      "properties": {
                        "recurse": {
                          "type": "string",
                          "minLength": 1,
                          "description": "Target step name for bounded recursion"
                        },
                        "max_depth": {
                          "type": "integer",
                          "minimum": 1,
                          "description": "Maximum recursion depth (default: 10)",
                          "example": 10
                        },
                        "route": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "where": {
                                "$ref": "#/components/schemas/WhereCondition"
                              },
                              "target": {
                                "type": "string",
                                "minLength": 1,
                                "description": "Target step name if condition matches"
                              }
                            },
                            "required": [
                              "where",
                              "target"
                            ],
                            "description": "Conditional routing rule. First matching rule wins.",
                            "title": "RouteRule"
                          },
                          "description": "Conditional routing rules"
                        }
                      },
                      "required": [
                        "recurse"
                      ]
                    }
                  ],
                  "description": "What happens after this klados completes",
                  "title": "ThenSpec"
                }
              },
              "required": [
                "klados",
                "then"
              ],
              "description": "Flow step defining which klados to invoke and what happens after it completes",
              "title": "FlowStep"
            },
            "description": "Flow definition mapping step names to their klados references and handoff specifications. Step names are arbitrary strings that identify each step in the workflow.",
            "title": "Flow",
            "example": {
              "extract": {
                "klados": {
                  "id": "01KKLADOSA12345678901234",
                  "type": "klados"
                },
                "then": {
                  "pass": "summarize"
                }
              },
              "summarize": {
                "klados": {
                  "id": "01KKLADOSB12345678901234",
                  "type": "klados"
                },
                "then": {
                  "done": true
                }
              }
            }
          },
          "collection": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Collection to place rhiza in"
          },
          "description": {
            "type": "string",
            "maxLength": 2000,
            "description": "Rhiza description",
            "example": "Processes documents through OCR, classification, and extraction"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Additional properties to store"
          },
          "relationships": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1
                },
                "peer": {
                  "type": "string",
                  "minLength": 1
                },
                "peer_type": {
                  "type": "string"
                },
                "peer_label": {
                  "type": "string"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  }
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Entity relationship",
              "example": {
                "predicate": "crew",
                "peer": "01KDETYWYWM0MJVKM8DK3AEXPY",
                "peer_type": "collection"
              }
            },
            "description": "Relationships to create"
          }
        },
        "required": [
          "label",
          "version",
          "entry",
          "flow",
          "collection"
        ]
      },
      "RhizaUpdateResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/RhizaResponse"
          },
          {
            "type": "object",
            "properties": {
              "prev_cid": {
                "type": "string",
                "minLength": 1,
                "description": "Previous version CID",
                "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
              }
            },
            "required": [
              "prev_cid"
            ]
          }
        ]
      },
      "UpdateRhizaRequest": {
        "type": "object",
        "properties": {
          "expect_tip": {
            "type": "string",
            "minLength": 1,
            "description": "Current tip CID for CAS validation. Request fails with 409 if this does not match.",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "note": {
            "type": "string",
            "description": "Optional note describing this change",
            "example": "Added Chapter 42: The Whiteness of the Whale"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Properties to add or update (deep merged)"
          },
          "properties_remove": {
            "anyOf": [
              {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Top-level property keys to remove",
                "example": [
                  "deprecated_field",
                  "old_field"
                ]
              },
              {
                "type": "object",
                "additionalProperties": {
                  "nullable": true
                },
                "description": "Nested removal structure. Each key navigates into a nested object; leaf arrays specify keys to delete at that level.",
                "example": {
                  "settings": {
                    "notifications": [
                      "email",
                      "slack"
                    ]
                  }
                }
              }
            ],
            "description": "Properties to remove. Use string[] for top-level keys (e.g., [\"old_field\"]), or nested objects for deep removal (e.g., { config: { options: [\"debug\"] } }). Dot notation like \"config.options.debug\" is NOT supported."
          },
          "relationships_add": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Relationship predicate (e.g., \"admin\", \"contains\", \"collection\")",
                  "example": "admin"
                },
                "peer": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Target entity ID",
                  "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
                },
                "peer_type": {
                  "type": "string",
                  "description": "Target entity type hint",
                  "example": "user"
                },
                "peer_label": {
                  "type": "string",
                  "description": "Target entity label hint",
                  "example": "Captain Ahab"
                },
                "properties": {
                  "type": "object",
                  "additionalProperties": {
                    "nullable": true
                  },
                  "description": "Properties to add/update on this relationship (deep merged if relationship exists)",
                  "example": {
                    "expires_at": "2025-12-31T00:00:00Z"
                  }
                },
                "properties_remove": {
                  "anyOf": [
                    {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    {
                      "type": "object",
                      "additionalProperties": {
                        "nullable": true
                      }
                    }
                  ],
                  "description": "Properties to remove from this relationship (string array or nested object)"
                }
              },
              "required": [
                "predicate",
                "peer"
              ],
              "description": "Relationship to add or update (upsert semantics)"
            },
            "description": "Relationships to add or update (upsert semantics)"
          },
          "relationships_remove": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "predicate": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Relationship predicate",
                  "example": "viewer"
                },
                "peer": {
                  "type": "string",
                  "description": "Target entity ID. If omitted, removes ALL relationships with this predicate.",
                  "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
                }
              },
              "required": [
                "predicate"
              ],
              "description": "Relationship to remove"
            },
            "description": "Relationships to remove"
          },
          "label": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200,
            "description": "Updated rhiza display name"
          },
          "description": {
            "type": "string",
            "maxLength": 2000,
            "description": "Updated rhiza description"
          },
          "version": {
            "type": "string",
            "minLength": 1,
            "maxLength": 50,
            "description": "Updated semantic version"
          },
          "entry": {
            "type": "string",
            "minLength": 1,
            "maxLength": 100,
            "description": "Updated entry point step name (must exist as a key in flow)"
          },
          "flow": {
            "type": "object",
            "additionalProperties": {
              "type": "object",
              "properties": {
                "klados": {
                  "anyOf": [
                    {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string",
                          "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
                        },
                        "type": {
                          "type": "string"
                        },
                        "label": {
                          "type": "string"
                        },
                        "description": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "id"
                      ]
                    },
                    {
                      "type": "object",
                      "properties": {
                        "pi": {
                          "type": "string",
                          "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
                        },
                        "type": {
                          "type": "string"
                        },
                        "label": {
                          "type": "string"
                        },
                        "description": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "pi"
                      ]
                    }
                  ],
                  "description": "Reference to the klados entity to invoke for this step",
                  "title": "KladosRef",
                  "example": {
                    "id": "01KEXAMPLE123456789012345",
                    "type": "klados",
                    "label": "OCR Processor"
                  }
                },
                "then": {
                  "anyOf": [
                    {
                      "type": "object",
                      "properties": {
                        "done": {
                          "type": "boolean",
                          "enum": [
                            true
                          ]
                        }
                      },
                      "required": [
                        "done"
                      ],
                      "description": "Terminal - workflow ends"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "pass": {
                          "type": "string",
                          "minLength": 1,
                          "description": "Target step name for 1:1 handoff"
                        },
                        "route": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "where": {
                                "$ref": "#/components/schemas/WhereCondition"
                              },
                              "target": {
                                "type": "string",
                                "minLength": 1,
                                "description": "Target step name if condition matches"
                              }
                            },
                            "required": [
                              "where",
                              "target"
                            ],
                            "description": "Conditional routing rule. First matching rule wins.",
                            "title": "RouteRule"
                          },
                          "description": "Conditional routing rules"
                        }
                      },
                      "required": [
                        "pass"
                      ]
                    },
                    {
                      "type": "object",
                      "properties": {
                        "scatter": {
                          "type": "string",
                          "minLength": 1,
                          "description": "Target step name for 1:N fan-out"
                        },
                        "route": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "where": {
                                "$ref": "#/components/schemas/WhereCondition"
                              },
                              "target": {
                                "type": "string",
                                "minLength": 1,
                                "description": "Target step name if condition matches"
                              }
                            },
                            "required": [
                              "where",
                              "target"
                            ],
                            "description": "Conditional routing rule. First matching rule wins.",
                            "title": "RouteRule"
                          },
                          "description": "Conditional routing rules"
                        }
                      },
                      "required": [
                        "scatter"
                      ]
                    },
                    {
                      "type": "object",
                      "properties": {
                        "gather": {
                          "type": "string",
                          "minLength": 1,
                          "description": "Target step name for N:1 fan-in"
                        },
                        "route": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "where": {
                                "$ref": "#/components/schemas/WhereCondition"
                              },
                              "target": {
                                "type": "string",
                                "minLength": 1,
                                "description": "Target step name if condition matches"
                              }
                            },
                            "required": [
                              "where",
                              "target"
                            ],
                            "description": "Conditional routing rule. First matching rule wins.",
                            "title": "RouteRule"
                          },
                          "description": "Conditional routing rules"
                        }
                      },
                      "required": [
                        "gather"
                      ]
                    },
                    {
                      "type": "object",
                      "properties": {
                        "recurse": {
                          "type": "string",
                          "minLength": 1,
                          "description": "Target step name for bounded recursion"
                        },
                        "max_depth": {
                          "type": "integer",
                          "minimum": 1,
                          "description": "Maximum recursion depth (default: 10)",
                          "example": 10
                        },
                        "route": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "where": {
                                "$ref": "#/components/schemas/WhereCondition"
                              },
                              "target": {
                                "type": "string",
                                "minLength": 1,
                                "description": "Target step name if condition matches"
                              }
                            },
                            "required": [
                              "where",
                              "target"
                            ],
                            "description": "Conditional routing rule. First matching rule wins.",
                            "title": "RouteRule"
                          },
                          "description": "Conditional routing rules"
                        }
                      },
                      "required": [
                        "recurse"
                      ]
                    }
                  ],
                  "description": "What happens after this klados completes",
                  "title": "ThenSpec"
                }
              },
              "required": [
                "klados",
                "then"
              ],
              "description": "Flow step defining which klados to invoke and what happens after it completes",
              "title": "FlowStep"
            },
            "description": "Flow definition mapping step names to their klados references and handoff specifications. Step names are arbitrary strings that identify each step in the workflow.",
            "title": "Flow",
            "example": {
              "extract": {
                "klados": {
                  "id": "01KKLADOSA12345678901234",
                  "type": "klados"
                },
                "then": {
                  "pass": "summarize"
                }
              },
              "summarize": {
                "klados": {
                  "id": "01KKLADOSB12345678901234",
                  "type": "klados"
                },
                "then": {
                  "done": true
                }
              }
            }
          },
          "status": {
            "type": "string",
            "enum": [
              "development",
              "active",
              "disabled"
            ],
            "description": "Rhiza status",
            "example": "development"
          }
        },
        "required": [
          "expect_tip"
        ]
      },
      "InvokeRhizaGrant": {
        "type": "object",
        "properties": {
          "klados": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
              },
              "label": {
                "type": "string"
              }
            },
            "required": [
              "id",
              "label"
            ]
          },
          "actions": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "role": {
            "type": "string"
          },
          "already_granted": {
            "type": "boolean"
          }
        },
        "required": [
          "klados",
          "actions",
          "role",
          "already_granted"
        ]
      },
      "InvokeRhizaPreviewResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "pending_confirmation"
            ]
          },
          "message": {
            "type": "string"
          },
          "grants": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/InvokeRhizaGrant"
            }
          },
          "target": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
              },
              "label": {
                "type": "string"
              }
            },
            "required": [
              "id",
              "label"
            ]
          },
          "expires_at": {
            "type": "string",
            "format": "date-time"
          },
          "kladoi_count": {
            "type": "integer",
            "description": "Number of kladoi in the workflow"
          },
          "all_ready": {
            "type": "boolean",
            "description": "True if all kladoi are active and verified"
          },
          "klados_issues": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string",
                  "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
                },
                "reason": {
                  "type": "string"
                }
              },
              "required": [
                "id",
                "reason"
              ]
            },
            "description": "Issues with kladoi that prevent workflow execution"
          }
        },
        "required": [
          "status",
          "message",
          "grants",
          "target",
          "expires_at",
          "kladoi_count",
          "all_ready"
        ]
      },
      "InvokeRhizaStartedResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "started"
            ]
          },
          "job_id": {
            "type": "string",
            "description": "Unique job identifier",
            "example": "job_01JEXAMPLEID12345678901"
          },
          "job_collection": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "The job collection where logs are written"
          },
          "rhiza_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Rhiza that was invoked"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": [
          "status",
          "job_id",
          "job_collection",
          "rhiza_id",
          "expires_at"
        ]
      },
      "InvokeRhizaRejectedResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "rejected"
            ]
          },
          "error": {
            "type": "string",
            "description": "Error message explaining why the entry klados rejected the job"
          },
          "retry_after": {
            "type": "integer",
            "description": "Suggested seconds to wait before retrying"
          }
        },
        "required": [
          "status",
          "error"
        ]
      },
      "InvokeRhizaConfirmedResponse": {
        "anyOf": [
          {
            "$ref": "#/components/schemas/InvokeRhizaStartedResponse"
          },
          {
            "$ref": "#/components/schemas/InvokeRhizaRejectedResponse"
          }
        ]
      },
      "InvokeRhizaRequest": {
        "type": "object",
        "properties": {
          "target_entity": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Single entity to process (required when entry klados.accepts.cardinality = \"one\")"
          },
          "target_entities": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
            },
            "minItems": 1,
            "description": "Multiple entities to process (required when entry klados.accepts.cardinality = \"many\")"
          },
          "target_collection": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Collection for permission grant. All kladoi in workflow receive temporal permissions on this collection."
          },
          "input": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Input data for the workflow"
          },
          "expires_in": {
            "type": "integer",
            "minimum": 60,
            "maximum": 86400,
            "default": 3600,
            "description": "Permission duration in seconds (60-86400, default: 3600)",
            "example": 3600
          },
          "confirm": {
            "type": "boolean",
            "default": false,
            "description": "false = preview grants, true = execute workflow",
            "example": false
          }
        },
        "required": [
          "target_collection"
        ]
      },
      "ProgressCounters": {
        "type": "object",
        "properties": {
          "total": {
            "type": "integer",
            "minimum": 0,
            "description": "Total log entries"
          },
          "pending": {
            "type": "integer",
            "minimum": 0,
            "description": "Pending entries"
          },
          "running": {
            "type": "integer",
            "minimum": 0,
            "description": "Running entries"
          },
          "done": {
            "type": "integer",
            "minimum": 0,
            "description": "Completed entries"
          },
          "error": {
            "type": "integer",
            "minimum": 0,
            "description": "Failed entries"
          }
        },
        "required": [
          "total",
          "pending",
          "running",
          "done",
          "error"
        ]
      },
      "ErrorSummary": {
        "type": "object",
        "properties": {
          "klados_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Klados that failed"
          },
          "job_id": {
            "type": "string",
            "description": "Job ID"
          },
          "code": {
            "type": "string",
            "description": "Error code"
          },
          "message": {
            "type": "string",
            "description": "Error message"
          },
          "retryable": {
            "type": "boolean",
            "description": "Whether error is retryable"
          }
        },
        "required": [
          "klados_id",
          "job_id",
          "code",
          "message",
          "retryable"
        ]
      },
      "WorkflowStatusResponse": {
        "type": "object",
        "properties": {
          "job_id": {
            "type": "string",
            "description": "Job ID"
          },
          "rhiza_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Rhiza ID"
          },
          "status": {
            "type": "string",
            "enum": [
              "pending",
              "running",
              "done",
              "error"
            ],
            "description": "Overall workflow status"
          },
          "progress": {
            "$ref": "#/components/schemas/ProgressCounters"
          },
          "current_kladoi": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$"
            },
            "description": "Currently running kladoi"
          },
          "errors": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ErrorSummary"
            },
            "description": "Error summaries"
          },
          "started_at": {
            "type": "string",
            "format": "date-time",
            "description": "When workflow started"
          },
          "completed_at": {
            "type": "string",
            "format": "date-time",
            "description": "When workflow completed"
          }
        },
        "required": [
          "job_id",
          "rhiza_id",
          "status",
          "progress",
          "started_at"
        ]
      },
      "ResumedJob": {
        "type": "object",
        "properties": {
          "original_job_id": {
            "type": "string",
            "description": "Original job ID that was resumed"
          },
          "klados_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Klados that was re-invoked"
          },
          "new_job_id": {
            "type": "string",
            "description": "New job ID"
          }
        },
        "required": [
          "original_job_id",
          "klados_id",
          "new_job_id"
        ]
      },
      "ResumeWorkflowResponse": {
        "type": "object",
        "properties": {
          "resumed": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of jobs resumed"
          },
          "skipped": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of jobs skipped (non-retryable)"
          },
          "jobs": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ResumedJob"
            },
            "description": "Details of resumed jobs"
          }
        },
        "required": [
          "resumed",
          "skipped",
          "jobs"
        ]
      },
      "ResumeWorkflowRequest": {
        "type": "object",
        "properties": {
          "error_codes": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Only resume jobs with these error codes (all retryable if not specified)"
          }
        }
      },
      "Event": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "description": "Auto-increment event ID (use as cursor)",
            "example": 12346
          },
          "entity_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID that changed",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "New manifest CID",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "ts": {
            "type": "string",
            "description": "ISO timestamp of the event",
            "example": "2025-01-15T12:00:01Z"
          }
        },
        "required": [
          "id",
          "entity_id",
          "cid",
          "ts"
        ]
      },
      "EventsListResponse": {
        "type": "object",
        "properties": {
          "events": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Event"
            },
            "description": "List of events (newest first)"
          },
          "has_more": {
            "type": "boolean",
            "description": "Whether there are more (older) events available",
            "example": true
          },
          "cursor": {
            "type": "integer",
            "description": "Cursor for the next page (oldest id in batch, pass as ?cursor= for older events)",
            "example": 12340
          }
        },
        "required": [
          "events",
          "has_more",
          "cursor"
        ]
      },
      "PathEdge": {
        "type": "object",
        "properties": {
          "subject_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Source entity PI",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "subject_label": {
            "type": "string",
            "description": "Source entity label"
          },
          "subject_type": {
            "type": "string",
            "description": "Source entity type"
          },
          "subject_preview": {
            "allOf": [
              {
                "$ref": "#/components/schemas/EntityPreview"
              },
              {
                "description": "Fresh subject preview (default, or expand=preview)"
              }
            ]
          },
          "subject_entity": {
            "allOf": [
              {
                "$ref": "#/components/schemas/EntityResponse"
              },
              {
                "description": "Full subject manifest (expand=full)"
              }
            ]
          },
          "predicate": {
            "type": "string",
            "description": "Relationship predicate"
          },
          "object_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Target entity PI",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "object_label": {
            "type": "string",
            "description": "Target entity label"
          },
          "object_type": {
            "type": "string",
            "description": "Target entity type"
          },
          "object_preview": {
            "allOf": [
              {
                "$ref": "#/components/schemas/EntityPreview"
              },
              {
                "description": "Fresh object preview (default, or expand=preview)"
              }
            ]
          },
          "object_entity": {
            "allOf": [
              {
                "$ref": "#/components/schemas/EntityResponse"
              },
              {
                "description": "Full object manifest (expand=full)"
              }
            ]
          }
        },
        "required": [
          "subject_id",
          "subject_label",
          "subject_type",
          "predicate",
          "object_id",
          "object_label",
          "object_type"
        ],
        "example": {
          "subject_id": "01KE4ZY69F9R40E88PK9S0TQRQ",
          "subject_label": "Project Folder",
          "subject_type": "folder",
          "subject_preview": {
            "id": "01KE4ZY69F9R40E88PK9S0TQRQ",
            "type": "folder",
            "label": "Project Folder",
            "collection_id": "01JCOLLECTION123456789ABCD",
            "description_preview": "Main project folder containing research documents...",
            "created_at": "2025-01-10T08:00:00.000Z",
            "updated_at": "2025-01-18T16:45:00.000Z"
          },
          "predicate": "contains",
          "object_id": "01KE506KZGD8M2P1XK3VNQT4YR",
          "object_label": "Research Paper.pdf",
          "object_type": "file",
          "object_preview": {
            "id": "01KE506KZGD8M2P1XK3VNQT4YR",
            "type": "file",
            "label": "Research Paper.pdf",
            "collection_id": "01JCOLLECTION123456789ABCD",
            "description_preview": "Analysis of entity management patterns and best practices...",
            "created_at": "2025-01-15T10:00:00.000Z",
            "updated_at": "2025-01-20T14:30:00.000Z"
          }
        }
      },
      "PathResult": {
        "type": "object",
        "properties": {
          "source_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "target_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "length": {
            "type": "integer",
            "description": "Path length (number of hops)"
          },
          "edges": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/PathEdge"
            }
          }
        },
        "required": [
          "source_id",
          "target_id",
          "length",
          "edges"
        ]
      },
      "PathsBetweenResponse": {
        "type": "object",
        "properties": {
          "paths": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/PathResult"
            }
          },
          "truncated": {
            "type": "boolean",
            "description": "Whether results were truncated due to limit"
          }
        },
        "required": [
          "paths",
          "truncated"
        ]
      },
      "PathsBetweenRequest": {
        "type": "object",
        "properties": {
          "source_ids": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "minItems": 1,
            "description": "Starting entity PIs",
            "example": [
              "01KE4ZY69F9R40E88PK9S0TQRQ"
            ]
          },
          "target_ids": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "minItems": 1,
            "description": "Target entity PIs",
            "example": [
              "01KE506KZGD8M2P1XK3VNQT4YR"
            ]
          },
          "max_depth": {
            "type": "integer",
            "minimum": 1,
            "maximum": 4,
            "default": 4,
            "description": "Maximum path depth (1-4)",
            "example": 3
          },
          "direction": {
            "type": "string",
            "enum": [
              "outgoing",
              "incoming",
              "both"
            ],
            "default": "both",
            "description": "Relationship traversal direction",
            "example": "both"
          },
          "limit": {
            "type": "integer",
            "minimum": 1,
            "maximum": 1000,
            "default": 100,
            "description": "Maximum number of paths to return",
            "example": 10
          }
        },
        "required": [
          "source_ids",
          "target_ids"
        ]
      },
      "ReachableResult": {
        "type": "object",
        "properties": {
          "source_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "target_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "target_label": {
            "type": "string"
          },
          "target_type": {
            "type": "string"
          },
          "length": {
            "type": "integer",
            "description": "Path length (number of hops)"
          },
          "edges": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/PathEdge"
            }
          },
          "target_preview": {
            "allOf": [
              {
                "$ref": "#/components/schemas/EntityPreview"
              },
              {
                "description": "Fresh target preview (default, or expand=preview)"
              }
            ]
          },
          "target_entity": {
            "allOf": [
              {
                "$ref": "#/components/schemas/EntityResponse"
              },
              {
                "description": "Full target manifest (expand=full)"
              }
            ]
          }
        },
        "required": [
          "source_id",
          "target_id",
          "target_label",
          "target_type",
          "length",
          "edges"
        ],
        "example": {
          "source_id": "01KE4ZY69F9R40E88PK9S0TQRQ",
          "target_id": "01KE506KZGD8M2P1XK3VNQT4YR",
          "target_label": "Research Paper.pdf",
          "target_type": "file",
          "length": 1,
          "edges": [],
          "target_preview": {
            "id": "01KE506KZGD8M2P1XK3VNQT4YR",
            "type": "file",
            "label": "Research Paper.pdf",
            "collection_id": "01JCOLLECTION123456789ABCD",
            "description_preview": "Analysis of entity management patterns and best practices...",
            "created_at": "2025-01-15T10:00:00.000Z",
            "updated_at": "2025-01-20T14:30:00.000Z"
          }
        }
      },
      "PathsReachableResponse": {
        "type": "object",
        "properties": {
          "results": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ReachableResult"
            }
          },
          "truncated": {
            "type": "boolean",
            "description": "Whether results were truncated due to limit"
          }
        },
        "required": [
          "results",
          "truncated"
        ]
      },
      "PathsReachableRequest": {
        "type": "object",
        "properties": {
          "source_ids": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "minItems": 1,
            "description": "Starting entity PIs",
            "example": [
              "01KE4ZY69F9R40E88PK9S0TQRQ"
            ]
          },
          "target_type": {
            "type": "string",
            "minLength": 1,
            "description": "Target entity type to find",
            "example": "file"
          },
          "max_depth": {
            "type": "integer",
            "minimum": 1,
            "maximum": 4,
            "default": 4,
            "description": "Maximum path depth (1-4)",
            "example": 3
          },
          "direction": {
            "type": "string",
            "enum": [
              "outgoing",
              "incoming",
              "both"
            ],
            "default": "both",
            "description": "Relationship traversal direction",
            "example": "both"
          },
          "limit": {
            "type": "integer",
            "minimum": 1,
            "maximum": 1000,
            "default": 100,
            "description": "Maximum number of results to return",
            "example": 50
          }
        },
        "required": [
          "source_ids",
          "target_type"
        ]
      },
      "RelationshipInfo": {
        "type": "object",
        "properties": {
          "direction": {
            "type": "string",
            "enum": [
              "outgoing",
              "incoming"
            ]
          },
          "predicate": {
            "type": "string"
          },
          "peer_id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "peer_type": {
            "type": "string"
          },
          "peer_label": {
            "type": "string"
          },
          "properties": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            }
          },
          "peer_preview": {
            "allOf": [
              {
                "$ref": "#/components/schemas/EntityPreview"
              },
              {
                "description": "Fresh peer preview (default, or expand=preview)"
              }
            ]
          },
          "peer_entity": {
            "allOf": [
              {
                "$ref": "#/components/schemas/EntityResponse"
              },
              {
                "description": "Full peer manifest (expand=full)"
              }
            ]
          }
        },
        "required": [
          "direction",
          "predicate",
          "peer_id",
          "peer_type",
          "peer_label",
          "properties"
        ],
        "example": {
          "direction": "outgoing",
          "predicate": "contains",
          "peer_id": "01KE506KZGD8M2P1XK3VNQT4YR",
          "peer_type": "file",
          "peer_label": "Research Paper.pdf",
          "properties": {},
          "peer_preview": {
            "id": "01KE506KZGD8M2P1XK3VNQT4YR",
            "type": "file",
            "label": "Research Paper.pdf",
            "collection_id": "01KE4ZY69F9R40E88PK9S0TQRQ",
            "description_preview": "Analysis of entity management patterns and best practices...",
            "created_at": "2025-01-15T10:00:00.000Z",
            "updated_at": "2025-01-20T14:30:00.000Z"
          }
        }
      },
      "GraphEntityResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "type": {
            "type": "string"
          },
          "label": {
            "type": "string"
          },
          "collection_id": {
            "type": "string",
            "nullable": true
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          },
          "relationships": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/RelationshipInfo"
            }
          }
        },
        "required": [
          "id",
          "type",
          "label",
          "collection_id",
          "created_at",
          "updated_at",
          "relationships"
        ],
        "example": {
          "id": "01KE4ZY69F9R40E88PK9S0TQRQ",
          "type": "folder",
          "label": "Project Folder",
          "collection_id": "01JCOLLECTION123456789ABCD",
          "created_at": "2025-01-10T08:00:00.000Z",
          "updated_at": "2025-01-18T16:45:00.000Z",
          "relationships": [
            {
              "direction": "outgoing",
              "predicate": "contains",
              "peer_id": "01KE506KZGD8M2P1XK3VNQT4YR",
              "peer_type": "file",
              "peer_label": "Research Paper.pdf",
              "properties": {},
              "peer_preview": {
                "id": "01KE506KZGD8M2P1XK3VNQT4YR",
                "type": "file",
                "label": "Research Paper.pdf",
                "collection_id": "01JCOLLECTION123456789ABCD",
                "description_preview": "Analysis of entity management patterns and best practices...",
                "created_at": "2025-01-15T10:00:00.000Z",
                "updated_at": "2025-01-20T14:30:00.000Z"
              }
            }
          ]
        }
      },
      "EdgeStep": {
        "type": "object",
        "properties": {
          "edge": {
            "type": "string"
          },
          "direction": {
            "type": "string",
            "enum": [
              "outgoing",
              "incoming"
            ]
          },
          "score": {
            "type": "number"
          }
        },
        "required": [
          "edge",
          "direction"
        ]
      },
      "PathStep": {
        "anyOf": [
          {
            "type": "object",
            "properties": {
              "entity": {
                "type": "string",
                "description": "Entity ID",
                "example": "01KPERSON_EINSTEIN"
              },
              "label": {
                "type": "string",
                "example": "Albert Einstein"
              },
              "type": {
                "type": "string",
                "example": "person"
              },
              "score": {
                "type": "number",
                "description": "Semantic similarity score (0-1)",
                "example": 0.92
              },
              "preview_data": {
                "allOf": [
                  {
                    "$ref": "#/components/schemas/EntityPreview"
                  },
                  {
                    "description": "Entity preview data (present by default, omit expand or use expand=preview)"
                  }
                ]
              },
              "full_entity": {
                "allOf": [
                  {
                    "$ref": "#/components/schemas/EntityResponse"
                  },
                  {
                    "description": "Full entity manifest (only present when expand=full)"
                  }
                ]
              }
            },
            "required": [
              "entity"
            ],
            "description": "Entity step in a query path",
            "example": {
              "entity": "01KPERSON_EINSTEIN",
              "label": "Albert Einstein",
              "type": "person",
              "score": 0.92,
              "preview_data": {
                "id": "01KPERSON_EINSTEIN",
                "type": "person",
                "label": "Albert Einstein",
                "description_preview": "German-born theoretical physicist...",
                "created_at": "2025-01-01T00:00:00.000Z",
                "updated_at": "2025-01-15T12:00:00.000Z"
              }
            }
          },
          {
            "$ref": "#/components/schemas/EdgeStep"
          }
        ]
      },
      "QueryMetadata": {
        "type": "object",
        "properties": {
          "query": {
            "type": "string"
          },
          "hops": {
            "type": "integer"
          },
          "k": {
            "type": "integer"
          },
          "k_explore": {
            "type": "integer"
          },
          "total_candidates_explored": {
            "type": "integer"
          },
          "execution_time_ms": {
            "type": "number"
          },
          "collection": {
            "type": "string"
          },
          "error": {
            "type": "string"
          },
          "reason": {
            "type": "string"
          },
          "partial_path": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/PathStep"
            }
          },
          "stopped_at_hop": {
            "type": "integer"
          }
        },
        "required": [
          "query",
          "hops",
          "k",
          "k_explore",
          "total_candidates_explored",
          "execution_time_ms"
        ]
      },
      "QueryResponse": {
        "type": "object",
        "properties": {
          "results": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "entity": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string",
                      "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
                      "description": "Entity ID (ULID format)",
                      "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
                    },
                    "type": {
                      "type": "string",
                      "example": "person"
                    },
                    "label": {
                      "type": "string",
                      "example": "Albert Einstein"
                    },
                    "collection_id": {
                      "type": "string",
                      "nullable": true,
                      "example": "01JCOLL_RESEARCH"
                    },
                    "preview_data": {
                      "allOf": [
                        {
                          "$ref": "#/components/schemas/EntityPreview"
                        },
                        {
                          "description": "Entity preview data (present by default, omit expand or use expand=preview)"
                        }
                      ]
                    },
                    "full_entity": {
                      "allOf": [
                        {
                          "$ref": "#/components/schemas/EntityResponse"
                        },
                        {
                          "description": "Full entity manifest (only present when expand=full)"
                        }
                      ]
                    }
                  },
                  "required": [
                    "id",
                    "type",
                    "label",
                    "collection_id"
                  ],
                  "description": "Query result entity with optional expansion data",
                  "example": {
                    "id": "01KE4ZY69F9R40E88PK9S0TQRQ",
                    "type": "person",
                    "label": "Albert Einstein",
                    "collection_id": "01JCOLL_RESEARCH",
                    "preview_data": {
                      "id": "01KE4ZY69F9R40E88PK9S0TQRQ",
                      "type": "person",
                      "label": "Albert Einstein",
                      "collection_id": "01JCOLL_RESEARCH",
                      "description_preview": "German-born theoretical physicist who developed the theory of relativity...",
                      "created_at": "2025-01-15T10:00:00.000Z",
                      "updated_at": "2025-01-20T14:30:00.000Z"
                    }
                  }
                },
                "path": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/PathStep"
                  },
                  "description": "Path from entry point to result entity (empty for zero-hop queries)"
                },
                "score": {
                  "type": "number",
                  "description": "Combined relevance score (semantic similarity + path length)",
                  "example": 0.89
                }
              },
              "required": [
                "entity",
                "path",
                "score"
              ],
              "description": "A single query result with entity, path, and score",
              "example": {
                "entity": {
                  "id": "01KE4ZY69F9R40E88PK9S0TQRQ",
                  "type": "file",
                  "label": "Theory of Relativity.pdf",
                  "collection_id": "01JCOLL_RESEARCH",
                  "preview_data": {
                    "id": "01KE4ZY69F9R40E88PK9S0TQRQ",
                    "type": "file",
                    "label": "Theory of Relativity.pdf",
                    "collection_id": "01JCOLL_RESEARCH",
                    "description_preview": "Seminal paper on special and general relativity...",
                    "created_at": "2025-01-10T08:00:00.000Z",
                    "updated_at": "2025-01-10T08:00:00.000Z"
                  }
                },
                "path": [
                  {
                    "entity": "01KPERSON_EINSTEIN",
                    "label": "Albert Einstein",
                    "type": "person",
                    "preview_data": {
                      "id": "01KPERSON_EINSTEIN",
                      "type": "person",
                      "label": "Albert Einstein",
                      "created_at": "2025-01-01T00:00:00.000Z",
                      "updated_at": "2025-01-15T12:00:00.000Z"
                    }
                  },
                  {
                    "edge": "authored",
                    "direction": "outgoing"
                  }
                ],
                "score": 0.89
              }
            }
          },
          "metadata": {
            "$ref": "#/components/schemas/QueryMetadata"
          }
        },
        "required": [
          "results",
          "metadata"
        ]
      },
      "QueryRequest": {
        "type": "object",
        "properties": {
          "path": {
            "type": "string",
            "minLength": 1,
            "description": "Argo query string",
            "example": "\"medical college\" -[*]{,4}-> type:file"
          },
          "k": {
            "type": "integer",
            "minimum": 1,
            "maximum": 100,
            "default": 25,
            "description": "Maximum number of results to return",
            "example": 25
          },
          "k_explore": {
            "type": "integer",
            "minimum": 1,
            "maximum": 300,
            "description": "Beam width for exploration (default: k * 3)",
            "example": 75
          },
          "collection": {
            "type": "string",
            "description": "Scope query to collection PI",
            "example": "01JCOLL_MEDICAL"
          },
          "expand": {
            "type": "string",
            "enum": [
              "none",
              "preview",
              "full"
            ],
            "description": "Control entity expansion in results and path steps.\n- **omitted/preview** (default): Attach lightweight preview data (label, timestamps, truncated description/text)\n- **full**: Attach complete entity manifest (all properties, relationships, version info)\n- **none**: No expansion - return only Pinecone metadata (fastest, smallest payload)",
            "example": "preview"
          },
          "filter": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            },
            "description": "Filter by indexed metadata properties during semantic search.\n\nOnly underscore-prefixed properties (`_year`, `_class`, etc.) are indexed as filterable metadata.\n\n**Operators:** `$eq`, `$ne`, `$gt`, `$gte`, `$lt`, `$lte`, `$in`, `$nin`, `$exists`, `$and`, `$or`\n\n**Example - Find letters from the 1800s:**\n```json\n{ \"_year\": { \"$gte\": 1800, \"$lte\": 1899 } }\n```",
            "example": {
              "_year": {
                "$gt": 1800
              }
            }
          }
        },
        "required": [
          "path"
        ]
      },
      "MessageTooLargeDetails": {
        "type": "object",
        "properties": {
          "code": {
            "type": "string",
            "enum": [
              "MESSAGE_TOO_LARGE"
            ]
          },
          "message": {
            "type": "string"
          },
          "limit": {
            "type": "string",
            "example": "2MB"
          },
          "actual": {
            "type": "string",
            "example": "2.48MB"
          }
        },
        "required": [
          "code",
          "message",
          "limit"
        ]
      },
      "MessageTooLargeError": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "description": "Human-readable error message",
            "example": "Message exceeds maximum size limit. Please shorten your message."
          },
          "code": {
            "type": "string",
            "enum": [
              "MESSAGE_TOO_LARGE"
            ],
            "description": "Error code for client handling"
          },
          "details": {
            "$ref": "#/components/schemas/MessageTooLargeDetails"
          }
        },
        "required": [
          "error",
          "code"
        ]
      },
      "ChatStorageFullDetails": {
        "type": "object",
        "properties": {
          "code": {
            "type": "string",
            "enum": [
              "CHAT_STORAGE_FULL"
            ]
          },
          "message": {
            "type": "string"
          },
          "limit": {
            "type": "string",
            "example": "10GB"
          }
        },
        "required": [
          "code",
          "message",
          "limit"
        ]
      },
      "ChatStorageFullError": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "description": "Human-readable error message",
            "example": "This conversation has reached its maximum storage capacity. Please start a new conversation."
          },
          "code": {
            "type": "string",
            "enum": [
              "CHAT_STORAGE_FULL"
            ],
            "description": "Error code for client handling"
          },
          "details": {
            "$ref": "#/components/schemas/ChatStorageFullDetails"
          }
        },
        "required": [
          "error",
          "code"
        ]
      },
      "TextPart": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "enum": [
              "text"
            ]
          },
          "text": {
            "type": "string"
          }
        },
        "required": [
          "type",
          "text"
        ]
      },
      "ToolPart": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string"
          },
          "toolCallId": {
            "type": "string"
          },
          "toolName": {
            "type": "string"
          },
          "args": {
            "type": "object",
            "additionalProperties": {
              "nullable": true
            }
          },
          "output": {
            "nullable": true
          },
          "state": {
            "type": "string",
            "enum": [
              "partial-call",
              "call",
              "output-available"
            ]
          }
        },
        "required": [
          "type"
        ]
      },
      "MessagePart": {
        "anyOf": [
          {
            "$ref": "#/components/schemas/TextPart"
          },
          {
            "$ref": "#/components/schemas/ToolPart"
          },
          {
            "type": "object",
            "properties": {
              "type": {
                "type": "string"
              }
            },
            "required": [
              "type"
            ]
          }
        ]
      },
      "ChatMessage": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "role": {
            "type": "string",
            "enum": [
              "user",
              "assistant",
              "system",
              "tool"
            ]
          },
          "parts": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/MessagePart"
            }
          },
          "content": {
            "type": "string"
          }
        },
        "required": [
          "id",
          "role"
        ]
      },
      "SendChatRequest": {
        "type": "object",
        "properties": {
          "messages": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ChatMessage"
            },
            "description": "Array of chat messages in AI SDK v5 UIMessage format"
          }
        },
        "required": [
          "messages"
        ]
      },
      "ChatListItem": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Chat UUID (use with X-Chat-ID header)",
            "example": "550e8400-e29b-41d4-a716-446655440000"
          },
          "title": {
            "type": "string",
            "nullable": true,
            "description": "Auto-generated from first message (50 chars)",
            "example": "Help me understand the Arke API..."
          },
          "createdAt": {
            "type": "string",
            "description": "ISO8601 timestamp of chat creation",
            "example": "2026-01-26T14:30:00.000Z"
          },
          "updatedAt": {
            "type": "string",
            "description": "ISO8601 timestamp of last message",
            "example": "2026-01-26T15:45:00.000Z"
          },
          "lastMessagePreview": {
            "type": "string",
            "nullable": true,
            "description": "Last assistant response (100 chars, markdown stripped)",
            "example": "I found 3 entities matching your query. The first one is..."
          }
        },
        "required": [
          "id",
          "title",
          "createdAt",
          "updatedAt",
          "lastMessagePreview"
        ]
      },
      "ListChatsResponse": {
        "type": "object",
        "properties": {
          "chats": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ChatListItem"
            },
            "description": "Array of chat metadata objects"
          },
          "total": {
            "type": "number",
            "description": "Total number of chats for this user",
            "example": 42
          },
          "hasMore": {
            "type": "boolean",
            "description": "True if more chats exist beyond current page",
            "example": true
          }
        },
        "required": [
          "chats",
          "total",
          "hasMore"
        ]
      },
      "ChatSession": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Chat session ID",
            "example": "chat_abc123"
          },
          "createdAt": {
            "type": "string",
            "description": "ISO 8601 creation timestamp",
            "example": "2025-01-14T12:00:00.000Z"
          },
          "updatedAt": {
            "type": "string",
            "description": "ISO 8601 last update timestamp",
            "example": "2025-01-14T12:30:00.000Z"
          },
          "ownerId": {
            "type": "string",
            "nullable": true,
            "description": "Owner user ID (Arke PI or Supabase ID)"
          },
          "title": {
            "type": "string",
            "nullable": true,
            "description": "Auto-generated chat title from first message",
            "example": "Help me understand the codebase..."
          },
          "messages": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string"
                },
                "role": {
                  "type": "string",
                  "enum": [
                    "user",
                    "assistant",
                    "system",
                    "tool"
                  ]
                },
                "content": {
                  "type": "string"
                },
                "createdAt": {
                  "type": "string"
                },
                "toolInvocations": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "toolCallId": {
                        "type": "string"
                      },
                      "toolName": {
                        "type": "string"
                      },
                      "args": {
                        "type": "object",
                        "additionalProperties": {
                          "nullable": true
                        }
                      },
                      "result": {
                        "nullable": true
                      },
                      "state": {
                        "type": "string"
                      }
                    },
                    "required": [
                      "toolCallId",
                      "toolName",
                      "state"
                    ]
                  }
                }
              },
              "required": [
                "id",
                "role",
                "content",
                "createdAt"
              ]
            },
            "description": "Full message history (only included in session detail)"
          }
        },
        "required": [
          "id",
          "createdAt",
          "updatedAt",
          "ownerId",
          "title"
        ]
      },
      "ChatSessionDeleteResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          }
        },
        "required": [
          "success"
        ]
      },
      "AttestationResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "ver": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Entity version number",
            "example": 1
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "arweave_tx": {
            "type": "string",
            "description": "Arweave transaction ID",
            "example": "abc123xyz..."
          },
          "arweave_url": {
            "type": "string",
            "format": "uri",
            "description": "Arweave gateway URL for direct access",
            "example": "https://arweave.net/abc123xyz..."
          },
          "ts": {
            "type": "number",
            "description": "Unix timestamp (milliseconds) of the operation",
            "example": 1704455200000
          }
        },
        "required": [
          "id",
          "ver",
          "cid",
          "arweave_tx",
          "arweave_url",
          "ts"
        ]
      },
      "AttestationPendingResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
            "description": "Entity ID (ULID format)",
            "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
          },
          "ver": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Entity version number",
            "example": 1
          },
          "cid": {
            "type": "string",
            "minLength": 1,
            "description": "Content Identifier (CID) - content-addressed hash",
            "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
          },
          "attestation_status": {
            "type": "string",
            "enum": [
              "pending"
            ],
            "description": "Attestation upload status"
          },
          "message": {
            "type": "string",
            "description": "Status message",
            "example": "Attestation upload in progress"
          }
        },
        "required": [
          "id",
          "ver",
          "cid",
          "attestation_status",
          "message"
        ]
      },
      "ChainHeadResponse": {
        "type": "object",
        "properties": {
          "seq": {
            "type": "integer",
            "description": "Sequence number of the latest attestation",
            "example": 784
          },
          "tx": {
            "type": "string",
            "description": "Arweave transaction ID",
            "example": "Rxv_BpobNBUr0x5DstsAEUVxCO12hKxv7cnHnGLYp2c"
          },
          "arweave_url": {
            "type": "string",
            "format": "uri",
            "description": "Arweave gateway URL for direct access",
            "example": "https://arweave.net/Rxv_BpobNBUr0x5DstsAEUVxCO12hKxv7cnHnGLYp2c"
          }
        },
        "required": [
          "seq",
          "tx",
          "arweave_url"
        ]
      },
      "VerifyAttestationResponse": {
        "type": "object",
        "properties": {
          "arweave_tx": {
            "type": "string"
          },
          "attestation": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
                "description": "Entity ID (ULID format)",
                "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
              },
              "ver": {
                "type": "integer",
                "minimum": 0,
                "exclusiveMinimum": true,
                "description": "Entity version number",
                "example": 1
              },
              "cid": {
                "type": "string",
                "minLength": 1,
                "description": "Content Identifier (CID) - content-addressed hash",
                "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
              },
              "op": {
                "type": "string",
                "enum": [
                  "C",
                  "U"
                ],
                "description": "Operation type: C=Create, U=Update"
              },
              "vis": {
                "type": "string",
                "enum": [
                  "pub",
                  "priv"
                ],
                "description": "Visibility at time of operation"
              },
              "prev_cid": {
                "type": "string",
                "nullable": true,
                "minLength": 1,
                "description": "Previous version CID (null for creates)",
                "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
              },
              "ts": {
                "type": "number",
                "description": "Unix timestamp (milliseconds)"
              }
            },
            "required": [
              "id",
              "ver",
              "cid",
              "op",
              "vis",
              "prev_cid",
              "ts"
            ]
          },
          "cid_valid": {
            "type": "boolean",
            "description": "True if hash(manifest) matches the attested CID"
          },
          "manifest_preview": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "description": "Entity type",
                "example": "collection"
              }
            },
            "required": [
              "type"
            ],
            "description": "Truncated preview of the manifest content"
          }
        },
        "required": [
          "arweave_tx",
          "attestation",
          "cid_valid",
          "manifest_preview"
        ]
      }
    }
  },
  "x-arke-version": "1.0.0",
  "paths": {
    "/ops-reference": {
      "get": {
        "tags": [
          "Documentation"
        ],
        "summary": "Get LLM-friendly API reference",
        "description": "Returns a condensed, plain-text API operations reference optimized for LLM consumption.\n\nThis endpoint provides the same information as the OpenAPI spec but in a format that:\n- Uses ~80% fewer tokens than the full OpenAPI JSON\n- Preserves full endpoint descriptions\n- Organizes operations by category\n- Marks required fields with `*` suffix\n- Includes auth requirements inline\n\n**Format example:**\n```\n## Collections\nPOST /collections [required] - Create a new collection\n  body: {label*:string, description:string}\n\n  Creates a collection with the authenticated user as owner.\n```\n\nUse this for injecting API knowledge into LLM system prompts.",
        "responses": {
          "200": {
            "description": "Condensed API operations reference",
            "content": {
              "text/plain": {
                "schema": {
                  "type": "string",
                  "example": "# Arke API Operations Reference\n\n## Auth & Users\nPOST /auth/register [jwt-only] - Register new user\n..."
                }
              }
            }
          }
        }
      }
    },
    "/auth/register": {
      "post": {
        "tags": [
          "Auth"
        ],
        "summary": "Register new user",
        "description": "Creates a user entity from JWT claims. Idempotent - returns existing user if already registered.\n\n---\n**Permission:** `user:create`  \n**Auth:** jwt-only",
        "x-arke-action": "user:create",
        "x-arke-auth": "jwt-only",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "User already exists",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RegisterResponse"
                }
              }
            }
          },
          "201": {
            "description": "User created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RegisterResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "500": {
            "description": "Internal Server Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Internal server error"
                }
              }
            }
          }
        }
      }
    },
    "/auth/whoami": {
      "get": {
        "tags": [
          "Auth"
        ],
        "summary": "Get current identity",
        "description": "Returns identity information for the authenticated caller.\n\nAccepts any valid credential type:\n- **JWT**: Returns user PI, email, name, and Supabase user ID\n- **User API Key (uk_)**: Returns user PI and key metadata\n- **Agent API Key (ak_)**: Returns agent PI, owner PI, and key metadata\n\nUse this endpoint to verify credentials are working or to retrieve the caller's entity PI.\n\n---\n**Permission:** `auth:whoami`  \n**Auth:** required",
        "x-arke-action": "auth:whoami",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Identity information",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WhoamiResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "500": {
            "description": "Internal Server Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Internal server error"
                }
              }
            }
          }
        }
      }
    },
    "/alpha/invite": {
      "post": {
        "tags": [
          "Alpha"
        ],
        "summary": "Invite a user to the alpha",
        "description": "Creates an alpha invite and sends a Supabase invite email. Requires X-Alpha-Secret header.",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateAlphaInviteRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Invite created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CreateAlphaInviteResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "409": {
            "description": "Invite already exists for this email",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal Server Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Internal server error"
                }
              }
            }
          }
        }
      }
    },
    "/alpha/invites": {
      "get": {
        "tags": [
          "Alpha"
        ],
        "summary": "List all alpha invites",
        "description": "Returns all invites with their current status. Requires X-Alpha-Secret header.",
        "responses": {
          "200": {
            "description": "Invite list",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ListAlphaInvitesResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "500": {
            "description": "Internal Server Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Internal server error"
                }
              }
            }
          }
        }
      }
    },
    "/alpha/invite/{email}": {
      "delete": {
        "tags": [
          "Alpha"
        ],
        "summary": "Revoke an alpha invite",
        "description": "Revokes an invite by email. Requires X-Alpha-Secret header.",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "email"
            },
            "required": true,
            "name": "email",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Invite revoked",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "revoked": {
                      "type": "boolean"
                    },
                    "email": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "revoked",
                    "email"
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "500": {
            "description": "Internal Server Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Internal server error"
                }
              }
            }
          }
        }
      }
    },
    "/users/me": {
      "get": {
        "tags": [
          "Users"
        ],
        "summary": "Get current user",
        "description": "Returns the authenticated user's entity.\n\n---\n**Permission:** `user:view`  \n**Auth:** required",
        "x-arke-action": "user:view",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "User found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UserResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "500": {
            "description": "User entity not found (database inconsistency)"
          }
        }
      }
    },
    "/users/me/keys": {
      "post": {
        "tags": [
          "Users",
          "API Keys"
        ],
        "summary": "Create API key",
        "description": "Creates a new API key for the authenticated user. The full key is only returned once - store it securely.\n\n---\n**Permission:** `user:credentials`  \n**Auth:** required",
        "x-arke-action": "user:credentials",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateApiKeyRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "API key created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CreateApiKeyResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          }
        }
      },
      "get": {
        "tags": [
          "Users",
          "API Keys"
        ],
        "summary": "List API keys",
        "description": "Lists all active API keys for the authenticated user. Returns prefixes only, not full keys.\n\n---\n**Permission:** `user:credentials`  \n**Auth:** required",
        "x-arke-action": "user:credentials",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "API keys list",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ListApiKeysResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          }
        }
      }
    },
    "/users/me/keys/{prefix}": {
      "delete": {
        "tags": [
          "Users",
          "API Keys"
        ],
        "summary": "Revoke API key",
        "description": "Revokes an API key by prefix. The key will be immediately invalid.\n\n---\n**Permission:** `user:credentials`  \n**Auth:** required",
        "x-arke-action": "user:credentials",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "minLength": 4,
              "maxLength": 12,
              "description": "API key prefix (e.g., uk_xKj9)",
              "example": "uk_xKj9"
            },
            "required": true,
            "name": "prefix",
            "in": "path"
          }
        ],
        "responses": {
          "204": {
            "description": "API key revoked"
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/users/{id}/collections": {
      "get": {
        "tags": [
          "Users"
        ],
        "summary": "List collections user has access to",
        "description": "Returns all collections where the user has a role relationship (owner, editor, viewer, etc.).\n\nQueries GraphDB for collections with relationships pointing to this user where peer_type is 'user'.\nResults include the role predicate so clients know what access the user has to each collection.\n\nSupports filtering by predicate (role name) and pagination.\n\n---\n**Permission:** `user:view`  \n**Auth:** optional",
        "x-arke-action": "user:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "external",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "description": "Filter by role predicate (e.g., owner, editor)",
              "example": "owner"
            },
            "required": false,
            "name": "predicate",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "description": "Maximum number of results (default: 100, max: 1000)",
              "example": "100"
            },
            "required": false,
            "name": "limit",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "description": "Pagination offset",
              "example": "0"
            },
            "required": false,
            "name": "offset",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "List of collections",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UserCollectionsResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "503": {
            "description": "GraphDB service unavailable"
          }
        }
      }
    },
    "/users/me/search": {
      "post": {
        "tags": [
          "Users",
          "Search"
        ],
        "summary": "Search across user collections",
        "description": "Performs semantic search across all collections the authenticated user has access to.\n\n## Features\n- Searches all user's collections in parallel (up to 25)\n- Optionally includes public-domain entities\n- Filter by entity type or collection role\n- Results ranked by semantic relevance\n\n## Performance\n- Collections are queried in parallel for speed\n- If user has more than 25 collections, queries first 25 (by created_at). Use role filter to narrow down.\n- Response includes metadata showing collections_queried vs collections_total\n\n## Scoring\n- Results use cosine similarity scores (0-1)\n- Scores are comparable across collections\n\n## Entity Expansion\n\nUse `expand` in the request body to fetch entity data inline with search results:\n\n- **`expand: \"preview\"` (default)**: Adds `entity_preview` with fresh lightweight data (id, type, label, timestamps)\n- **`expand: \"full\"`**: Adds `entity` with complete manifest including all properties and relationships\n- **`expand: \"none\"`**: Returns search metadata only (fastest, lowest bandwidth)\n\nPreview mode is recommended for most use cases. Full expansion can result in large payloads.\nGracefully handles deleted or inaccessible entities (returns results without expansion data).\n\n\n---\n**Permission:** `search:execute`  \n**Auth:** required",
        "x-arke-action": "search:execute",
        "x-arke-auth": "required",
        "x-arke-tier": "external",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CrossCollectionSearchRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Search results",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CrossCollectionSearchResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "503": {
            "description": "Search service unavailable"
          }
        }
      }
    },
    "/collections": {
      "post": {
        "tags": [
          "Collections"
        ],
        "summary": "Create a new collection",
        "description": "Creates a collection with the authenticated user as owner.\n\n**Default Roles:**\n\nBy default (`use_roles_default: true`), collections include these standard roles:\n- `owner`: Full control including collection management\n- `editor`: Can modify entities but not collection settings\n- `viewer`: Read-only access\n- `public`: Public read access (`*:view`)\n\n**Customizing Roles:**\n\nPass custom `roles` to override specific defaults while keeping others. For example, to make entities publicly invokable (for agents):\n```json\n{ \"roles\": { \"public\": [\"*:view\", \"*:invoke\"] } }\n```\n\nSet `use_roles_default: false` to define all roles from scratch.\n\n**Platform Requirement:** The `public` role with `*:view` is always automatically ensured, guaranteeing all collections are publicly readable.\n\n---\n**Permission:** `collection:create`  \n**Auth:** required",
        "x-arke-action": "collection:create",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateCollectionRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Collection created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CollectionResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          }
        }
      }
    },
    "/collections/catalog": {
      "get": {
        "tags": [
          "Collections"
        ],
        "summary": "List all collections for catalog/sitemap",
        "description": "Returns a paginated list of all collection IDs and their last update times.\n\nThis endpoint is designed for sitemap generation and discovery services. It returns minimal data (just IDs and timestamps) for efficiency.\n\n**Lazy Population:** The catalog is populated as collections are created or updated. Newly created collections may take a moment to appear.\n\n**No Authentication Required:** This endpoint is public to allow crawlers and discovery services to access it.\n\n---\n**Permission:** `catalog:list`  \n**Auth:** none",
        "x-arke-action": "catalog:list",
        "x-arke-auth": "none",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "number",
              "minimum": 1,
              "maximum": 1000,
              "default": 100,
              "description": "Maximum number of collections to return (1-1000)",
              "example": 100
            },
            "required": false,
            "name": "limit",
            "in": "query"
          },
          {
            "schema": {
              "type": "number",
              "nullable": true,
              "minimum": 0,
              "default": 0,
              "description": "Number of collections to skip for pagination",
              "example": 0
            },
            "required": false,
            "name": "offset",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Paginated list of collections",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "data": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string",
                            "description": "Collection ID (PI)",
                            "example": "01JEXAMPLE..."
                          },
                          "updated_at": {
                            "type": "string",
                            "description": "ISO timestamp of last update",
                            "example": "2026-02-17T12:00:00Z"
                          }
                        },
                        "required": [
                          "id",
                          "updated_at"
                        ]
                      }
                    },
                    "pagination": {
                      "type": "object",
                      "properties": {
                        "total": {
                          "type": "number",
                          "description": "Total number of collections in catalog"
                        },
                        "limit": {
                          "type": "number",
                          "description": "Requested limit"
                        },
                        "offset": {
                          "type": "number",
                          "description": "Current offset"
                        },
                        "has_more": {
                          "type": "boolean",
                          "description": "Whether more results are available"
                        }
                      },
                      "required": [
                        "total",
                        "limit",
                        "offset",
                        "has_more"
                      ]
                    }
                  },
                  "required": [
                    "data",
                    "pagination"
                  ]
                }
              }
            }
          },
          "503": {
            "description": "Collections catalog service unavailable"
          }
        }
      }
    },
    "/collections/{id}": {
      "get": {
        "tags": [
          "Collections"
        ],
        "summary": "Get collection by ID",
        "description": "Returns a collection entity by ID.\n\n---\n**Permission:** `collection:view`  \n**Auth:** optional",
        "x-arke-action": "collection:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Collection found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CollectionResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      },
      "put": {
        "tags": [
          "Collections"
        ],
        "summary": "Update collection properties",
        "description": "Updates collection properties. Requires collection:update permission.\n\n**Relationship Target Validation:**\nBy default, new relationship targets in `relationships_add` are validated to ensure they exist. Use `?validate_relationships=false` to skip this validation.\n\nRequests with more than 500 unique relationship targets are rejected when validation is enabled.\n\n---\n**Permission:** `collection:update`  \n**Auth:** required",
        "x-arke-action": "collection:update",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "enum": [
                "true",
                "false"
              ],
              "example": "true"
            },
            "required": false,
            "description": "Validate that relationship targets exist. Defaults to true for single entity operations, false for batch. When true, requests with >500 unique relationship targets are rejected.",
            "name": "validate_relationships",
            "in": "query"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdateCollectionRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Collection updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CollectionUpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/collections/{id}/roles": {
      "post": {
        "tags": [
          "Collections"
        ],
        "summary": "Add a new role",
        "description": "Adds a new role to the collection. Requires collection:manage permission.\n\n---\n**Permission:** `collection:manage`  \n**Auth:** required",
        "x-arke-action": "collection:manage",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/AddRoleRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Role added",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RoleResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/collections/{id}/roles/{role}": {
      "put": {
        "tags": [
          "Collections"
        ],
        "summary": "Update role actions",
        "description": "Updates the actions for an existing role. Requires collection:manage permission.\n\n---\n**Permission:** `collection:manage`  \n**Auth:** required",
        "x-arke-action": "collection:manage",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "maxLength": 50,
              "example": "harpooner"
            },
            "required": true,
            "description": "Role name",
            "name": "role",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdateRoleRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Role updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RoleResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": [
          "Collections"
        ],
        "summary": "Delete a role",
        "description": "Deletes a role from the collection. Requires collection:manage permission.\n\n---\n**Permission:** `collection:manage`  \n**Auth:** required",
        "x-arke-action": "collection:manage",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "maxLength": 50,
              "example": "harpooner"
            },
            "required": true,
            "description": "Role name",
            "name": "role",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Role deleted",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RoleResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/collections/{id}/members": {
      "get": {
        "tags": [
          "Collections"
        ],
        "summary": "List collection members",
        "description": "Returns all members of the collection grouped by type. By default, expired memberships are excluded.\n\n---\n**Permission:** `collection:view`  \n**Auth:** optional",
        "x-arke-action": "collection:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "enum": [
                "true",
                "false"
              ],
              "default": "false",
              "description": "Include expired memberships in response"
            },
            "required": false,
            "name": "include_expired",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Members list",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MembersResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": [
          "Collections"
        ],
        "summary": "Assign user to role",
        "description": "Assigns a user to a role in the collection. Requires collection:manage permission.\n\n---\n**Permission:** `collection:manage`  \n**Auth:** required",
        "x-arke-action": "collection:manage",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/AssignRoleRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "User assigned to role",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MemberAssignResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/collections/{id}/members/{userId}": {
      "delete": {
        "tags": [
          "Collections"
        ],
        "summary": "Remove user from role",
        "description": "Removes a user from a role in the collection. Requires collection:manage permission.\n\n---\n**Permission:** `collection:manage`  \n**Auth:** required",
        "x-arke-action": "collection:manage",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01JQ3EQ3EG000000000000000"
            },
            "required": true,
            "description": "User entity ID (ULID)",
            "name": "userId",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "example": "crew"
            },
            "required": true,
            "description": "Role to remove user from",
            "name": "role",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "User removed from role",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MemberRemoveResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/collections/{id}/root": {
      "put": {
        "tags": [
          "Collections"
        ],
        "summary": "Set root entity",
        "description": "Links an entity as the root of this collection.\n\n**Prerequisites:** The entity must already have a 'collection' relationship\npointing to this collection (typically set during entity creation via the\n`collection` field).\n\n**Recommended flow:**\n1. Create entity with `collection` field set  entity is immediately protected\n2. Call this endpoint to establish the root link from collection to entity\n\nThis adds only the reverse relationship:\n- Collection  Entity (predicate: 'root')\n\nRequires collection:update permission on the collection.\n\n---\n**Permission:** `collection:update`  \n**Auth:** required",
        "x-arke-action": "collection:update",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SetRootEntityRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Root entity set",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SetRootEntityResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/collections/{id}/entities": {
      "get": {
        "tags": [
          "Collections"
        ],
        "summary": "List entities in a collection",
        "description": "Returns entities belonging to this collection.\n\nSupports pagination and optional type filtering. Results are ordered by creation date (newest first).\n\n**Expansion Modes:**\n\nBy default, returns lightweight summaries (pi, type, label, timestamps).\n\nUse the `expand` parameter to hydrate entity data from storage:\n\n- **`?expand=preview`**: Adds `preview` field with fresh lightweight data (label, truncated description/text, timestamps). ~5-10KB per entity.\n\n- **`?expand=full`**: Adds `entity` field with complete manifest (all properties, relationships, version history). ~20-50KB per entity.\n\n**Performance Note:** Expansion requires fetching each entity from storage. Limited to 100 entities per request. Use smaller `limit` values when expanding.\n\n---\n**Permission:** `collection:view`  \n**Auth:** optional",
        "x-arke-action": "collection:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "external",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "description": "Filter entities by type",
              "example": "document"
            },
            "required": false,
            "name": "type",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "description": "JSON-encoded string for filtering by custom properties. Only underscore-prefixed properties (e.g., _year, _kg_layer) are filterable. Pass as URL-encoded JSON: ?filter={\"_kg_layer\":0}. Supports direct equality {\"_year\": 1850} or comparison operators {\"_year\": {\"$gte\": 1800, \"$lte\": 1900}}. Available operators: $eq, $ne, $gt, $gte, $lt, $lte. Multiple properties are AND-combined.",
              "example": "{\"_kg_layer\":0}"
            },
            "required": false,
            "name": "filter",
            "in": "query"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 10000,
              "default": 1000,
              "description": "Maximum number of entities to return",
              "example": 100
            },
            "required": false,
            "name": "limit",
            "in": "query"
          },
          {
            "schema": {
              "type": "integer",
              "nullable": true,
              "minimum": 0,
              "default": 0,
              "description": "Number of entities to skip",
              "example": 0
            },
            "required": false,
            "name": "offset",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "enum": [
                "preview",
                "full"
              ],
              "description": "Expand entity data. \"preview\" adds lightweight previews, \"full\" adds complete manifests. Maximum 100 entities when using expand.",
              "example": "preview"
            },
            "required": false,
            "name": "expand",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Entities in collection",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CollectionEntitiesResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "503": {
            "description": "Collection index service unavailable"
          }
        }
      }
    },
    "/collections/{id}/entities/lookup": {
      "get": {
        "tags": [
          "Collections"
        ],
        "summary": "Lookup entities by label",
        "description": "Fast (~5ms) lookup of entities by exact label and/or type within this collection.\n\nUses a per-collection SQLite index for instant keyword queries. Complements semantic search for when you know the exact label.\n\n**Query Parameters:**\n- `label`: Exact label match (case-insensitive)\n- `type`: Filter by entity type\n- `limit`: Maximum results (default: 100, max: 1000)\n\nAt least one of `label` or `type` should be provided for meaningful results.\n\n---\n**Permission:** `collection:view`  \n**Auth:** optional",
        "x-arke-action": "collection:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "description": "Exact label to match (case-insensitive)",
              "example": "Captain Ahab"
            },
            "required": false,
            "name": "label",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "description": "Filter by entity type",
              "example": "person"
            },
            "required": false,
            "name": "type",
            "in": "query"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 1000,
              "default": 100,
              "description": "Maximum number of entities to return",
              "example": 100
            },
            "required": false,
            "name": "limit",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Matching entities",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CollectionEntityLookupResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "503": {
            "description": "Collection index service unavailable"
          }
        }
      }
    },
    "/collections/{id}/entities/search": {
      "get": {
        "tags": [
          "Collections"
        ],
        "summary": "Search entities by keyword or similarity",
        "description": "Search within a collection's entities using keyword matching or semantic similarity.\n\n**Keyword Search (q parameter):**\n- Fast (~5ms) using per-collection SQLite index\n- Case-insensitive substring match on entity labels\n\n**Semantic Similarity Search (similar_to parameter):**\n- Finds entities semantically similar to the given entity ID\n- Uses Pinecone vector similarity\n- Returns results with similarity scores\n\nOne of `q` or `similar_to` must be provided.\n\n**Query Parameters:**\n- `q`: Search query (case-insensitive substring match)\n- `similar_to`: Entity ID to find similar items for\n- `type`: Filter by entity type\n- `limit`: Maximum results (default: 100, max: 1000)\n\n---\n**Permission:** `collection:view`  \n**Auth:** optional",
        "x-arke-action": "collection:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "description": "Search query (case-insensitive substring match on label). Required if similar_to is not provided.",
              "example": "ahab"
            },
            "required": false,
            "name": "q",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID to find semantically similar items. Uses vector similarity instead of keyword search. Required if q is not provided.",
              "example": "01JQ3EQ3EG000000000000000"
            },
            "required": false,
            "name": "similar_to",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "description": "Filter by entity type",
              "example": "person"
            },
            "required": false,
            "name": "type",
            "in": "query"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 1000,
              "default": 100,
              "description": "Maximum number of entities to return",
              "example": 100
            },
            "required": false,
            "name": "limit",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Matching entities",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CollectionEntitySearchResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "503": {
            "description": "Collection index service unavailable"
          }
        }
      }
    },
    "/entities": {
      "post": {
        "tags": [
          "Entities"
        ],
        "summary": "Create a new entity",
        "description": "Creates a generic entity of any type. For type-specific validation, use type-specific endpoints.\n\n**Relationship Target Validation:**\nBy default, all relationship targets are validated to ensure they exist. Use `?validate_relationships=false` to skip this validation (useful for migrations or when targets will be created shortly after).\n\nRequests with more than 500 unique relationship targets are rejected when validation is enabled.\n\n---\n**Permission:** `entity:create`  \n**Auth:** required",
        "x-arke-action": "entity:create",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "enum": [
                "true",
                "false"
              ],
              "example": "true"
            },
            "required": false,
            "description": "Validate that relationship targets exist. Defaults to true for single entity operations, false for batch. When true, requests with >500 unique relationship targets are rejected.",
            "name": "validate_relationships",
            "in": "query"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateEntityRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Entity created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EntityCreatedResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/entities/batch": {
      "post": {
        "tags": [
          "Entities",
          "Batch"
        ],
        "summary": "Batch create entities",
        "description": "Creates multiple entities in a single request with bounded internal concurrency.\n\nEntities are created in chunks of 10 internally. Each entity follows the same permission model as single creates.\n\nReturns per-entity results. HTTP 201 if all succeed, 207 if some fail.\n\n**Max batch size:** 100 entities.\n\n**Relationship Target Validation:**\nBy default, relationship targets are NOT validated for batch creates. This is because intra-batch references are common (entity A references entity B, both created in the same batch). Use `?validate_relationships=true` to enable validation if needed.\n\n---\n**Permission:** `entity:create`  \n**Auth:** required",
        "x-arke-action": "entity:create",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "enum": [
                "true",
                "false"
              ],
              "example": "true"
            },
            "required": false,
            "description": "Validate that relationship targets exist. Defaults to true for single entity operations, false for batch. When true, requests with >500 unique relationship targets are rejected.",
            "name": "validate_relationships",
            "in": "query"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/BatchCreateEntityRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "All entities created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BatchCreateEntityResponse"
                }
              }
            }
          },
          "207": {
            "description": "Partial success - some entities failed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BatchCreateEntityResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          }
        }
      }
    },
    "/entities/batch-get": {
      "post": {
        "tags": [
          "Entities",
          "Batch"
        ],
        "summary": "Batch get entities by ID",
        "description": "Fetches multiple entities by ID in a single request.\n\nPermission is checked per-entity. Entities the caller cannot access are excluded from results and listed in `not_found`.\n\n**Use cases:**\n- Tree traversal: Expand multiple nodes at once\n- Workflow status: Fetch all log entries in a job\n- Relationship hydration: Fetch all peers of an entity\n\n**Max batch size:** 100 entities.\n\n---\n**Permission:** `entity:view`  \n**Auth:** optional",
        "x-arke-action": "entity:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/BatchGetRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Entities fetched",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BatchGetResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}": {
      "get": {
        "tags": [
          "Entities"
        ],
        "summary": "Get entity by ID",
        "description": "Returns any entity by ID. Permission check uses parent collection if entity belongs to one.\n\n**Relationship Expansion:**\n\nUse the `expand=relationships[:mode]` query parameter to hydrate relationship peer data:\n\n- **No expansion (default)**: Returns relationships with stored `peer_label`/`peer_type` (may be stale)\n  ```json\n  { \"predicate\": \"contains\", \"peer\": \"01KDOC...\", \"peer_label\": \"Old Label\" }\n  ```\n\n- **`?expand=relationships:preview`**: Adds `peer_preview` with fresh lightweight data (id, type, label, truncated description/text, timestamps)\n  ```json\n  {\n    \"predicate\": \"contains\",\n    \"peer\": \"01KDOC...\",\n    \"peer_label\": \"Old Label\",\n    \"peer_preview\": {\n      \"id\": \"01KDOC...\",\n      \"type\": \"document\",\n      \"label\": \"Updated Label\",\n      \"description_preview\": \"This is a document with...\",\n      \"created_at\": \"2025-01-15T10:00:00Z\",\n      \"updated_at\": \"2025-01-20T14:30:00Z\"\n    }\n  }\n  ```\n\n- **`?expand=relationships:full`**: Adds `peer_entity` with complete entity manifest (all properties, relationships, version history)\n  ```json\n  {\n    \"predicate\": \"contains\",\n    \"peer\": \"01KDOC...\",\n    \"peer_label\": \"Old Label\",\n    \"peer_entity\": {\n      \"id\": \"01KDOC...\",\n      \"cid\": \"bafyrei...\",\n      \"type\": \"document\",\n      \"properties\": { \"label\": \"Updated Label\", \"text\": \"...\" },\n      \"relationships\": [...],\n      \"ver\": 3,\n      \"created_at\": \"2025-01-15T10:00:00Z\",\n      \"ts\": 1737380000000,\n      \"edited_by\": { \"user_id\": \"01JUSER...\", \"method\": \"manual\" }\n    }\n  }\n  ```\n\n**Performance:** Preview expansion is recommended for most use cases. Full expansion with many large entities can result in multi-MB payloads.\n\n**Expansion Limit:**\nUse `?expand_limit=N` to control maximum relationships expanded (1-500, default 100). When truncated, the response includes `_expansion_metadata` with counts.\n\n---\n**Permission:** `entity:view`  \n**Auth:** optional",
        "x-arke-action": "entity:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "example": "relationships:preview"
            },
            "required": false,
            "description": "Comma-separated list of fields to expand. Supports: relationships[:preview|full]",
            "name": "expand",
            "in": "query"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 500,
              "example": 100
            },
            "required": false,
            "description": "Maximum number of relationships to expand (1-500, default 100). When exceeded, relationships beyond the limit are returned without peer data.",
            "name": "expand_limit",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Entity found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EntityResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      },
      "put": {
        "tags": [
          "Entities"
        ],
        "summary": "Update entity",
        "description": "Updates an entity with merge semantics. **This is the recommended way to manage relationships.**\n\n- `relationships_add`: Upsert relationships (properties are merged if relationship exists)\n- `relationships_remove`: Remove by predicate/peer\n- `properties`: Deep merged with existing\n- `properties_remove`: Remove nested properties using nested object structure\n\n**properties_remove syntax:**\n- Top-level keys: `[\"field1\", \"field2\"]`\n- Nested keys: `{ parent: { child: [\"key_to_remove\"] } }`\n- **Dot notation is NOT supported** - `[\"parent.child.key\"]` will NOT work\n\nExample to remove `config.options.debug`:\n```json\n{ \"properties_remove\": { \"config\": { \"options\": [\"debug\"] } } }\n```\n\nUse `/relationships` only for bidirectional links updating two entities atomically.\n\n**Relationship Target Validation:**\nBy default, new relationship targets in `relationships_add` are validated to ensure they exist. Use `?validate_relationships=false` to skip this validation.\n\nRequests with more than 500 unique relationship targets are rejected when validation is enabled.\n\nNote: entity:update on a collection requires collection:update permission.\n\n---\n**Permission:** `entity:update`  \n**Auth:** required",
        "x-arke-action": "entity:update",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "enum": [
                "true",
                "false"
              ],
              "example": "true"
            },
            "required": false,
            "description": "Validate that relationship targets exist. Defaults to true for single entity operations, false for batch. When true, requests with >500 unique relationship targets are rejected.",
            "name": "validate_relationships",
            "in": "query"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdateEntityRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Entity updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EntityUpdatedResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": [
          "Entities"
        ],
        "summary": "Delete entity",
        "description": "Soft-deletes an entity by creating a tombstone version. The entity can be restored later via POST /entities/:id/restore. Note: entity:delete on a collection requires collection:delete permission.\n\n---\n**Permission:** `entity:delete`  \n**Auth:** required",
        "x-arke-action": "entity:delete",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/DeleteEntityRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Entity deleted",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EntityDeletedResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}/preview": {
      "get": {
        "tags": [
          "Entities",
          "Advanced"
        ],
        "summary": "Get entity preview",
        "description": "Returns lightweight preview data for an entity. Useful for:\n- Link previews and hover cards\n- Relationship metadata freshness (vs stale peer_label)\n- AI context management (smaller payloads)\n- Search result enhancement\n\nReturns: id, type, label, collection_pi, description_preview (200 chars), text_preview (200 chars), timestamps.\n\n**Performance:** Single KV fetch, ~40-60ms response time, typically <1KB payload.\n\n---\n**Permission:** `entity:view`  \n**Auth:** optional",
        "x-arke-action": "entity:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Entity preview data",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EntityPreview"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}/tip": {
      "get": {
        "tags": [
          "Entities",
          "Advanced"
        ],
        "summary": "Get entity tip CID",
        "description": "Returns only the current manifest CID (tip) for an entity. Lightweight endpoint for CAS operations - single Durable Object lookup, no manifest fetch, no permission check.\n\n---\n**Permission:** `entity:tip`  \n**Auth:** none",
        "x-arke-action": "entity:tip",
        "x-arke-auth": "none",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Tip found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TipResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}/cascade": {
      "delete": {
        "tags": [
          "Entities",
          "Advanced"
        ],
        "summary": "Cascade delete entity and related entities",
        "description": "Deletes an entity and all related entities matching predicate patterns within a scoped collection.\n\n**Permission Model:**\n- Requires `entity:delete` permission on the specified `collection_id`\n- Single permission check at the start (not per-entity)\n- Individual entity type permissions are NOT checked during cascade\n\n**Cascade Rules:**\n- `collection` predicate NEVER cascades (hard rule - protects collection structure)\n- Only entities in the specified collection are deleted\n- Entities outside the collection are skipped (reported in `skipped` array)\n\n**Predicate Patterns:**\n- `\"child\"` - exact match only\n- `\"has_*\"` - matches has_document, has_image, etc.\n- `\"*_copy\"` - matches file_copy, document_copy, etc.\n- `\"*\"` - matches ALL predicates (except collection)\n\n**Traversal:**\n- BFS traversal with parallel processing per depth layer\n- Max depth: 20 (default: 10)\n- Optional `edited_by_filter` to only delete entities created by a specific actor (useful for agent cleanup)\n\n**CAS Handling:**\n- Root entity uses the provided `expect_tip`\n- Child entities use re-fetch + single retry strategy\n- CAS conflicts are reported as skipped (not failures)\n\n**Response:**\n- Lists all deleted entities with their depth from root\n- Lists skipped entities with reasons\n- Provides summary statistics\n\n---\n**Permission:** `entity:delete`  \n**Auth:** required",
        "x-arke-action": "entity:delete",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CascadeDeleteRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Cascade delete completed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CascadeDeleteResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}/restore": {
      "post": {
        "tags": [
          "Entities",
          "Advanced"
        ],
        "summary": "Restore deleted entity",
        "description": "Restores a deleted entity by finding the last non-deleted version and creating a new version from it. Note: entity:restore on a collection requires collection:restore permission.\n\n---\n**Permission:** `entity:restore`  \n**Auth:** required",
        "x-arke-action": "entity:restore",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RestoreEntityRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Entity restored",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EntityRestoredResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}/collection": {
      "get": {
        "tags": [
          "Entities",
          "Advanced"
        ],
        "summary": "Get entity collection",
        "description": "Returns the collection ID that this entity belongs to. Returns null if the entity is not in any collection. If the entity IS a collection, returns its own ID.\n\n---\n**Permission:** `entity:view`  \n**Auth:** optional",
        "x-arke-action": "entity:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Collection lookup result",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EntityCollectionResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}/tree": {
      "get": {
        "tags": [
          "Entities",
          "Advanced"
        ],
        "summary": "Get entity tree",
        "description": "Returns a hierarchical tree of entities reachable from the source entity.\n\nUse this to browse collections and folders without making multiple API calls.\nThe tree follows relationship edges (optionally filtered by predicate) and\nreturns a nested structure suitable for tree UI rendering.\n\nQuery parameters:\n- `depth`: Max tree depth (1-4, default 2)\n- `collection`: Constrain to entities in this collection\n- `predicates`: Comma-separated predicates to follow (e.g., \"contains\")\n- `limit`: Max nodes to return (default 100)\n\n---\n**Permission:** `entity:view`  \n**Auth:** optional",
        "x-arke-action": "entity:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 4,
              "default": 2,
              "description": "Maximum tree depth (1-4)",
              "example": 2
            },
            "required": false,
            "name": "depth",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Constrain results to entities in this collection",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": false,
            "name": "collection",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "description": "Comma-separated predicates to follow (e.g., \"contains,references\")",
              "example": "contains"
            },
            "required": false,
            "name": "predicates",
            "in": "query"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 1000,
              "default": 100,
              "description": "Maximum number of nodes to return",
              "example": 100
            },
            "required": false,
            "name": "limit",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Tree retrieved",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TreeResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}/diff": {
      "get": {
        "tags": [
          "Entities",
          "Advanced"
        ],
        "summary": "Get diff between entity versions",
        "description": "Computes the difference between two versions of an entity.\n\nQuery parameters:\n- `from`: CID of the \"from\" version (defaults to prev of \"to\" version)\n- `to`: CID of the \"to\" version (defaults to current tip)\n- `format`: Output format - \"semantic\" (default) or \"patch\" (RFC 6902)\n\nModes:\n- No params: Compare current tip with its previous version\n- `to` only: Compare that version with its prev\n- `from` only: Compare from that version to current tip\n- Both: Compare any two versions\n\nFor version 1 entities (no previous version), \"from\" is null and all content appears as added.\n\n---\n**Permission:** `entity:view`  \n**Auth:** optional",
        "x-arke-action": "entity:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "description": "Content Identifier (CID) - content-addressed hash",
              "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
            },
            "required": false,
            "description": "CID of the \"from\" version. Defaults to prev of \"to\" version.",
            "name": "from",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "description": "Content Identifier (CID) - content-addressed hash",
              "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
            },
            "required": false,
            "description": "CID of the \"to\" version. Defaults to current tip.",
            "name": "to",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "enum": [
                "semantic",
                "patch"
              ],
              "default": "semantic"
            },
            "required": false,
            "description": "Output format: \"semantic\" (default) or \"patch\" (RFC 6902)",
            "name": "format",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Diff computed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DiffResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}/permissions": {
      "get": {
        "tags": [
          "Entities",
          "Advanced"
        ],
        "summary": "Get your permissions for an entity",
        "description": "Returns the list of actions you can perform on this entity.\n\nThe response includes:\n- `allowed_actions`: Concrete actions you can perform (no wildcards)\n- `resolution`: How permissions were determined\n\nResolution methods:\n- `collection`: Permissions from your role in the parent collection\n- `self`: You are checking your own user entity (self-ownership)\n- `open_season`: Entity is not in any collection (publicly accessible)\n\nActions are filtered to only those relevant to the entity type:\n- For files: entity:* and file:* actions\n- For collections: entity:* and collection:* actions\n- etc.\n\n---\n**Permission:** `entity:view`  \n**Auth:** required",
        "x-arke-action": "entity:view",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Permissions retrieved",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EntityPermissionsResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}/content": {
      "post": {
        "tags": [
          "Entities"
        ],
        "summary": "Upload content for any entity",
        "description": "Uploads binary content for any entity type. Any entity can have content attached.\n\n**Request:**\n- Query param `key` (required): Version key for this content (e.g., \"v1\", \"original\", \"thumbnail\")\n- Query param `filename` (optional): Filename for Content-Disposition header on download\n- Header `Content-Type`: MIME type of the content (required)\n- Header `Content-Length`: Size for pre-upload validation (optional, max 500MB)\n- Body: Binary content (streaming supported)\n\n**Behavior:**\n- Streams content directly to R2 storage\n- Computes CID from content bytes\n- Updates entity with `properties.content` metadata\n- Re-uploading with same key overwrites the content\n- Creates a new entity version on each upload\n\n**Storage:**\nContent is stored at `{entity_id}/{cid}` in R2, enabling multiple versions per entity without overwriting.\n\n---\n**Permission:** `entity:update`  \n**Auth:** required",
        "x-arke-action": "entity:update",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "maxLength": 255,
              "description": "Version key for this content (e.g., \"v1\", \"original\", \"thumbnail\")",
              "example": "v1"
            },
            "required": true,
            "name": "key",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "maxLength": 255,
              "description": "Filename for Content-Disposition header on download",
              "example": "document.pdf"
            },
            "required": false,
            "name": "filename",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Content uploaded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UploadContentResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          },
          "413": {
            "description": "Content too large (max 500 MB)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                }
              }
            }
          }
        }
      },
      "get": {
        "tags": [
          "Entities"
        ],
        "summary": "Download content for any entity",
        "description": "Downloads binary content for any entity type.\n\n**Query Parameters:**\n- `key` (optional): Specific version key to download. Default: current content key from entity\n\n**Response Headers:**\n- `Content-Type`: MIME type of the content\n- `Content-Length`: Content size in bytes\n- `Content-Disposition`: attachment; filename=\"...\" (if filename was set)\n\n**Streaming:**\nResponse is streamed directly from R2 storage for efficient large file handling.\n\n---\n**Permission:** `entity:view`  \n**Auth:** optional",
        "x-arke-action": "entity:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "description": "Content key to download (resolved to CID from entity metadata)",
              "example": "v1"
            },
            "required": false,
            "name": "key",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "description": "Direct CID to download (alternative to key)",
              "example": "bafyreih5iy6dqwbcslkqpx6bxwj7qy3z5x..."
            },
            "required": false,
            "name": "cid",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Content downloaded",
            "content": {
              "application/octet-stream": {
                "schema": {
                  "type": "string",
                  "format": "binary"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": [
          "Entities"
        ],
        "summary": "Remove content by key or CID",
        "description": "Removes content metadata from entity. The actual file in R2 is preserved for version history.\n\n**Query Parameters (one required):**\n- `key`: Content key to remove\n- `cid`: Content CID to remove (alternative to key)\n- `expect_tip`: Current entity tip CID for CAS protection (required)\n\n**Behavior:**\n- Removes the content entry from the content map\n- R2 file is NOT deleted (preserved for version history)\n- Returns 404 if content not found\n- If CID matches multiple keys, returns error (specify key instead)\n\n**Examples:**\n```\nDELETE /entities/{id}/content?key=thumbnail&expect_tip=bafyrei...\nDELETE /entities/{id}/content?cid=bafyrei...&expect_tip=bafyrei...\n```\n\n---\n**Permission:** `entity:update`  \n**Auth:** required",
        "x-arke-action": "entity:update",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "maxLength": 255,
              "description": "Content key to remove",
              "example": "thumbnail"
            },
            "required": false,
            "name": "key",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "description": "Content CID to remove (alternative to key)",
              "example": "bafyreih5iy6dqwbcslkqpx6bxwj7qy3z5x..."
            },
            "required": false,
            "name": "cid",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "description": "Expected current tip CID for CAS protection",
              "example": "bafyrei..."
            },
            "required": true,
            "name": "expect_tip",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Content removed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DeleteContentResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          }
        }
      },
      "patch": {
        "tags": [
          "Entities"
        ],
        "summary": "Rename content key",
        "description": "Renames a content key without moving the underlying R2 file.\n\nSince content is stored by CID, renaming a key is a metadata-only operation.\nThe R2 file remains at `{entityId}/{cid}` and is unaffected.\n\n**Use Cases:**\n- Renaming `v1` to `original` for semantic clarity\n- Reorganizing content keys without re-uploading\n\n**Note:** This does not change the filename property. Use entity update for that.\n\n---\n**Permission:** `entity:update`  \n**Auth:** required",
        "x-arke-action": "entity:update",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RenameContentKeyRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Content key renamed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RenameContentKeyResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}/content/upload-url": {
      "post": {
        "tags": [
          "Entities"
        ],
        "summary": "Get presigned URL for direct upload",
        "description": "Returns a presigned URL for direct upload to R2 storage, bypassing the API worker.\n\n**When to use:**\n- Files larger than 5MB (avoids streaming through API worker)\n- Client has reliable network (single PUT request to R2)\n- Parallel uploads (get multiple URLs, upload in parallel, complete sequentially)\n\n**Flow:**\n1. Compute CID client-side (hash the file content)\n2. Call this endpoint with the CID to get presigned URL\n3. PUT file directly to the returned URL (include Content-Type header)\n4. Call POST /{id}/content/complete to finalize (this is where key/filename are specified)\n\n**Parallel uploads:**\nFor multiple files, steps 1-3 can be parallelized. Only step 4 (complete) must be\nsequential with CAS retry to update entity metadata atomically.\n\n**Presigned URL:**\n- Valid for 15 minutes\n- R2 path is content-addressed: {entityId}/{cid}\n- Must include Content-Type header matching the request\n\n**Security:**\nThe presigned URL is the access control - it's signed and time-limited.\nWithout a valid URL from this endpoint, uploads to R2 will fail.\n\n**Note:** The CID is computed client-side and trusted. For guaranteed integrity,\nuse the direct upload endpoint (POST /{id}/content) which computes CID server-side.\n\n---\n**Permission:** `entity:update`  \n**Auth:** required",
        "x-arke-action": "entity:update",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/GetUploadUrlRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Presigned URL generated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GetUploadUrlResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}/content/complete": {
      "post": {
        "tags": [
          "Entities"
        ],
        "summary": "Complete presigned URL upload",
        "description": "Finalizes a presigned URL upload by updating entity metadata.\n\n**Prerequisites:**\n1. Called POST /{id}/content/upload-url to get presigned URL\n2. Uploaded file directly to R2 via presigned URL\n3. Computed CID client-side\n\n**Request:**\n- `key`: Same key used in upload-url request\n- `cid`: Content-addressed identifier computed by client\n- `size`: Actual file size in bytes\n- `content_type`: MIME type of uploaded content\n- `expect_tip`: Current entity tip for CAS protection\n\n**Behavior:**\n- Verifies file exists in R2 at expected location\n- Updates entity with content metadata\n- Creates new entity version\n\n**CID Trust:**\nThe client-provided CID is trusted without server verification.\nFor guaranteed integrity, use direct upload (POST /{id}/content).\n\n---\n**Permission:** `entity:update`  \n**Auth:** required",
        "x-arke-action": "entity:update",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CompleteUploadRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Upload completed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CompleteUploadResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/updates/queue/{id}": {
      "get": {
        "tags": [
          "Entities",
          "Diagnostics"
        ],
        "summary": "Get update queue status for entity",
        "description": "Returns the status of the additive update queue for a specific entity.\n\n**Use Cases:**\n- Diagnose why additive updates may not have been applied\n- Check for pending, processing, or failed updates\n- Monitor queue processing progress\n\n**Response includes:**\n- Counts by status (pending, processing, failed)\n- Detailed items with actor, relationships count, error messages, attempts\n\n\n---\n**Permission:** `entity:view`  \n**Auth:** required",
        "x-arke-action": "entity:view",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Queue status retrieved",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/QueueStatusResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          }
        }
      }
    },
    "/updates/additive": {
      "post": {
        "tags": [
          "Entities",
          "Batch"
        ],
        "summary": "Queue additive updates (fire-and-forget)",
        "description": "Queues additive updates for multiple entities. Returns 202 Accepted immediately.\n\n**Fire-and-Forget Semantics:**\n- Updates are queued and processed asynchronously\n- CAS conflicts are handled internally with exponential backoff retry\n- Client does not need to retry on conflicts\n\n**Additive-Only Operations:**\n- `properties`: Deep merged with existing properties\n- `relationships_add`: Upsert semantics (add new or merge properties)\n- `properties_remove` and `relationships_remove` are **NOT supported** - use `PUT /entities/:id` for removals\n\n**Per-Actor Versioning:**\n- Multiple updates from the same actor are merged before applying (one version)\n- Updates from different actors create separate versions (preserves audit trail)\n\n**Use Cases:**\n- Many workers adding relationships to a shared parent entity\n- High-volume indexing where multiple sources enrich the same entity\n- Any scenario where ordering doesn't matter and CAS conflicts are expected\n\n**Max batch size:** 100 updates per request.\n\n---\n**Permission:** `entity:update`  \n**Auth:** required",
        "x-arke-action": "entity:update",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/AdditiveUpdatesRequest"
              }
            }
          }
        },
        "responses": {
          "202": {
            "description": "Updates accepted for processing",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AdditiveUpdatesResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          }
        }
      }
    },
    "/versions/{id}": {
      "get": {
        "tags": [
          "Versions"
        ],
        "summary": "List version history",
        "description": "Returns version metadata for an entity (newest first). Use pagination for entities with many versions.\n\n---\n**Permission:** `entity:view`  \n**Auth:** optional",
        "x-arke-action": "entity:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 10,
              "default": 10,
              "example": 10
            },
            "required": false,
            "description": "Maximum versions to return (1-10, default 10)",
            "name": "limit",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "description": "Content Identifier (CID) - content-addressed hash",
              "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
            },
            "required": false,
            "description": "CID to start from (for pagination)",
            "name": "from",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Version list",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/VersionListResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/versions/manifest/{cid}": {
      "get": {
        "tags": [
          "Versions"
        ],
        "summary": "Get manifest by CID",
        "description": "Returns the full manifest for any version by its CID. Permission is checked against the entity ID in the manifest.\n\n---\n**Permission:** `entity:view`  \n**Auth:** optional",
        "x-arke-action": "entity:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "description": "Content Identifier (CID) - content-addressed hash",
              "example": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy"
            },
            "required": true,
            "description": "IPFS Content Identifier (CID) of the manifest",
            "name": "cid",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Manifest found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ManifestResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/permissions": {
      "get": {
        "tags": [
          "Permissions"
        ],
        "summary": "Get permission system metadata",
        "description": "Returns all registered actions, verbs, types, verb implications, wildcard patterns, and default roles.\n\nThis endpoint is useful for:\n- Building dynamic role editors\n- Understanding available permissions\n- Validating actions client-side\n\nAll data is auto-generated from the actual permission system, so it's always in sync with the code.\n\n---\n**Permission:** `permissions:read`  \n**Auth:** none",
        "x-arke-action": "permissions:read",
        "x-arke-auth": "none",
        "x-arke-tier": "standard",
        "responses": {
          "200": {
            "description": "Permission system metadata",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PermissionsResponse"
                }
              }
            }
          }
        }
      }
    },
    "/kladoi": {
      "post": {
        "tags": [
          "Kladoi"
        ],
        "summary": "Create a klados",
        "description": "Creates a new klados entity. Requires klados:create permission in the target collection.\n\n---\n**Permission:** `klados:create`  \n**Auth:** required",
        "x-arke-action": "klados:create",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateKladosRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Klados created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/KladosResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/kladoi/{id}": {
      "get": {
        "tags": [
          "Kladoi"
        ],
        "summary": "Get klados by ID",
        "description": "Returns a klados entity by ID.\n\n---\n**Permission:** `klados:view`  \n**Auth:** optional",
        "x-arke-action": "klados:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Klados found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/KladosResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      },
      "put": {
        "tags": [
          "Kladoi"
        ],
        "summary": "Update klados",
        "description": "Updates a klados. Requires klados:update permission.\n\n**Endpoint verification rules:**\n- Changing `endpoint` clears `endpoint_verified_at` and resets status to 'development'\n- Setting `status: 'active'` requires `endpoint_verified_at` to be set\n\n---\n**Permission:** `klados:update`  \n**Auth:** required",
        "x-arke-action": "klados:update",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdateKladosRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Klados updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/KladosUpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/kladoi/{id}/invoke": {
      "post": {
        "tags": [
          "Kladoi"
        ],
        "summary": "Invoke a klados",
        "description": "Invoke a klados to perform work on a target entity.\n\n**Two-phase interaction:**\n1. `confirm: false` (default) - preview permissions that will be granted\n2. `confirm: true` - execute the klados\n\nThe klados receives temporal (time-limited) permissions on the target collection.\n\n---\n**Permission:** `klados:invoke`  \n**Auth:** required",
        "x-arke-action": "klados:invoke",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/InvokeKladosRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Invoke preview (confirm: false)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InvokeKladosPreviewResponse"
                }
              }
            }
          },
          "202": {
            "description": "Klados execution started (confirm: true)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InvokeKladosConfirmedResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/kladoi/{id}/verify": {
      "post": {
        "tags": [
          "Kladoi"
        ],
        "summary": "Verify klados endpoint ownership",
        "description": "Verify that you control the klados's endpoint URL. This is required before activating a klados.\n\n**Two-phase flow:**\n1. Call without `confirm` to get a verification token\n2. Deploy `/.well-known/arke-verification` endpoint returning the token\n3. Call with `confirm: true` to complete verification\n\n**Verification endpoint format:**\nYour endpoint must return JSON:\n```json\n{\n  \"verification_token\": \"vt_xxx...\",\n  \"klados_id\": \"01xxx...\"\n}\n```\n\n---\n**Permission:** `klados:manage`  \n**Auth:** required",
        "x-arke-action": "klados:manage",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/VerifyKladosRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Verification token (when confirm is false) or verification result (when confirm is true)",
            "content": {
              "application/json": {
                "schema": {
                  "anyOf": [
                    {
                      "$ref": "#/components/schemas/VerifyKladosTokenResponse"
                    },
                    {
                      "$ref": "#/components/schemas/VerifyKladosSuccessResponse"
                    },
                    {
                      "$ref": "#/components/schemas/VerifyKladosFailureResponse"
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/kladoi/{id}/reinvoke": {
      "post": {
        "tags": [
          "Kladoi"
        ],
        "summary": "Reinvoke a failed klados job",
        "description": "Retry a failed klados job by extracting the original invocation from the error log and re-invoking.\n\n**Requirements:**\n- The log file must be a klados_log with `status: error`\n- The log must contain `received.invocation` with the original request\n- The klados ID in the log must match the route parameter\n\n**What happens:**\n1. Extracts the original `KladosRequest` from `received.invocation.request`\n2. Generates a new `job_id`\n3. Updates `rhiza_context.parent_logs` to point to the failed log (for audit trail)\n4. Invokes the klados with fresh `expires_at`\n\nThe new job's log will point back to the failed log, preserving the complete retry history.\n\n---\n**Permission:** `klados:invoke`  \n**Auth:** required",
        "x-arke-action": "klados:invoke",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ReinvokeKladosRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Reinvoke result (rejected by klados)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ReinvokeKladosResponse"
                }
              }
            }
          },
          "202": {
            "description": "Reinvoke started (klados accepted)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ReinvokeKladosResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/kladoi/{id}/keys": {
      "post": {
        "tags": [
          "Kladoi"
        ],
        "summary": "Create API key for klados",
        "description": "Creates an API key for the klados. The full key is only returned once.\n\n---\n**Permission:** `klados:manage`  \n**Auth:** required",
        "x-arke-action": "klados:manage",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateKladosApiKeyRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "API key created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CreateKladosApiKeyResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      },
      "get": {
        "tags": [
          "Kladoi"
        ],
        "summary": "List API keys for klados",
        "description": "Lists all active API keys for the klados (without the actual key values).\n\n---\n**Permission:** `klados:manage`  \n**Auth:** required",
        "x-arke-action": "klados:manage",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "API keys listed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ListKladosApiKeysResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/kladoi/{id}/keys/{prefix}": {
      "delete": {
        "tags": [
          "Kladoi"
        ],
        "summary": "Revoke API key",
        "description": "Revokes an API key for the klados.\n\n---\n**Permission:** `klados:manage`  \n**Auth:** required",
        "x-arke-action": "klados:manage",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 4,
              "maxLength": 12,
              "description": "API key prefix (e.g., ak_xKj9)",
              "example": "ak_xKj9"
            },
            "required": true,
            "name": "prefix",
            "in": "path"
          }
        ],
        "responses": {
          "204": {
            "description": "API key revoked"
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/rhizai": {
      "post": {
        "tags": [
          "Rhizai"
        ],
        "summary": "Create a rhiza workflow",
        "description": "Creates a new rhiza workflow entity. Requires rhiza:create permission in the target collection.\n\n**Flow validation:**\n- Entry klados must be in flow\n- All flow targets must be in flow (or external rhiza refs)\n- All paths must terminate (done: true or external target)\n- No cycles allowed\n\n---\n**Permission:** `rhiza:create`  \n**Auth:** required",
        "x-arke-action": "rhiza:create",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateRhizaRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Rhiza created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RhizaResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/rhizai/{id}": {
      "get": {
        "tags": [
          "Rhizai"
        ],
        "summary": "Get rhiza by ID",
        "description": "Returns a rhiza entity by ID.\n\n---\n**Permission:** `rhiza:view`  \n**Auth:** optional",
        "x-arke-action": "rhiza:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Rhiza found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RhizaResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      },
      "put": {
        "tags": [
          "Rhizai"
        ],
        "summary": "Update rhiza",
        "description": "Updates a rhiza. Requires rhiza:update permission.\n\n---\n**Permission:** `rhiza:update`  \n**Auth:** required",
        "x-arke-action": "rhiza:update",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdateRhizaRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Rhiza updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RhizaUpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "409": {
            "description": "Conflict - CAS validation failed (entity was modified)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CASErrorResponse"
                },
                "example": {
                  "error": "Conflict: entity was modified",
                  "details": {
                    "expected": "bafyreibug443cnd4endcwinwttw3c3dzmcl2ikht64xzn5qg56bix3usfy",
                    "actual": "bafyreinewabc123456789defghijklmnopqrstuvwxyz"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/rhizai/{id}/invoke": {
      "post": {
        "tags": [
          "Rhizai"
        ],
        "summary": "Invoke a rhiza workflow",
        "description": "Invoke a rhiza workflow to process a target entity.\n\n**Two-phase interaction:**\n1. `confirm: false` (default) - preview permissions for all kladoi\n2. `confirm: true` - execute the workflow\n\nAll kladoi in the workflow receive temporal (time-limited) permissions.\n\n---\n**Permission:** `rhiza:invoke`  \n**Auth:** required",
        "x-arke-action": "rhiza:invoke",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/InvokeRhizaRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Invoke preview (confirm: false)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InvokeRhizaPreviewResponse"
                }
              }
            }
          },
          "202": {
            "description": "Workflow execution started (confirm: true)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InvokeRhizaConfirmedResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/rhizai/{id}/jobs/{job_id}/status": {
      "get": {
        "tags": [
          "Rhizai"
        ],
        "summary": "Get workflow job status",
        "description": "Returns the status of a workflow job.\n\nReads klados_log entries from the job collection to compute:\n- Overall status (pending/running/done/error)\n- Progress counters\n- Current running kladoi\n- Error summaries\n\n---\n**Permission:** `rhiza:view`  \n**Auth:** optional",
        "x-arke-action": "rhiza:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Rhiza entity ID"
            },
            "required": true,
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "description": "Job ID returned from rhiza invocation",
              "example": "job_01KFXPQ3ABCDEFGHIJKLMN"
            },
            "required": true,
            "name": "job_id",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Workflow status",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WorkflowStatusResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/rhizai/{id}/jobs/{job_id}/resume": {
      "post": {
        "tags": [
          "Rhizai"
        ],
        "summary": "Resume failed workflow",
        "description": "Resume a workflow by re-invoking failed kladoi that have retryable errors.\n\nOnly retryable errors are resumed. Non-retryable errors are skipped.\n\n---\n**Permission:** `rhiza:invoke`  \n**Auth:** required",
        "x-arke-action": "rhiza:invoke",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Rhiza entity ID"
            },
            "required": true,
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "description": "Job ID returned from rhiza invocation",
              "example": "job_01KFXPQ3ABCDEFGHIJKLMN"
            },
            "required": true,
            "name": "job_id",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ResumeWorkflowRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Resume result",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ResumeWorkflowResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/events": {
      "get": {
        "tags": [
          "Events"
        ],
        "summary": "List entity change events",
        "description": "Returns a cursor-based list of entity change events for client synchronization.\n\n**Usage:**\n- Call without cursor to get newest events\n- Use returned `cursor` as `?cursor=` to get older events\n- Poll without cursor periodically to check for new events\n\n**Sync flow:**\n1. Initial: `GET /events`  get newest, save highest `id` as high-water mark\n2. Paginate: `GET /events?cursor=X`  get older events until `has_more=false`\n3. Poll: `GET /events`  if newest `id` > high-water mark, process new events\n\n**Event data:**\n- `id`: Auto-increment ID\n- `entity_id`: Entity ID that changed\n- `cid`: New manifest CID\n- `ts`: ISO timestamp\n\nEvents are ephemeral (30-day rolling window) - for full sync, use snapshots.\n\n---\n**Permission:** `events:list`  \n**Auth:** none",
        "x-arke-action": "events:list",
        "x-arke-auth": "none",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "example": 12345
            },
            "required": false,
            "description": "Return events older than this id (from previous response cursor)",
            "name": "cursor",
            "in": "query"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 1000,
              "example": 100
            },
            "required": false,
            "description": "Maximum number of events to return (default: 100, max: 1000)",
            "name": "limit",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "enum": [
                "main",
                "test"
              ],
              "example": "main"
            },
            "required": false,
            "description": "Network to query (default: main)",
            "name": "network",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Events list",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EventsListResponse"
                }
              }
            }
          }
        }
      }
    },
    "/graph/paths": {
      "post": {
        "tags": [
          "Graph"
        ],
        "summary": "Find paths between entities",
        "description": "Find shortest paths between source and target entity sets. Returns all paths up to the limit (default 100).\n\nUse this when you know both endpoints and want to discover how they connect - for example, finding the chain of relationships between a person and a document.\n\n**Entity Expansion (default: preview):**\n- Omit `expand` or use `?expand=preview` - Lightweight previews for all path entities\n- `?expand=full` - Complete entity manifests (use with caution)\n- `?expand=none` - Disable expansion (graph metadata only)\n\n**Performance Warning:** 100 paths can reference 400-800 unique entities, adding 5-10s latency with expansion.\n\n**Recommendations:**\n- Use `limit: 10-20` when using expansion\n- Prefer preview over full\n- Use `expand=none` for large result sets, then fetch specific entities separately\n\n---\n**Permission:** `graph:query`  \n**Auth:** required",
        "x-arke-action": "graph:query",
        "x-arke-auth": "required",
        "x-arke-tier": "external",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "enum": [
                "preview",
                "full",
                "none"
              ],
              "example": "preview"
            },
            "required": false,
            "description": "Entity expansion mode. Omit for preview (default), \"full\" for complete manifests, \"none\" to disable",
            "name": "expand",
            "in": "query"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PathsBetweenRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Paths found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PathsBetweenResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          }
        }
      }
    },
    "/graph/reachable": {
      "post": {
        "tags": [
          "Graph"
        ],
        "summary": "Find reachable entities (exhaustive)",
        "description": "Find all entities of a specific type reachable from source entities within N hops. Returns up to 100 results by default.\n\n**When to use this vs POST /query:** This endpoint returns exhaustive, unranked results - all reachable entities up to the limit. Use `POST /query` when you want relevance-ranked results combining semantic similarity with graph structure. Use this endpoint when you need comprehensive graph exploration from known entity IDs.\n\n**Target Expansion (default: preview):**\n- Omit `expand` or use `?expand=preview` - Lightweight target previews\n- `?expand=full` - Complete target manifests\n- `?expand=none` - Disable expansion (graph metadata only)\n\n**Performance:** With 100 targets, expansion adds ~1s.\n\n---\n**Permission:** `graph:query`  \n**Auth:** required",
        "x-arke-action": "graph:query",
        "x-arke-auth": "required",
        "x-arke-tier": "external",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "enum": [
                "preview",
                "full",
                "none"
              ],
              "example": "preview"
            },
            "required": false,
            "description": "Entity expansion mode. Omit for preview (default), \"full\" for complete manifests, \"none\" to disable",
            "name": "expand",
            "in": "query"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PathsReachableRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Reachable entities found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PathsReachableResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          }
        }
      }
    },
    "/graph/entity/{id}": {
      "get": {
        "tags": [
          "Graph"
        ],
        "summary": "Get entity from graph",
        "description": "Get entity details with all relationships from the graph database. Unlike the entity manifest, this includes both outgoing and incoming relationships - showing not just what this entity links to, but also what links to it.\n\n**Peer Expansion (default: preview):**\n- Omit `expand` or use `?expand=preview` - Lightweight peer previews\n- `?expand=full` - Complete peer manifests\n- `?expand=none` - Disable expansion (graph metadata only)\n\n**Performance:** With 50 peers, expansion adds ~500ms.\n\n---\n**Permission:** `graph:query`  \n**Auth:** required",
        "x-arke-action": "graph:query",
        "x-arke-auth": "required",
        "x-arke-tier": "external",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "string",
              "enum": [
                "preview",
                "full",
                "none"
              ],
              "example": "preview"
            },
            "required": false,
            "description": "Entity expansion mode. Omit for preview (default), \"full\" for complete manifests, \"none\" to disable",
            "name": "expand",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Entity found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GraphEntityResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/query": {
      "post": {
        "tags": [
          "Query"
        ],
        "summary": "Execute Argo query",
        "description": "Execute an Argo DSL query for path-based graph traversal with relevance ranking.\n\n## When to Use This Endpoint\n\n| Endpoint | Use Case |\n|----------|----------|\n| `POST /query` | Semantic search + graph traversal with **relevance-ranked** results (default k=25) |\n| `POST /graph/reachable` | **Exhaustive** graph exploration from known entities (default limit=100) |\n| `POST /graph/paths` | Find all shortest paths between two entity sets |\n\nThis endpoint combines semantic similarity scores with path length to rank results. For exhaustive graph traversal without ranking, use the `/graph/*` endpoints directly.\n\n## Query Syntax\n\n```\n[SCOPE_PREFIX] ENTRY_POINT [ENTRY_FILTER] [-[RELATION]{DEPTH}-> TARGET_FILTER]...\n```\n\n## Scope Prefixes\n\nControl where semantic search looks for entry points. Default is discovery mode.\n\n| Prefix | Description | Example |\n|--------|-------------|---------|\n| (none) | **Discovery mode** (default) - find relevant collections, then search within each | `\"medical notes\"` |\n| `@:collections` | Search for collections themselves | `@:collections \"columbia archives\"` |\n| `@:collection(id)` | Search within a specific collection | `@:collection(01JCOLL123) \"meeting\"` |\n| `@:discover` | Explicit discovery mode | `@:discover \"research papers\"` |\n| `@:public` | Search public domain only | `@:public \"orphaned data\"` |\n\n**Note:** Graph traversal (hops) is always cross-collection regardless of scope.\n\n### Entry Points\n\n| Syntax | Description | Example |\n|--------|-------------|---------|\n| `\"text\"` | Semantic search | `\"george washington\"` |\n| `@id` | Exact entity ID | `@01KE4ZY69F9R40E88PK9S0TQRQ` |\n| `type:X` | All entities of type | `type:person` |\n| `type:X ~ \"text\"` | Semantic search within type | `type:person ~ \"physician\"` |\n\n### Edges (Hops)\n\n| Syntax | Direction |\n|--------|-----------|\n| `-[*]->` | Outgoing |\n| `<-[*]-` | Incoming |\n| `<-[*]->` | Both |\n| `-[*]{,4}->` | Variable depth (1-4) |\n\n### Examples\n\n```\n\"george washington\"                           # Discovery mode (default)\n@:collections \"columbia university\"           # Find collections\n@:collection(01JCOLL123) \"faculty meeting\"    # Within specific collection\n@:discover \"alice\" -[*]{,2}-> type:person     # Discover, then traverse\n@01KE4ZY... -[*]{,2}-> type:person            # From exact entity\n```\n\n## Entity Expansion\n\nControl how much entity data is included in results via the `expand` parameter.\n\n| Value | Description | Use Case |\n|-------|-------------|----------|\n| (omitted) | **Preview** (default) - lightweight preview data | Best balance of detail and payload size |\n| `preview` | Same as omitted - lightweight preview data | Explicit preview mode |\n| `full` | Complete entity manifest | When you need all properties, relationships, versions |\n| `none` | No expansion - Pinecone metadata only | Fastest response, smallest payload |\n\n**Preview mode** includes: label, truncated description/text (200 chars), created_at, updated_at.\n\n**Full mode** includes: all properties, relationships, version info, CID.\n\nBoth result entities and path step entities are expanded.\n\n\n---\n**Permission:** `query:execute`  \n**Auth:** required",
        "x-arke-action": "query:execute",
        "x-arke-auth": "required",
        "x-arke-tier": "external",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/QueryRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Query executed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/QueryResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          }
        }
      }
    },
    "/search/similar/collections": {
      "post": {
        "tags": [
          "Search"
        ],
        "summary": "Find similar collections",
        "description": "Find collections that are semantically similar to a given collection.\n\nUses the collection's weighted centroid vector (combination of description and entity embeddings) to find related collections.\n\n**Entity Expansion:**\n\nUse `expand` in the request body to fetch entity data inline with search results:\n\n- **`expand: \"preview\"` (default)**: Adds `entity_preview` with fresh lightweight data (id, type, label, timestamps)\n- **`expand: \"full\"`**: Adds `entity` with complete manifest including all properties and relationships\n- **`expand: \"none\"`**: Returns search metadata only (fastest, lowest bandwidth)\n\nPreview mode is recommended for most use cases. Full expansion can result in large payloads.\nGracefully handles deleted or inaccessible entities (returns results without expansion data).\n\n---\n**Permission:** `search:similar`  \n**Auth:** required",
        "x-arke-action": "search:similar",
        "x-arke-auth": "required",
        "x-arke-tier": "external",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "id": {
                    "type": "string",
                    "description": "Collection ID to find similar collections for"
                  },
                  "limit": {
                    "type": "number",
                    "minimum": 1,
                    "maximum": 100,
                    "default": 10,
                    "description": "Maximum results to return"
                  },
                  "refresh": {
                    "type": "boolean",
                    "default": false,
                    "description": "Force fresh query, bypassing cache"
                  },
                  "expand": {
                    "type": "string",
                    "enum": [
                      "preview",
                      "full",
                      "none"
                    ],
                    "description": "Entity expansion mode. Default: \"preview\" for lightweight previews, \"full\" for complete manifests, \"none\" for no expansion.",
                    "example": "preview"
                  }
                },
                "required": [
                  "id"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Similar collections found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "label": {
                            "type": "string"
                          },
                          "score": {
                            "type": "number"
                          },
                          "created_at": {
                            "type": "string"
                          },
                          "updated_at": {
                            "type": "string"
                          },
                          "entity_preview": {
                            "allOf": [
                              {
                                "$ref": "#/components/schemas/EntityPreview"
                              },
                              {
                                "description": "Lightweight entity preview (included by default)",
                                "example": {
                                  "id": "01KCOLLECTION123456789ABCD",
                                  "type": "collection",
                                  "label": "Research Papers Collection",
                                  "description_preview": "A curated collection of academic research papers...",
                                  "created_at": "2026-01-10T00:00:00.000Z",
                                  "updated_at": "2026-01-15T12:00:00.000Z"
                                }
                              }
                            ]
                          },
                          "entity": {
                            "allOf": [
                              {
                                "$ref": "#/components/schemas/EntityResponse"
                              },
                              {
                                "description": "Full entity manifest (when expand: \"full\")"
                              }
                            ]
                          }
                        },
                        "required": [
                          "id",
                          "label",
                          "score"
                        ]
                      }
                    },
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "source_id": {
                          "type": "string"
                        },
                        "result_count": {
                          "type": "number"
                        },
                        "cached": {
                          "type": "boolean"
                        },
                        "cached_at": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "source_id",
                        "result_count"
                      ]
                    }
                  },
                  "required": [
                    "results",
                    "metadata"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "503": {
            "description": "Service Unavailable - External service not available",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Service unavailable",
                  "details": {
                    "service": "pinecone"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/search/similar/items": {
      "post": {
        "tags": [
          "Search"
        ],
        "summary": "Find similar items across collections",
        "description": "Find entities that are semantically similar to a given entity, searching across multiple collections.\n\nThis performs a two-tier search:\n1. First finds collections similar to the entity's collection\n2. Then searches within each collection for similar items\n3. Aggregates and ranks results with diversity weighting\n\n**Entity Expansion:**\n\nUse `expand` in the request body to fetch entity data inline with search results:\n\n- **`expand: \"preview\"` (default)**: Adds `entity_preview` with fresh lightweight data (id, type, label, timestamps)\n- **`expand: \"full\"`**: Adds `entity` with complete manifest including all properties and relationships\n- **`expand: \"none\"`**: Returns search metadata only (fastest, lowest bandwidth)\n\nPreview mode is recommended for most use cases. Full expansion can result in large payloads.\nGracefully handles deleted or inaccessible entities (returns results without expansion data).\n\n---\n**Permission:** `search:similar`  \n**Auth:** required",
        "x-arke-action": "search:similar",
        "x-arke-auth": "required",
        "x-arke-tier": "external",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "id": {
                    "type": "string",
                    "description": "Entity ID to find similar items for"
                  },
                  "collection_id": {
                    "type": "string",
                    "description": "Entity's collection ID"
                  },
                  "limit": {
                    "type": "number",
                    "minimum": 1,
                    "maximum": 100,
                    "default": 20,
                    "description": "Maximum results to return"
                  },
                  "tier1_limit": {
                    "type": "number",
                    "minimum": 1,
                    "maximum": 50,
                    "default": 10,
                    "description": "Number of similar collections to search"
                  },
                  "tier2_limit": {
                    "type": "number",
                    "minimum": 1,
                    "maximum": 20,
                    "default": 5,
                    "description": "Items to fetch per collection"
                  },
                  "include_same_collection": {
                    "type": "boolean",
                    "default": true,
                    "description": "Include results from the same collection"
                  },
                  "refresh": {
                    "type": "boolean",
                    "default": false,
                    "description": "Force fresh query, bypassing cache"
                  },
                  "expand": {
                    "type": "string",
                    "enum": [
                      "preview",
                      "full",
                      "none"
                    ],
                    "description": "Entity expansion mode. Default: \"preview\" for lightweight previews, \"full\" for complete manifests, \"none\" for no expansion.",
                    "example": "preview"
                  }
                },
                "required": [
                  "id",
                  "collection_id"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Similar items found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "type": {
                            "type": "string"
                          },
                          "label": {
                            "type": "string"
                          },
                          "collection_id": {
                            "type": "string",
                            "nullable": true
                          },
                          "score": {
                            "type": "number"
                          },
                          "created_at": {
                            "type": "string"
                          },
                          "updated_at": {
                            "type": "string"
                          },
                          "entity_preview": {
                            "allOf": [
                              {
                                "$ref": "#/components/schemas/EntityPreview"
                              },
                              {
                                "description": "Lightweight entity preview (included by default)",
                                "example": {
                                  "id": "01KENTITY123456789ABCDEFGH",
                                  "type": "document",
                                  "label": "Similar Research Paper",
                                  "collection_id": "01JCOLLECTION123456789AB",
                                  "description_preview": "Related findings on distributed systems...",
                                  "created_at": "2026-01-08T00:00:00.000Z",
                                  "updated_at": "2026-01-12T10:00:00.000Z"
                                }
                              }
                            ]
                          },
                          "entity": {
                            "allOf": [
                              {
                                "$ref": "#/components/schemas/EntityResponse"
                              },
                              {
                                "description": "Full entity manifest (when expand: \"full\")"
                              }
                            ]
                          }
                        },
                        "required": [
                          "id",
                          "type",
                          "label",
                          "collection_id",
                          "score"
                        ]
                      }
                    },
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "source_id": {
                          "type": "string"
                        },
                        "collections_searched": {
                          "type": "number"
                        },
                        "result_count": {
                          "type": "number"
                        },
                        "cached": {
                          "type": "boolean"
                        },
                        "cached_at": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "source_id",
                        "collections_searched",
                        "result_count"
                      ]
                    }
                  },
                  "required": [
                    "results",
                    "metadata"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          },
          "503": {
            "description": "Service Unavailable - External service not available",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Service unavailable",
                  "details": {
                    "service": "pinecone"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/search/collections": {
      "post": {
        "tags": [
          "Search"
        ],
        "summary": "Search collections by text",
        "description": "Search for collections using semantic text search.\n\nUse this endpoint to discover collections about a topic. Results are ranked by semantic similarity to your query.\n\n**Entity Expansion:**\n\nUse `expand` in the request body to fetch entity data inline with search results:\n\n- **`expand: \"preview\"` (default)**: Adds `entity_preview` with fresh lightweight data (id, type, label, timestamps)\n- **`expand: \"full\"`**: Adds `entity` with complete manifest including all properties and relationships\n- **`expand: \"none\"`**: Returns search metadata only (fastest, lowest bandwidth)\n\nPreview mode is recommended for most use cases. Full expansion can result in large payloads.\nGracefully handles deleted or inaccessible entities (returns results without expansion data).\n\n---\n**Permission:** `search:query`  \n**Auth:** required",
        "x-arke-action": "search:query",
        "x-arke-auth": "required",
        "x-arke-tier": "external",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "query": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 10000,
                    "description": "Search query text"
                  },
                  "limit": {
                    "type": "number",
                    "minimum": 1,
                    "maximum": 100,
                    "default": 10,
                    "description": "Maximum results to return"
                  },
                  "types": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "description": "Filter by collection types"
                  },
                  "filter": {
                    "type": "object",
                    "additionalProperties": {
                      "nullable": true
                    },
                    "description": "Filter by indexed metadata properties.\n\n**Filterable Properties:**\nOnly underscore-prefixed properties (`_year`, `_class`, etc.) are indexed as filterable metadata.\n\n**Operators:**\n| Operator | Description | Example |\n|----------|-------------|---------|\n| `$eq` | Equals | `{ \"_year\": { \"$eq\": 1905 } }` |\n| `$ne` | Not equals | `{ \"_class\": { \"$ne\": \"draft\" } }` |\n| `$gt` | Greater than | `{ \"_year\": { \"$gt\": 1900 } }` |\n| `$gte` | Greater than or equal | `{ \"_year\": { \"$gte\": 1900 } }` |\n| `$lt` | Less than | `{ \"_year\": { \"$lt\": 2000 } }` |\n| `$lte` | Less than or equal | `{ \"_year\": { \"$lte\": 2000 } }` |\n| `$in` | In array | `{ \"_class\": { \"$in\": [\"letter\", \"memo\"] } }` |\n| `$nin` | Not in array | `{ \"_class\": { \"$nin\": [\"draft\"] } }` |\n| `$exists` | Property exists | `{ \"_ocr_text\": { \"$exists\": true } }` |\n\n**Logical Operators:**\n| Operator | Description | Example |\n|----------|-------------|---------|\n| `$and` | All conditions must match | `{ \"$and\": [{ \"_year\": { \"$gt\": 1900 } }, { \"_year\": { \"$lt\": 2000 } }] }` |\n| `$or` | Any condition must match | `{ \"$or\": [{ \"_class\": \"letter\" }, { \"_class\": \"memo\" }] }` |\n\n**Built-in Fields (always available):**\n- `type` - Entity type\n- `created_at` - ISO timestamp string\n- `updated_at` - ISO timestamp string\n\n**Example - Find letters from 1800-1900:**\n```json\n{\n  \"$and\": [\n    { \"type\": { \"$eq\": \"letter\" } },\n    { \"_year\": { \"$gte\": 1800 } },\n    { \"_year\": { \"$lte\": 1900 } }\n  ]\n}\n```",
                    "example": {
                      "_year": {
                        "$gt": 1800
                      },
                      "type": "letter"
                    }
                  },
                  "expand": {
                    "type": "string",
                    "enum": [
                      "preview",
                      "full",
                      "none"
                    ],
                    "description": "Entity expansion mode. Default: \"preview\" for lightweight previews, \"full\" for complete manifests, \"none\" for no expansion.",
                    "example": "preview"
                  }
                },
                "required": [
                  "query"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Search results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "label": {
                            "type": "string"
                          },
                          "type": {
                            "type": "string"
                          },
                          "score": {
                            "type": "number"
                          },
                          "created_at": {
                            "type": "string"
                          },
                          "updated_at": {
                            "type": "string"
                          },
                          "entity_preview": {
                            "allOf": [
                              {
                                "$ref": "#/components/schemas/EntityPreview"
                              },
                              {
                                "description": "Lightweight entity preview (included by default)",
                                "example": {
                                  "id": "01KCOLLECTION123456789ABCD",
                                  "type": "collection",
                                  "label": "Machine Learning Papers",
                                  "description_preview": "A collection of papers on neural networks and deep learning...",
                                  "created_at": "2026-01-05T00:00:00.000Z",
                                  "updated_at": "2026-01-10T08:00:00.000Z"
                                }
                              }
                            ]
                          },
                          "entity": {
                            "allOf": [
                              {
                                "$ref": "#/components/schemas/EntityResponse"
                              },
                              {
                                "description": "Full entity manifest (when expand: \"full\")"
                              }
                            ]
                          }
                        },
                        "required": [
                          "id",
                          "label",
                          "type",
                          "score"
                        ]
                      }
                    },
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "query": {
                          "type": "string"
                        },
                        "result_count": {
                          "type": "number"
                        }
                      },
                      "required": [
                        "query",
                        "result_count"
                      ]
                    }
                  },
                  "required": [
                    "results",
                    "metadata"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "503": {
            "description": "Service Unavailable - External service not available",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Service unavailable",
                  "details": {
                    "service": "pinecone"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/search/agents": {
      "post": {
        "tags": [
          "Search"
        ],
        "summary": "Search agents by text",
        "description": "Search for agents using semantic text search.\n\n**Official Agents (Default):** By default, this endpoint searches only the official Arke agents collection (`01KFF0H1KSR4SHHDQ7T2HXQEK6`). These agents are pre-approved, actively maintained, and tested for security and reliability.\n\n**All Agents:** Set `scope: \"all\"` to search network-wide. This is not recommended as results may include duplicates, outdated agents, or unapproved implementations.\n\nResults are ranked by semantic similarity to your query based on agent descriptions and capabilities.\n\n**Entity Expansion:**\n\nBy default, agent search returns **full entity manifests** (including `endpoint`, `input_schema`, `actions_required`, etc.) to make discovery results immediately useful.\n\n- **`expand: \"full\"` (default)**: Complete agent manifests with all properties\n- **`expand: \"preview\"`**: Lightweight previews (id, type, label, description_preview, timestamps)\n- **`expand: \"none\"`**: Search metadata only (fastest)\n\n---\n**Permission:** `search:query`  \n**Auth:** required",
        "x-arke-action": "search:query",
        "x-arke-auth": "required",
        "x-arke-tier": "external",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "query": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 10000,
                    "description": "Search query text"
                  },
                  "limit": {
                    "type": "number",
                    "minimum": 1,
                    "maximum": 100,
                    "default": 10,
                    "description": "Maximum results to return"
                  },
                  "filter": {
                    "type": "object",
                    "additionalProperties": {
                      "nullable": true
                    },
                    "description": "Filter by indexed metadata properties.\n\n**Filterable Properties:**\nOnly underscore-prefixed properties (`_year`, `_class`, etc.) are indexed as filterable metadata.\n\n**Operators:**\n| Operator | Description | Example |\n|----------|-------------|---------|\n| `$eq` | Equals | `{ \"_year\": { \"$eq\": 1905 } }` |\n| `$ne` | Not equals | `{ \"_class\": { \"$ne\": \"draft\" } }` |\n| `$gt` | Greater than | `{ \"_year\": { \"$gt\": 1900 } }` |\n| `$gte` | Greater than or equal | `{ \"_year\": { \"$gte\": 1900 } }` |\n| `$lt` | Less than | `{ \"_year\": { \"$lt\": 2000 } }` |\n| `$lte` | Less than or equal | `{ \"_year\": { \"$lte\": 2000 } }` |\n| `$in` | In array | `{ \"_class\": { \"$in\": [\"letter\", \"memo\"] } }` |\n| `$nin` | Not in array | `{ \"_class\": { \"$nin\": [\"draft\"] } }` |\n| `$exists` | Property exists | `{ \"_ocr_text\": { \"$exists\": true } }` |\n\n**Logical Operators:**\n| Operator | Description | Example |\n|----------|-------------|---------|\n| `$and` | All conditions must match | `{ \"$and\": [{ \"_year\": { \"$gt\": 1900 } }, { \"_year\": { \"$lt\": 2000 } }] }` |\n| `$or` | Any condition must match | `{ \"$or\": [{ \"_class\": \"letter\" }, { \"_class\": \"memo\" }] }` |\n\n**Built-in Fields (always available):**\n- `type` - Entity type\n- `created_at` - ISO timestamp string\n- `updated_at` - ISO timestamp string\n\n**Example - Find letters from 1800-1900:**\n```json\n{\n  \"$and\": [\n    { \"type\": { \"$eq\": \"letter\" } },\n    { \"_year\": { \"$gte\": 1800 } },\n    { \"_year\": { \"$lte\": 1900 } }\n  ]\n}\n```",
                    "example": {
                      "_year": {
                        "$gt": 1800
                      },
                      "type": "letter"
                    }
                  },
                  "expand": {
                    "type": "string",
                    "enum": [
                      "preview",
                      "full",
                      "none"
                    ],
                    "description": "Entity expansion mode. Default: \"preview\" for lightweight previews, \"full\" for complete manifests, \"none\" for no expansion.",
                    "example": "preview"
                  },
                  "scope": {
                    "type": "string",
                    "enum": [
                      "official",
                      "all"
                    ],
                    "default": "official",
                    "description": "Search scope. \"official\" (default) searches only the pre-approved Arke agents collection. \"all\" searches all agents network-wide (not recommended - may include duplicates, outdated, or unapproved agents)."
                  }
                },
                "required": [
                  "query"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Search results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "label": {
                            "type": "string"
                          },
                          "score": {
                            "type": "number"
                          },
                          "collection_id": {
                            "type": "string",
                            "nullable": true
                          },
                          "status": {
                            "type": "string"
                          },
                          "created_at": {
                            "type": "string"
                          },
                          "updated_at": {
                            "type": "string"
                          },
                          "entity_preview": {
                            "allOf": [
                              {
                                "$ref": "#/components/schemas/EntityPreview"
                              },
                              {
                                "description": "Lightweight entity preview (included by default)",
                                "example": {
                                  "id": "01KAGENT123456789ABCDEFGHI",
                                  "type": "agent",
                                  "label": "Document Analyzer Agent",
                                  "collection_id": "01JCOLLECTION123456789AB",
                                  "description_preview": "An AI agent that analyzes documents and extracts key insights...",
                                  "created_at": "2026-01-01T00:00:00.000Z",
                                  "updated_at": "2026-01-15T16:00:00.000Z"
                                }
                              }
                            ]
                          },
                          "entity": {
                            "allOf": [
                              {
                                "$ref": "#/components/schemas/EntityResponse"
                              },
                              {
                                "description": "Full entity manifest (when expand: \"full\")"
                              }
                            ]
                          }
                        },
                        "required": [
                          "id",
                          "label",
                          "score",
                          "collection_id"
                        ]
                      }
                    },
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "query": {
                          "type": "string"
                        },
                        "result_count": {
                          "type": "number"
                        }
                      },
                      "required": [
                        "query",
                        "result_count"
                      ]
                    }
                  },
                  "required": [
                    "results",
                    "metadata"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "503": {
            "description": "Service Unavailable - External service not available",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Service unavailable",
                  "details": {
                    "service": "pinecone"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/search/entities": {
      "post": {
        "tags": [
          "Search"
        ],
        "summary": "Search entities within collection(s)",
        "description": "Search for entities within one or more collections using semantic text search.\n\nProvide either `collection_pi` for a single collection or `collection_ids` for multiple collections (searched in parallel).\n\nUse `per_collection_limit` to ensure result diversity when searching multiple collections.\n\n**Entity Expansion:**\n\nUse `expand` in the request body to fetch entity data inline with search results:\n\n- **`expand: \"preview\"` (default)**: Adds `entity_preview` with fresh lightweight data (id, type, label, timestamps)\n- **`expand: \"full\"`**: Adds `entity` with complete manifest including all properties and relationships\n- **`expand: \"none\"`**: Returns search metadata only (fastest, lowest bandwidth)\n\nPreview mode is recommended for most use cases. Full expansion can result in large payloads.\nGracefully handles deleted or inaccessible entities (returns results without expansion data).\n\n---\n**Permission:** `search:query`  \n**Auth:** required",
        "x-arke-action": "search:query",
        "x-arke-auth": "required",
        "x-arke-tier": "external",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "collection_id": {
                    "type": "string",
                    "description": "Single collection ID to search within"
                  },
                  "collection_ids": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "maxItems": 20,
                    "description": "Multiple collection IDs to search (max 20)"
                  },
                  "query": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 10000,
                    "description": "Search query text"
                  },
                  "limit": {
                    "type": "number",
                    "minimum": 1,
                    "maximum": 100,
                    "default": 20,
                    "description": "Maximum total results to return"
                  },
                  "types": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "description": "Filter by entity types"
                  },
                  "filter": {
                    "type": "object",
                    "additionalProperties": {
                      "nullable": true
                    },
                    "description": "Filter by indexed metadata properties.\n\n**Filterable Properties:**\nOnly underscore-prefixed properties (`_year`, `_class`, etc.) are indexed as filterable metadata.\n\n**Operators:**\n| Operator | Description | Example |\n|----------|-------------|---------|\n| `$eq` | Equals | `{ \"_year\": { \"$eq\": 1905 } }` |\n| `$ne` | Not equals | `{ \"_class\": { \"$ne\": \"draft\" } }` |\n| `$gt` | Greater than | `{ \"_year\": { \"$gt\": 1900 } }` |\n| `$gte` | Greater than or equal | `{ \"_year\": { \"$gte\": 1900 } }` |\n| `$lt` | Less than | `{ \"_year\": { \"$lt\": 2000 } }` |\n| `$lte` | Less than or equal | `{ \"_year\": { \"$lte\": 2000 } }` |\n| `$in` | In array | `{ \"_class\": { \"$in\": [\"letter\", \"memo\"] } }` |\n| `$nin` | Not in array | `{ \"_class\": { \"$nin\": [\"draft\"] } }` |\n| `$exists` | Property exists | `{ \"_ocr_text\": { \"$exists\": true } }` |\n\n**Logical Operators:**\n| Operator | Description | Example |\n|----------|-------------|---------|\n| `$and` | All conditions must match | `{ \"$and\": [{ \"_year\": { \"$gt\": 1900 } }, { \"_year\": { \"$lt\": 2000 } }] }` |\n| `$or` | Any condition must match | `{ \"$or\": [{ \"_class\": \"letter\" }, { \"_class\": \"memo\" }] }` |\n\n**Built-in Fields (always available):**\n- `type` - Entity type\n- `created_at` - ISO timestamp string\n- `updated_at` - ISO timestamp string\n\n**Example - Find letters from 1800-1900:**\n```json\n{\n  \"$and\": [\n    { \"type\": { \"$eq\": \"letter\" } },\n    { \"_year\": { \"$gte\": 1800 } },\n    { \"_year\": { \"$lte\": 1900 } }\n  ]\n}\n```",
                    "example": {
                      "_year": {
                        "$gt": 1800
                      },
                      "type": "letter"
                    }
                  },
                  "per_collection_limit": {
                    "type": "number",
                    "minimum": 1,
                    "maximum": 50,
                    "description": "Max results per collection for diversity"
                  },
                  "expand": {
                    "type": "string",
                    "enum": [
                      "preview",
                      "full",
                      "none"
                    ],
                    "description": "Entity expansion mode. Default: \"preview\" for lightweight previews, \"full\" for complete manifests, \"none\" for no expansion.",
                    "example": "preview"
                  }
                },
                "required": [
                  "query"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Search results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "label": {
                            "type": "string"
                          },
                          "type": {
                            "type": "string"
                          },
                          "score": {
                            "type": "number"
                          },
                          "collection_id": {
                            "type": "string"
                          },
                          "created_at": {
                            "type": "string"
                          },
                          "updated_at": {
                            "type": "string"
                          },
                          "entity_preview": {
                            "allOf": [
                              {
                                "$ref": "#/components/schemas/EntityPreview"
                              },
                              {
                                "description": "Lightweight entity preview (included by default)",
                                "example": {
                                  "id": "01KENTITY123456789ABCDEFGH",
                                  "type": "document",
                                  "label": "Research Findings Report",
                                  "collection_id": "01JCOLLECTION123456789AB",
                                  "description_preview": "Detailed analysis of experimental results...",
                                  "created_at": "2026-01-10T00:00:00.000Z",
                                  "updated_at": "2026-01-14T09:00:00.000Z"
                                }
                              }
                            ]
                          },
                          "entity": {
                            "allOf": [
                              {
                                "$ref": "#/components/schemas/EntityResponse"
                              },
                              {
                                "description": "Full entity manifest (when expand: \"full\")"
                              }
                            ]
                          }
                        },
                        "required": [
                          "id",
                          "label",
                          "type",
                          "score",
                          "collection_id"
                        ]
                      }
                    },
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "collection_ids": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "query": {
                          "type": "string"
                        },
                        "collections_searched": {
                          "type": "number"
                        },
                        "result_count": {
                          "type": "number"
                        }
                      },
                      "required": [
                        "collection_ids",
                        "query",
                        "collections_searched",
                        "result_count"
                      ]
                    }
                  },
                  "required": [
                    "results",
                    "metadata"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "503": {
            "description": "Service Unavailable - External service not available",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Service unavailable",
                  "details": {
                    "service": "pinecone"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/search/discover": {
      "post": {
        "tags": [
          "Search"
        ],
        "summary": "Discover entities across all collections",
        "description": "Two-step discovery search: first finds relevant collections, then searches within them.\n\nUse this endpoint when you don't know which collections to search. The system will:\n1. Find collections semantically related to your query\n2. Search within each collection in parallel\n3. Aggregate and rank results across all collections\n\nGreat for exploration and AI agents navigating the network.\n\n**Entity Expansion:**\n\nUse `expand` in the request body to fetch entity data inline with search results:\n\n- **`expand: \"preview\"` (default)**: Adds `entity_preview` with fresh lightweight data (id, type, label, timestamps)\n- **`expand: \"full\"`**: Adds `entity` with complete manifest including all properties and relationships\n- **`expand: \"none\"`**: Returns search metadata only (fastest, lowest bandwidth)\n\nPreview mode is recommended for most use cases. Full expansion can result in large payloads.\nGracefully handles deleted or inaccessible entities (returns results without expansion data).\n\n---\n**Permission:** `search:query`  \n**Auth:** required",
        "x-arke-action": "search:query",
        "x-arke-auth": "required",
        "x-arke-tier": "external",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "query": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 10000,
                    "description": "Search query text"
                  },
                  "limit": {
                    "type": "number",
                    "minimum": 1,
                    "maximum": 100,
                    "default": 20,
                    "description": "Maximum total results to return"
                  },
                  "types": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "description": "Filter by entity types"
                  },
                  "filter": {
                    "type": "object",
                    "additionalProperties": {
                      "nullable": true
                    },
                    "description": "Filter by indexed metadata properties.\n\n**Filterable Properties:**\nOnly underscore-prefixed properties (`_year`, `_class`, etc.) are indexed as filterable metadata.\n\n**Operators:**\n| Operator | Description | Example |\n|----------|-------------|---------|\n| `$eq` | Equals | `{ \"_year\": { \"$eq\": 1905 } }` |\n| `$ne` | Not equals | `{ \"_class\": { \"$ne\": \"draft\" } }` |\n| `$gt` | Greater than | `{ \"_year\": { \"$gt\": 1900 } }` |\n| `$gte` | Greater than or equal | `{ \"_year\": { \"$gte\": 1900 } }` |\n| `$lt` | Less than | `{ \"_year\": { \"$lt\": 2000 } }` |\n| `$lte` | Less than or equal | `{ \"_year\": { \"$lte\": 2000 } }` |\n| `$in` | In array | `{ \"_class\": { \"$in\": [\"letter\", \"memo\"] } }` |\n| `$nin` | Not in array | `{ \"_class\": { \"$nin\": [\"draft\"] } }` |\n| `$exists` | Property exists | `{ \"_ocr_text\": { \"$exists\": true } }` |\n\n**Logical Operators:**\n| Operator | Description | Example |\n|----------|-------------|---------|\n| `$and` | All conditions must match | `{ \"$and\": [{ \"_year\": { \"$gt\": 1900 } }, { \"_year\": { \"$lt\": 2000 } }] }` |\n| `$or` | Any condition must match | `{ \"$or\": [{ \"_class\": \"letter\" }, { \"_class\": \"memo\" }] }` |\n\n**Built-in Fields (always available):**\n- `type` - Entity type\n- `created_at` - ISO timestamp string\n- `updated_at` - ISO timestamp string\n\n**Example - Find letters from 1800-1900:**\n```json\n{\n  \"$and\": [\n    { \"type\": { \"$eq\": \"letter\" } },\n    { \"_year\": { \"$gte\": 1800 } },\n    { \"_year\": { \"$lte\": 1900 } }\n  ]\n}\n```",
                    "example": {
                      "_year": {
                        "$gt": 1800
                      },
                      "type": "letter"
                    }
                  },
                  "collection_limit": {
                    "type": "number",
                    "minimum": 1,
                    "maximum": 50,
                    "default": 10,
                    "description": "Number of collections to search"
                  },
                  "per_collection_limit": {
                    "type": "number",
                    "minimum": 1,
                    "maximum": 20,
                    "default": 5,
                    "description": "Max results per collection"
                  },
                  "expand": {
                    "type": "string",
                    "enum": [
                      "preview",
                      "full",
                      "none"
                    ],
                    "description": "Entity expansion mode. Default: \"preview\" for lightweight previews, \"full\" for complete manifests, \"none\" for no expansion.",
                    "example": "preview"
                  }
                },
                "required": [
                  "query"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Discovery results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "label": {
                            "type": "string"
                          },
                          "type": {
                            "type": "string"
                          },
                          "score": {
                            "type": "number"
                          },
                          "collection_id": {
                            "type": "string"
                          },
                          "created_at": {
                            "type": "string"
                          },
                          "updated_at": {
                            "type": "string"
                          },
                          "entity_preview": {
                            "allOf": [
                              {
                                "$ref": "#/components/schemas/EntityPreview"
                              },
                              {
                                "description": "Lightweight entity preview (included by default)",
                                "example": {
                                  "id": "01KENTITY123456789ABCDEFGH",
                                  "type": "file",
                                  "label": "Discovered Document.pdf",
                                  "collection_id": "01JCOLLECTION123456789AB",
                                  "description_preview": "A document discovered through semantic search...",
                                  "created_at": "2026-01-08T00:00:00.000Z",
                                  "updated_at": "2026-01-12T14:00:00.000Z"
                                }
                              }
                            ]
                          },
                          "entity": {
                            "allOf": [
                              {
                                "$ref": "#/components/schemas/EntityResponse"
                              },
                              {
                                "description": "Full entity manifest (when expand: \"full\")"
                              }
                            ]
                          }
                        },
                        "required": [
                          "id",
                          "label",
                          "type",
                          "score",
                          "collection_id"
                        ]
                      }
                    },
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "query": {
                          "type": "string"
                        },
                        "collections_searched": {
                          "type": "number"
                        },
                        "result_count": {
                          "type": "number"
                        }
                      },
                      "required": [
                        "query",
                        "collections_searched",
                        "result_count"
                      ]
                    }
                  },
                  "required": [
                    "results",
                    "metadata"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid input",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationErrorResponse"
                },
                "example": {
                  "error": "Validation failed",
                  "details": {
                    "issues": [
                      {
                        "path": [
                          "properties",
                          "label"
                        ],
                        "message": "Required"
                      }
                    ]
                  }
                }
              }
            }
          },
          "503": {
            "description": "Service Unavailable - External service not available",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Service unavailable",
                  "details": {
                    "service": "pinecone"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/chat": {
      "post": {
        "tags": [
          "Chat"
        ],
        "summary": "Send chat message",
        "description": "Send a message to the Arke chat agent and receive a streaming response.\n\nThe agent can execute Arke API operations on your behalf using the authenticated user's permissions.\n\n## Headers\n\n- `X-Chat-ID`: Optional. Specify to continue an existing chat session. If omitted, a new session is created.\n\n## Response Format\n\nThe response is a Server-Sent Events (SSE) stream in AI SDK v5 UIMessage format.\nStream chunks include text deltas, tool calls, and usage information.\n\n## Token Usage Tracking\n\nUsage information is included at the end of the stream in the format:\n```json\n{\"type\":\"message_delta\",\"delta\":{\"usage\":{\"input_tokens\":123,\"output_tokens\":456}}}\n```\n\n## Storage Limits\n\n- **Single message**: 2 MB max (returns 413 with code `MESSAGE_TOO_LARGE`)\n- **Chat database**: 10 GB max (returns 507 with code `CHAT_STORAGE_FULL`)\n- **LLM context**: ~128K tokens (returns stream error)\n\n\n---\n**Permission:** `chat:send`  \n**Auth:** required",
        "x-arke-action": "chat:send",
        "x-arke-auth": "required",
        "x-arke-tier": "external",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SendChatRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Streaming SSE response",
            "content": {
              "text/event-stream": {
                "schema": {
                  "type": "string",
                  "description": "Server-Sent Events stream in AI SDK v5 format"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "413": {
            "description": "Message exceeds 2MB storage limit",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MessageTooLargeError"
                }
              }
            }
          },
          "507": {
            "description": "Chat storage full (10GB limit)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ChatStorageFullError"
                }
              }
            }
          }
        }
      }
    },
    "/chat/sessions": {
      "get": {
        "tags": [
          "Chat"
        ],
        "summary": "List user chats",
        "description": "Returns a paginated list of the authenticated user's chats, sorted newest-first.\n\nOnly returns chats owned by the authenticated user. Anonymous chats are not indexed.\n\nQuery parameters:\n- `limit`: Max chats to return (1-100, default 20)\n- `offset`: Number of chats to skip for pagination (default 0)\n\n---\n**Permission:** `chat:view`  \n**Auth:** required",
        "x-arke-action": "chat:view",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "List of user chats",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ListChatsResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          }
        }
      }
    },
    "/chat/sessions/{id}": {
      "get": {
        "tags": [
          "Chat"
        ],
        "summary": "Get chat session",
        "description": "Get information about a chat session including message history.\n\nOnly the session owner can view their chat sessions.\n\n---\n**Permission:** `chat:view`  \n**Auth:** required",
        "x-arke-action": "chat:view",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Chat session info",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ChatSession"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": [
          "Chat"
        ],
        "summary": "Delete chat session",
        "description": "Delete a chat session. Only the session owner can delete it.\n\n---\n**Permission:** `chat:delete`  \n**Auth:** required",
        "x-arke-action": "chat:delete",
        "x-arke-auth": "required",
        "x-arke-tier": "standard",
        "security": [
          {
            "bearerAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Session deleted",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ChatSessionDeleteResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Missing or invalid authentication",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized: Missing or invalid authentication token"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/entities/{id}/attestation": {
      "get": {
        "tags": [
          "Attestations"
        ],
        "summary": "Get latest attestation",
        "description": "Returns the Arweave attestation for the current (latest) version of an entity.\n\nReturns 202 Accepted if the attestation upload is still pending.\n\n---\n**Permission:** `entity:view`  \n**Auth:** optional",
        "x-arke-action": "entity:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Attestation found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AttestationResponse"
                }
              }
            }
          },
          "202": {
            "description": "Attestation pending",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AttestationPendingResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/versions/{id}/{ver}/attestation": {
      "get": {
        "tags": [
          "Attestations"
        ],
        "summary": "Get version attestation",
        "description": "Returns the Arweave attestation for a specific version of an entity.\n\n---\n**Permission:** `entity:view`  \n**Auth:** optional",
        "x-arke-action": "entity:view",
        "x-arke-auth": "optional",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "pattern": "^(?:II[0-9A-HJKMNP-TV-Z]{24}|[FC][0-9A-HJKMNP-TV-Z]{25}|[0-9A-HJKMNP-TV-Z]{26})$",
              "description": "Entity ID (ULID format)",
              "example": "01KDETYWYWM0MJVKM8DK3AEXPY"
            },
            "required": true,
            "description": "Entity ID (ULID)",
            "name": "id",
            "in": "path"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "example": 1
            },
            "required": true,
            "description": "Version number",
            "name": "ver",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Attestation found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AttestationResponse"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Insufficient permissions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Forbidden: You do not have permission to perform this action"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/attestations/head": {
      "get": {
        "tags": [
          "Attestations"
        ],
        "summary": "Get chain head",
        "description": "Returns the latest Arweave attestation transaction ID (network head).\n\n---\n**Permission:** `attestation:view`  \n**Auth:** none",
        "x-arke-action": "attestation:view",
        "x-arke-auth": "none",
        "x-arke-tier": "standard",
        "responses": {
          "200": {
            "description": "Chain head",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ChainHeadResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    },
    "/attestations/verify/{tx}": {
      "get": {
        "tags": [
          "Attestations"
        ],
        "summary": "Verify attestation",
        "description": "Fetches an attestation from Arweave and verifies the CID matches the manifest content.\n\nThis is a public endpoint - anyone can verify attestations.\n\n---\n**Permission:** `attestation:verify`  \n**Auth:** none",
        "x-arke-action": "attestation:verify",
        "x-arke-auth": "none",
        "x-arke-tier": "standard",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "minLength": 1,
              "example": "abc123xyz..."
            },
            "required": true,
            "description": "Arweave transaction ID",
            "name": "tx",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Verification result",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/VerifyAttestationResponse"
                }
              }
            }
          },
          "404": {
            "description": "Not Found - Resource does not exist",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Entity not found"
                }
              }
            }
          }
        }
      }
    }
  }
}